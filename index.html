<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œìš¸ ê²½ë§ˆ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
    
    <!-- Tailwind CSS (ìŠ¤íƒ€ì¼ë§) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel (JSX ë³€í™˜ìš©) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- í°íŠ¸ ì„¤ì • (ì„ íƒì‚¬í•­) -->
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <!-- React ì½”ë“œ ì‹œì‘ -->
    <!-- data-type="module"ì„ ì‚¬ìš©í•˜ì—¬ import êµ¬ë¬¸ì„ ì§€ì›í•˜ê²Œ í•¨ -->
    <script type="text/babel" data-type="module">
        // 1. CDNì„ í†µí•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ Import
        import React, { useState, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Trophy, AlertTriangle, Timer, Activity, Info, Scale, History, 
            ChevronDown, ChevronUp, Search, Calendar, User, X, Zap, 
            Gauge, Upload, FileJson, RefreshCw 
        } from 'https://esm.sh/lucide-react@0.263.1';

        // ==========================================
        // 1. Helper Components (UI Elements)
        // ==========================================

        const RankBadge = ({ rank }) => {
            if (!rank) return <span className="text-gray-300">-</span>;
            const rankNum = parseInt(rank);
            if (isNaN(rankNum)) return <span className="text-gray-300">-</span>;
            let bgClass = "bg-gray-100 text-gray-600";
            if (rankNum === 1) bgClass = "bg-yellow-100 text-yellow-700 border border-yellow-300 font-bold";
            else if (rankNum === 2) bgClass = "bg-gray-200 text-gray-700 border border-gray-400 font-bold";
            else if (rankNum === 3) bgClass = "bg-orange-100 text-orange-700 border border-orange-300 font-bold";
            else if (rankNum <= 5) bgClass = "bg-blue-50 text-blue-600 border border-blue-200";
            return <span className={`inline-flex items-center justify-center w-6 h-6 rounded-full text-xs ${bgClass}`}>{rankNum}</span>;
        };

        const DiffValue = ({ current, prev, unit = '' }) => {
            if (prev === undefined || prev === null) return null;
            const diff = current - prev;
            if (diff === 0) return <span className="text-gray-400 text-xs ml-1">(-)</span>;
            const colorClass = diff > 0 ? "text-red-500" : "text-blue-500";
            const icon = diff > 0 ? "â–²" : "â–¼";
            return <span className={`${colorClass} text-xs ml-1 font-medium whitespace-nowrap`}>{icon}{Math.abs(diff).toFixed(1).replace(/\.0$/, '')}{unit}</span>;
        };

        const BodyWeightValue = ({ weight, change }) => {
            if (!weight) return <span className="text-gray-300">-</span>;
            const isSignificant = Math.abs(change) >= 10;
            const changeColor = change > 0 ? "text-red-500" : change < 0 ? "text-blue-500" : "text-gray-400";
            const icon = change > 0 ? "â–²" : change < 0 ? "â–¼" : "-";
            return (
                <div className="flex flex-col items-center">
                <div className={`font-bold ${isSignificant ? 'text-red-700 bg-red-50 px-1 rounded' : 'text-slate-700'}`}>
                    {weight}kg
                </div>
                <div className={`text-xs ${changeColor} ${isSignificant ? 'font-bold animate-pulse' : ''}`}>
                    {change !== 0 ? `${icon}${Math.abs(change)}` : '(-)'}
                </div>
                </div>
            );
        };

        const TrainingBar = ({ count, jockeyCount }) => {
            const max = 15;
            const percentage = Math.min((count / max) * 100, 100);
            let color = "bg-blue-500";
            if (count < 8) color = "bg-red-400";
            else if (count >= 13) color = "bg-green-500";
            return (
                <div className="w-full flex flex-col gap-1">
                <div className="flex justify-between text-xs text-gray-500">
                    <span className="font-medium text-slate-700">ì´ {count}íšŒ</span>
                    {jockeyCount > 0 && (
                    <span className="text-blue-600 font-bold flex items-center gap-0.5">
                        <User className="w-3 h-3" /> ê¸°ìˆ˜ {jockeyCount}íšŒ
                    </span>
                    )}
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2">
                    <div className={`h-2 rounded-full ${color}`} style={{ width: `${percentage}%` }}></div>
                </div>
                </div>
            );
        };

        const ChangeBadge = ({ type }) => {
            if (!type) return null;
            let label = "";
            let styleClass = "";
            switch(type) {
                case 'promotion': label = "â–² ìŠ¹ê¸‰ ì²«ê²½ì£¼"; styleClass = "bg-red-50 text-red-600 border-red-200"; break;
                case 'demotion': label = "â–¼ ê°•ê¸‰ ì²«ê²½ì£¼"; styleClass = "bg-blue-50 text-blue-600 border-blue-200"; break;
                case 'jumping': label = "â˜… ì í•‘ ì¶œì „"; styleClass = "bg-purple-50 text-purple-600 border-purple-200"; break;
                default: return null;
            }
            return <span className={`ml-2 text-[10px] px-1.5 py-0.5 rounded border font-bold flex items-center gap-0.5 ${styleClass}`}>{label}</span>;
        };

        const RunningStyleBadge = ({ style }) => {
            if (!style) return <span className="text-gray-300 text-xs">-</span>;
            let bgClass = "bg-gray-100 text-gray-600 border-gray-200";
            let label = style;
            if (style === 'ì„ í–‰') { bgClass = "bg-red-50 text-red-700 border-red-200"; label = "ğŸš€ ì„ í–‰"; }
            else if (style === 'ì„ ì…') { bgClass = "bg-orange-50 text-orange-700 border-orange-200"; label = "âš¡ ì„ ì…"; }
            else if (style === 'ì¶”ì…' || style === 'ììœ ') { bgClass = "bg-green-50 text-green-700 border-green-200"; label = "ğŸ”„ ì¶”ì…/ììœ "; }
            return <span className={`px-2 py-1 rounded text-xs font-bold border flex items-center gap-1 w-fit mx-auto ${bgClass}`}>{label}</span>;
        };

        const SpeedIndexBadge = ({ index }) => {
            if (!index || index === '-') return <span className="text-gray-300">-</span>;
            const score = parseFloat(index);
            let color = "text-gray-600 bg-gray-100";
            if (score >= 105) color = "text-red-700 bg-red-100 font-bold border-red-200";
            else if (score >= 100) color = "text-blue-700 bg-blue-100 font-bold border-blue-200";
            else if (score < 95) color = "text-gray-500 bg-gray-50";
            return (
                <div className={`flex flex-col items-center justify-center p-1 rounded border ${color}`}>
                <div className="flex items-center gap-1">
                    <Gauge className="w-3 h-3" />
                    <span className="text-sm">{index}</span>
                </div>
                </div>
            );
        };

        const WinRateBadge = ({ rate }) => {
            if (!rate) return null;
            const val = parseFloat(rate.replace('%', ''));
            const isHigh = val >= 15;
            const isLow = val <= 5;
            let colorClass = "text-slate-500 bg-slate-100";
            if (isHigh) colorClass = "text-red-700 bg-red-50 border-red-100";
            else if (isLow) colorClass = "text-gray-400 bg-gray-50";
            return <span className={`text-[10px] px-1.5 py-0.5 rounded border ml-1 whitespace-nowrap ${colorClass}`}>11ì›”: {rate}</span>;
        };

        // ==========================================
        // 2. File Upload Screen Component
        // ==========================================

        const FileUploadScreen = ({ onFileLoaded }) => {
            const [isDragging, setIsDragging] = useState(false);
            const [error, setError] = useState(null);
            const fileInputRef = useRef(null);

            const handleFile = (file) => {
                if (!file) return;
                
                // Check file type (basic check)
                if (file.type !== "application/json" && !file.name.endsWith(".json")) {
                setError("JSON íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    // Basic validation check
                    if (!json.participants || !json.race_info) {
                    throw new Error("ì˜¬ë°”ë¥´ì§€ ì•Šì€ ê²½ë§ˆ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.");
                    }
                    onFileLoaded(json);
                } catch (err) {
                    setError("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
                }
                };
                reader.readAsText(file);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                setIsDragging(true);
            };

            const handleDragLeave = () => {
                setIsDragging(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragging(false);
                const file = e.dataTransfer.files[0];
                handleFile(file);
            };

            const handleInputChange = (e) => {
                const file = e.target.files[0];
                handleFile(file);
            };

            return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
                <div 
                    className={`bg-white p-10 rounded-2xl shadow-xl max-w-lg w-full text-center border-2 transition-all
                    ${isDragging ? 'border-blue-500 bg-blue-50' : 'border-dashed border-slate-300'}`}
                    onDragOver={handleDragOver}
                    onDragLeave={handleDragLeave}
                    onDrop={handleDrop}
                >
                    <div className="mb-6 flex justify-center">
                    <div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center">
                        <FileJson className="w-10 h-10 text-blue-600" />
                    </div>
                    </div>
                    
                    <h1 className="text-2xl font-bold text-slate-800 mb-2">ê²½ë§ˆ ë¶„ì„ ë°ì´í„° ì—…ë¡œë“œ</h1>
                    <p className="text-slate-500 mb-8">
                    ì¤€ë¹„ëœ <code>race_data.json</code> íŒŒì¼ì„<br/>ì´ê³³ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”.
                    </p>

                    {error && (
                    <div className="mb-6 p-3 bg-red-50 text-red-600 text-sm rounded-lg flex items-center justify-center gap-2">
                        <AlertTriangle className="w-4 h-4" /> {error}
                    </div>
                    )}

                    <input 
                    type="file" 
                    accept=".json" 
                    ref={fileInputRef} 
                    onChange={handleInputChange} 
                    className="hidden" 
                    />
                    
                    <button 
                    onClick={() => fileInputRef.current.click()}
                    className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl transition-colors flex items-center gap-2 mx-auto"
                    >
                    <Upload className="w-5 h-5" /> íŒŒì¼ ì„ íƒí•˜ê¸°
                    </button>
                </div>
                </div>
            );
        };

        // ==========================================
        // 3. Race Analysis Template (Main View)
        // ==========================================

        const RaceAnalysisTemplate = ({ data, onReset }) => {
            const [selectedHorse, setSelectedHorse] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            const [sortConfig, setSortConfig] = useState({ key: 'entry_number', direction: 'ascending' });

            const processedEntries = useMemo(() => {
                if (!data || !data.participants) return [];

                let entries = [...data.participants];

                if (searchTerm) {
                entries = entries.filter(item => 
                    item.name.includes(searchTerm) || 
                    item.connections.jockey.name.includes(searchTerm) ||
                    item.connections.trainer.name.includes(searchTerm)
                );
                }

                if (sortConfig.key) {
                entries.sort((a, b) => {
                    let aValue, bValue;

                    switch(sortConfig.key) {
                    case 'entry_number': aValue = a.entry_number; bValue = b.entry_number; break;
                    case 'name': aValue = a.name; bValue = b.name; break;
                    case 'speedIndex': aValue = parseFloat(a.analysis.speed_index) || 0; bValue = parseFloat(b.analysis.speed_index) || 0; break;
                    case 'rating': aValue = a.profile.rating; bValue = b.profile.rating; break;
                    case 'training_total': aValue = a.status.training_total; bValue = b.status.training_total; break;
                    default: aValue = 0; bValue = 0;
                    }

                    if (typeof aValue === 'string' && !isNaN(parseFloat(aValue))) {
                        aValue = parseFloat(aValue.replace(/[^0-9.]/g, ''));
                        bValue = parseFloat(bValue.replace(/[^0-9.]/g, ''));
                    }

                    if (aValue < bValue) return sortConfig.direction === 'ascending' ? -1 : 1;
                    if (aValue > bValue) return sortConfig.direction === 'ascending' ? 1 : -1;
                    return 0;
                });
                }
                return entries;
            }, [data, searchTerm, sortConfig]);

            const requestSort = (key) => {
                let direction = 'ascending';
                if (sortConfig.key === key && sortConfig.direction === 'ascending') {
                direction = 'descending';
                }
                setSortConfig({ key, direction });
            };

            const getSortIndicator = (key) => {
                if (sortConfig.key !== key) return <span className="text-gray-300 ml-1">â‡…</span>;
                return sortConfig.direction === 'ascending' ? <ChevronUp className="w-3 h-3 inline ml-1" /> : <ChevronDown className="w-3 h-3 inline ml-1" />;
            };

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans p-4 md:p-8">
                
                {/* Header */}
                <header className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <div className="flex items-center gap-2 mb-2">
                        <span className="bg-slate-800 text-white px-3 py-1 rounded-full text-xs font-bold tracking-wider">
                            {data.race_header?.location || data.meta.location} {data.race_header?.race_number || data.meta.race_number}R
                        </span>
                        <span className="text-slate-500 text-sm font-medium flex items-center gap-1">
                            <Calendar className="w-4 h-4" /> {data.race_header?.date || data.meta.date}
                        </span>
                        </div>
                        <h1 className="text-2xl md:text-3xl font-extrabold text-slate-900 mb-1">
                        {data.race_info.class_name}
                        </h1>
                        <div className="flex flex-wrap gap-2 text-sm text-slate-500 mb-2">
                        {data.race_info.conditions.map((cond, idx) => (
                            <span key={idx} className="bg-slate-100 px-2 py-1 rounded text-xs">{cond}</span>
                        ))}
                        </div>
                        <div className="text-xs text-blue-600 font-medium">
                        â€» {data.race_info.class_name} ìš°ìŠ¹ë§ˆ í‰ê· ê¸°ë¡(ê¸°ì¤€): {data.race_info.benchmark_time_1800} (ìŠ¤í”¼ë“œì§€ìˆ˜ 100)
                        </div>
                    </div>
                    
                    <div className="flex flex-col items-end gap-3">
                        <button 
                        onClick={onReset}
                        className="text-slate-500 hover:text-slate-800 flex items-center gap-1 text-sm bg-slate-100 px-3 py-1.5 rounded-lg hover:bg-slate-200 transition-colors"
                        >
                        <RefreshCw className="w-4 h-4" /> ë‹¤ë¥¸ íŒŒì¼ ì—´ê¸°
                        </button>
                        <div className="text-right hidden md:block">
                        <div className="text-3xl font-bold text-blue-600">{data.race_info.start_time}</div>
                        <div className="text-sm text-slate-400">ë°œì£¼ ì‹œê°</div>
                        </div>
                    </div>
                    </div>
                </header>

                {/* Controls */}
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-lg font-bold flex items-center gap-2">
                    <Activity className="w-5 h-5 text-blue-500" />
                    ì¶œì „ë§ˆ ë¶„ì„í‘œ
                    </h2>
                    <div className="relative">
                    <input 
                        type="text" 
                        placeholder="ë§ˆëª…, ê¸°ìˆ˜ ê²€ìƒ‰..." 
                        className="pl-9 pr-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                    />
                    <Search className="w-4 h-4 text-slate-400 absolute left-3 top-2.5" />
                    </div>
                </div>

                {/* Main Table */}
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                    <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left">
                        <thead className="bg-slate-100 text-slate-600 border-b border-slate-200">
                        <tr>
                            <th onClick={() => requestSort('entry_number')} className="p-4 font-semibold cursor-pointer hover:bg-slate-200 w-16 text-center">ë²ˆí˜¸{getSortIndicator('entry_number')}</th>
                            <th onClick={() => requestSort('name')} className="p-4 font-semibold cursor-pointer hover:bg-slate-200">ë§ˆëª… (ì‚°ì§€/ì„±ë³„/ë‚˜ì´){getSortIndicator('name')}</th>
                            <th className="p-4 font-semibold text-center">ì˜ˆìƒ ê°ì§ˆ</th>
                            <th onClick={() => requestSort('speedIndex')} className="p-4 font-semibold cursor-pointer hover:bg-slate-200 text-center text-blue-800">ìŠ¤í”¼ë“œ ì§€ìˆ˜{getSortIndicator('speedIndex')}</th>
                            <th onClick={() => requestSort('rating')} className="p-4 font-semibold cursor-pointer hover:bg-slate-200 text-center">ë ˆì´íŒ…{getSortIndicator('rating')}</th>
                            <th className="p-4 font-semibold text-center">ê¸°ìˆ˜ / ì¡°êµì‚¬ (11ì›” ìŠ¹ë¥ )</th>
                            <th className="p-4 font-semibold text-center">ë¶€ë‹´ì¤‘ëŸ‰</th>
                            <th className="p-4 font-semibold text-center text-red-600">ë§ˆì²´ì¤‘ (ì¦ê°)</th>
                            <th className="p-4 font-semibold text-center">ìµœê·¼ 3íšŒ ì„±ì  (ë“±ê¸‰ê²½ì£¼)</th>
                            <th onClick={() => requestSort('training_total')} className="p-4 font-semibold cursor-pointer hover:bg-slate-200 w-32">í›ˆë ¨ëŸ‰{getSortIndicator('training_total')}</th>
                            <th className="p-4 font-semibold text-center">ìƒíƒœ ì•Œë¦¼</th>
                        </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                        {processedEntries.map((horse) => {
                            const displayRecords = horse.records.recent_history.filter(r => {
                            const type = r.race_class || '';
                            return !type.includes('ì£¼') && !type.includes('ì—°ìŠµ');
                            });

                            return (
                            <tr 
                                key={horse.entry_number} 
                                onClick={() => setSelectedHorse(horse)}
                                className={`hover:bg-blue-50 cursor-pointer transition-colors ${selectedHorse?.entry_number === horse.entry_number ? 'bg-blue-50' : ''}`}
                            >
                                <td className="p-4 text-center font-bold text-lg text-slate-700">{horse.entry_number}</td>
                                <td className="p-4">
                                <div className="font-bold text-blue-700 hover:text-blue-900 hover:underline text-base flex items-center flex-wrap gap-1 cursor-pointer">
                                    {horse.name}
                                    <ChangeBadge type={horse.status.change_type} />
                                </div>
                                <div className="text-xs text-slate-500 mt-1">
                                    {horse.profile.origin} Â· {horse.profile.gender} Â· {horse.profile.age}ì„¸ Â· {horse.status.race_cycle}ë§Œ ì¶œì „
                                </div>
                                </td>
                                <td className="p-4 text-center">
                                <RunningStyleBadge style={horse.analysis.running_style} />
                                </td>
                                <td className="p-4 text-center">
                                <SpeedIndexBadge index={horse.analysis.speed_index} />
                                </td>
                                <td className="p-4 text-center">
                                <span className="font-mono font-bold text-slate-700 bg-slate-100 px-2 py-1 rounded">{horse.profile.rating}</span>
                                <div className="mt-1">
                                    <DiffValue current={horse.profile.rating} prev={horse.records.recent_history[0]?.rating} />
                                </div>
                                </td>
                                <td className="p-4 text-center">
                                <div className="flex flex-col items-center gap-1">
                                    <div className="font-medium flex items-center">
                                    {horse.connections.jockey.name}
                                    <WinRateBadge rate={horse.connections.jockey.nov_win_rate} />
                                    </div>
                                    <div className="text-xs text-slate-400 flex items-center">
                                    {horse.connections.trainer.name}
                                    <WinRateBadge rate={horse.connections.trainer.nov_win_rate} />
                                    </div>
                                </div>
                                </td>
                                <td className="p-4 text-center text-slate-600">
                                <div className="font-bold">{horse.profile.burden_weight}kg</div>
                                <DiffValue current={horse.profile.burden_weight} prev={horse.records.recent_history[0]?.burden_weight} />
                                </td>
                                <td className="p-4 text-center">
                                <BodyWeightValue weight={horse.status.body_weight} change={horse.status.body_weight_change} />
                                </td>
                                <td className="p-4">
                                <div className="flex gap-2 justify-center">
                                    {displayRecords.slice(0, 3).map((rec, idx) => (
                                    <RankBadge key={idx} rank={rec.rank} />
                                    ))}
                                </div>
                                </td>
                                <td className="p-4">
                                <TrainingBar count={horse.status.training_total} jockeyCount={horse.status.jockey_training_count} />
                                </td>
                                <td className="p-4 text-center">
                                <div className="flex justify-center gap-2">
                                    {horse.alerts.medical.length > 0 && (
                                    <div className="group relative">
                                        <AlertTriangle className="w-5 h-5 text-red-500" />
                                        <span className="absolute bottom-full left-1/2 -translate-x-1/2 bg-black text-white text-xs p-1 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap z-10 mb-1">
                                        {horse.alerts.medical[0].detail}
                                        </span>
                                    </div>
                                    )}
                                    {horse.alerts.steward.length > 0 && (
                                        <div className="group relative">
                                        <Info className="w-5 h-5 text-amber-500" />
                                        <span className="absolute bottom-full right-0 bg-black text-white text-xs p-1 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap z-10 mb-1 w-48 truncate">
                                            {horse.alerts.steward[0].note}
                                        </span>
                                        </div>
                                    )}
                                    {horse.alerts.medical.length === 0 && horse.alerts.steward.length === 0 && (
                                    <span className="text-slate-200 text-xs">-</span>
                                    )}
                                </div>
                                </td>
                            </tr>
                            );
                        })}
                        </tbody>
                    </table>
                    </div>
                </div>

                {/* Detail Modal */}
                {selectedHorse && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in" onClick={() => setSelectedHorse(null)}>
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="sticky top-0 bg-white z-10 flex justify-between items-start p-6 border-b border-slate-100">
                        <div>
                            <div className="flex items-center gap-2">
                            <span className="bg-blue-600 text-white w-8 h-8 flex items-center justify-center rounded-full font-bold">
                                {selectedHorse.entry_number}
                            </span>
                            <h2 className="text-2xl font-bold text-slate-900">{selectedHorse.name} ìƒì„¸ ë¶„ì„</h2>
                            <ChangeBadge type={selectedHorse.status.change_type} />
                            </div>
                            <div className="flex flex-wrap items-center gap-4 mt-2">
                            <p className="text-slate-500 text-sm">
                                ë¶€: {selectedHorse.profile.sire} | ì¥êµ¬: {selectedHorse.status.equipment}
                            </p>
                            <div className="flex items-center gap-1 text-sm font-medium text-slate-700 bg-slate-100 px-2 py-0.5 rounded">
                                <Zap className="w-4 h-4 text-yellow-500" />
                                ì˜ˆìƒ ê°ì§ˆ: {selectedHorse.analysis.running_style || 'ì •ë³´ ë¶€ì¡±'}
                            </div>
                            <div className="flex items-center gap-1 text-sm font-medium text-slate-700 bg-yellow-50 border border-yellow-200 px-2 py-0.5 rounded">
                                <Trophy className="w-4 h-4 text-yellow-600" />
                                ì´ ìƒê¸ˆ: {selectedHorse.profile.total_prize}
                            </div>
                            <div className="flex items-center gap-1 text-sm font-medium text-blue-700 bg-blue-50 border border-blue-200 px-2 py-0.5 rounded">
                                <Gauge className="w-4 h-4 text-blue-600" />
                                ìŠ¤í”¼ë“œ ì§€ìˆ˜: {selectedHorse.analysis.speed_index}
                            </div>
                            <div className="flex items-center gap-1 text-sm font-medium text-slate-700 bg-gray-50 border border-gray-200 px-2 py-0.5 rounded">
                                <Scale className="w-4 h-4 text-slate-500" />
                                ë§ˆì²´ì¤‘: {selectedHorse.status.body_weight}kg ({selectedHorse.status.body_weight_change > 0 ? '+' : ''}{selectedHorse.status.body_weight_change})
                            </div>
                            </div>
                        </div>
                        <button 
                            onClick={() => setSelectedHorse(null)}
                            className="text-slate-400 hover:text-slate-600 p-2 rounded-full hover:bg-slate-100 transition-colors"
                        >
                            <X className="w-6 h-6" />
                        </button>
                        </div>

                        <div className="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2 space-y-6">
                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <h3 className="font-bold flex items-center gap-2 mb-3 text-slate-800">
                                <History className="w-4 h-4" /> ìµœê·¼ 5íšŒ ê²½ì£¼ ê¸°ë¡
                            </h3>
                            <div className="overflow-x-auto">
                                <table className="w-full text-xs md:text-sm">
                                <thead className="text-slate-500 border-b border-slate-200">
                                    <tr>
                                    <th className="pb-2 text-left">ì¼ì</th>
                                    <th className="pb-2 text-left">ê±°ë¦¬</th>
                                    <th className="pb-2 text-center">ìˆœìœ„</th>
                                    <th className="pb-2 text-center text-blue-600">ë“±ê¸‰(Class)</th>
                                    <th className="pb-2 text-right">ê¸°ë¡</th>
                                    <th className="pb-2 text-right text-xs">S1F(ì´ˆë°˜)</th>
                                    <th className="pb-2 text-right text-xs font-bold text-blue-600">G3F(3F)</th>
                                    <th className="pb-2 text-right text-xs">G1F(í›„ë°˜)</th>
                                    <th className="pb-2 text-center text-xs">í•¨ìˆ˜ìœ¨</th>
                                    <th className="pb-2 text-center text-xs">ë ˆì´íŒ…</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {selectedHorse.records.recent_history.slice(0, 5).map((rec, i) => (
                                    <tr key={i} className="hover:bg-white">
                                        <td className="py-2 text-slate-600">{rec.date}</td>
                                        <td className="py-2">{rec.distance}M</td>
                                        <td className="py-2 text-center">
                                        <span className={`inline-block w-6 text-center rounded font-bold ${rec.rank <= 3 ? 'bg-red-50 text-red-600' : 'text-slate-600'}`}>
                                            {rec.rank}
                                        </span>
                                        </td>
                                        <td className="py-2 text-center text-slate-600 font-medium">{rec.race_class}</td>
                                        <td className="py-2 text-right font-mono">{rec.record}</td>
                                        <td className="py-2 text-right text-slate-500">{rec.S1F}</td>
                                        <td className="py-2 text-right font-bold text-blue-700 bg-blue-50/50">{rec.G3F}</td>
                                        <td className="py-2 text-right font-medium text-slate-700">{rec.G1F}</td>
                                        <td className="py-2 text-center text-slate-500">{rec.moisture}%</td>
                                        <td className="py-2 text-center font-mono text-slate-600 bg-gray-50">{rec.rating}</td>
                                    </tr>
                                    ))}
                                </tbody>
                                </table>
                            </div>
                            </div>

                            {selectedHorse.alerts.steward.length > 0 && (
                            <div className="bg-amber-50 p-4 rounded-xl border border-amber-100">
                                <h3 className="font-bold flex items-center gap-2 mb-3 text-amber-800">
                                <AlertTriangle className="w-4 h-4" /> ì‹¬íŒ ìœ„ì› ì§€ì  ì‚¬í•­ (Trip Notes)
                                </h3>
                                <ul className="space-y-2">
                                {selectedHorse.alerts.steward.map((note, i) => (
                                    <li key={i} className="text-sm text-amber-900 bg-white/50 p-2 rounded">
                                    <span className="font-bold text-amber-700 text-xs mr-2 border border-amber-200 bg-white px-1 rounded">{note.date}</span>
                                    {note.note}
                                    </li>
                                ))}
                                </ul>
                            </div>
                            )}
                        </div>

                        <div className="space-y-6">
                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                            <h3 className="font-bold flex items-center gap-2 mb-3 text-slate-800">
                                <Activity className="w-4 h-4 text-red-500" /> ë§ˆì²´ ìƒíƒœ
                            </h3>
                            {selectedHorse.alerts.medical.length > 0 ? (
                                <div className="space-y-2">
                                {selectedHorse.alerts.medical.map((item, idx) => (
                                    <div key={idx} className="bg-red-50 text-red-700 p-3 rounded-lg text-sm font-medium border border-red-100 flex flex-col">
                                        <span className="text-xs text-red-400 mb-1">{item.date}</span>
                                        <span>âš ï¸ {item.detail}</span>
                                    </div>
                                ))}
                                </div>
                            ) : (
                                <div className="text-sm text-green-600 bg-green-50 p-3 rounded-lg flex items-center gap-2">
                                âœ“ íŠ¹ì´ì‚¬í•­ ì—†ìŒ (ì–‘í˜¸)
                                </div>
                            )}
                            </div>

                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                            <h3 className="font-bold flex items-center gap-2 mb-3 text-slate-800">
                                <Timer className="w-4 h-4 text-blue-500" /> í›ˆë ¨ ìš”ì•½
                            </h3>
                            <div className="flex justify-between items-end mb-2">
                                <span className="text-sm text-slate-500">ì´ í›ˆë ¨ / ê¸°ìˆ˜ ì§ì¡°</span>
                                <div className="text-right">
                                <span className="text-2xl font-bold text-slate-800">{selectedHorse.status.training_total}íšŒ</span>
                                <span className="text-sm text-blue-600 ml-2">({selectedHorse.status.jockey_training_count}íšŒ)</span>
                                </div>
                            </div>
                            {selectedHorse.training_logs.sessions && selectedHorse.training_logs.sessions.length > 0 ? (
                                <div className="space-y-2 mt-4">
                                    <div className="text-xs font-semibold text-slate-400 uppercase">ìµœê·¼ ì„¸ì…˜</div>
                                    {selectedHorse.training_logs.sessions.slice(0,3).map((ses, idx) => (
                                        <div key={idx} className="flex justify-between text-xs border-b border-slate-50 pb-1">
                                            <span className="text-slate-600">{ses.date}</span>
                                            <span className="text-slate-800 font-medium">{ses.time} ({ses.type}) <span className="text-slate-400 text-[10px]">{ses.rider}</span></span>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-xs text-slate-400">ìƒì„¸ í›ˆë ¨ ê¸°ë¡ ì—†ìŒ</div>
                            )}
                            </div>
                        </div>
                        </div>
                    </div>
                    </div>
                )}

                <footer className="mt-12 text-center text-slate-400 text-xs pb-8">
                    ë°ì´í„° ê¸°ì¤€: {data.race_header?.date || data.meta.date} {data.race_header?.location || data.meta.location} ê²½ë§ˆì¥ | ì œê³µëœ JSON ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±ë¨
                </footer>
                </div>
            );
        };

        const SeoulRaceAnalysis = () => {
            const [data, setData] = useState(null);

            return (
                <>
                {!data ? (
                    <FileUploadScreen onFileLoaded={setData} />
                ) : (
                    <RaceAnalysisTemplate data={data} onReset={() => setData(null)} />
                )}
                </>
            );
        };

        // 4. ì•± ì‹¤í–‰ (Mount)
        const root = createRoot(document.getElementById('root'));
        root.render(<SeoulRaceAnalysis />);

    </script>
</body>
</html>
