<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>서울/부산 스마트 통합 경마지 (JSON)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide React Icons -->
    <script src="https://unpkg.com/lucide-react@0.294.0/dist/umd/lucide-react.min.js"></script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-100 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        // --- Icons Setup ---
        const getIcon = (name) => {
            const lib = window.lucideReact || window.lucide;
            return lib ? (lib[name] || lib[name.toLowerCase()]) : () => null;
        };
        
        const ChevronDown = getIcon('ChevronDown');
        const ChevronUp = getIcon('ChevronUp');
        const Upload = getIcon('Upload');
        const Trophy = getIcon('Trophy');
        const Clock = getIcon('Clock');
        const Calendar = getIcon('Calendar');
        const User = getIcon('User');
        const Scale = getIcon('Scale');
        const AlertTriangle = getIcon('AlertTriangle');
        const Flame = getIcon('Flame');
        const TrendingUp = getIcon('TrendingUp');
        const Info = getIcon('Info');
        const Timer = getIcon('Timer');
        const Zap = getIcon('Zap');
        const Rocket = getIcon('Rocket');
        const Medal = getIcon('Medal');
        const FileText = getIcon('FileText');
        const Activity = getIcon('Activity');
        const Crown = getIcon('Crown');
        const Repeat = getIcon('Repeat');
        const MapPin = getIcon('MapPin');
        const ArrowDownCircle = getIcon('ArrowDownCircle');
        const Leaf = getIcon('Leaf');
        const Code = getIcon('Code');

        // --- UI Components ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden ${className}`}>
                {children}
            </div>
        );

        const Badge = ({ children, color = "gray", className = "" }) => {
            const colors = {
                red: "bg-red-100 text-red-800 border-red-200",
                blue: "bg-blue-100 text-blue-800 border-blue-200",
                green: "bg-green-100 text-green-800 border-green-200",
                yellow: "bg-yellow-100 text-yellow-800 border-yellow-200",
                purple: "bg-purple-100 text-purple-800 border-purple-200",
                gray: "bg-gray-100 text-gray-800 border-gray-200",
                orange: "bg-orange-100 text-orange-800 border-orange-200",
                dark: "bg-slate-800 text-white border-slate-900",
                teal: "bg-teal-100 text-teal-800 border-teal-200",
                pink: "bg-pink-100 text-pink-800 border-pink-200",
            };
            return (
                <span className={`px-1.5 py-0.5 rounded text-[10px] font-bold border whitespace-nowrap flex items-center gap-0.5 ${colors[color] || colors.gray} ${className}`}>
                    {children}
                </span>
            );
        };

        // --- Utils ---
        const getHorseColor = (no) => {
            const num = parseInt(no);
            switch (num) {
                case 1: return { bg: "bg-white border-2 border-gray-400", text: "text-black" };
                case 2: return { bg: "bg-yellow-400 border-yellow-500", text: "text-black" };
                case 3: return { bg: "bg-red-600 border-red-700", text: "text-white" };
                case 4: return { bg: "bg-black border-gray-800", text: "text-white" };
                case 5: return { bg: "bg-blue-600 border-blue-700", text: "text-white" };
                case 6: return { bg: "bg-green-600 border-green-700", text: "text-white" };
                case 7: return { bg: "bg-amber-800 border-amber-900", text: "text-white" };
                case 8: return { bg: "bg-pink-400 border-pink-500", text: "text-white" };
                case 9: return { bg: "bg-purple-600 border-purple-700", text: "text-white" };
                case 10: return { bg: "bg-sky-300 border-sky-400", text: "text-black" };
                case 11: return { bg: "bg-white border-4 border-green-600", text: "text-green-800" };
                case 12: return { bg: "bg-yellow-400 border-4 border-green-600", text: "text-green-800" };
                case 13: return { bg: "bg-orange-300 border-4 border-orange-500", text: "text-black" };
                case 14: return { bg: "bg-pink-200 border-4 border-pink-400", text: "text-black" };
                default: return { bg: "bg-gray-200", text: "text-gray-800" };
            }
        };

        const timeToSeconds = (timeStr) => {
            if (!timeStr || !timeStr.includes(':')) return 9999;
            const parts = timeStr.split(':');
            return parseFloat(parts[0]) * 60 + parseFloat(parts[1]);
        };

        const cleanText = (text) => text ? text.replace(/^[.\s,:\-/>·\[\]]+/, '').replace(/[.\s,:\-/>·\[\]]+$/, '').trim() : "";
        const normalizeName = (name) => name?.replace(/\s/g, '').replace(/\./g, '');

        const LOCATIONS = { SEOUL: 'seoul', BUSAN: 'busan' };

        function RaceCardApp() {
            const [activeLocation, setActiveLocation] = useState(LOCATIONS.SEOUL);
            const [activeTab, setActiveTab] = useState('view');
            
            const [data, setData] = useState({
                seoul: { races: [], histories: [], easyRace: { races: {}, horses: {} }, expertPick: {} },
                busan: { races: [], histories: [], easyRace: { races: {}, horses: {} }, expertPick: {} }
            });

            const [selectedRaceIdx, setSelectedRaceIdx] = useState(0);
            const [expandedHorse, setExpandedHorse] = useState(null);
            const [raceStats, setRaceStats] = useState({});
            const [showDebug, setShowDebug] = useState(false);

            // --- Parsers ---
            const parseEntryCSV = (text) => {
                const lines = text.split('\n');
                const parsedRaces = [];
                let currentRace = null;
                let isHeader = false;

                lines.forEach((line) => {
                    const trimmed = line.trim();
                    if (!trimmed) return;

                    if (trimmed.includes('경주') && (trimmed.includes('부경') || trimmed.includes('부산') || trimmed.includes('서울'))) {
                        const raceInfo = trimmed.split(',');
                        const raceTitleParts = raceInfo[0].match(/제(\d+)경주/);
                        const raceNo = raceTitleParts ? raceTitleParts[1] : '?';
                        const startTime = raceInfo[1] ? raceInfo[1].trim() : '';
                        const distanceMatch = trimmed.match(/(\d{3,4})M/i);
                        
                        if (currentRace && currentRace.no === raceNo) return; 
                        if (currentRace) parsedRaces.push(currentRace);
                        
                        currentRace = {
                            no: raceNo,
                            headerRaw: trimmed,
                            startTime: startTime,
                            distance: distanceMatch ? distanceMatch[1] : null,
                            conditions: '',
                            horses: []
                        };
                        isHeader = false;
                        return;
                    }

                    if (currentRace && !currentRace.conditions && !trimmed.startsWith('번호')) {
                        currentRace.conditions = trimmed;
                        if (!currentRace.distance) {
                            const dist = trimmed.match(/(\d{3,4})M/i);
                            if (dist) currentRace.distance = dist[1];
                        }
                        return;
                    }

                    if (trimmed.startsWith('번호')) {
                        isHeader = true;
                        return;
                    }

                    if (currentRace && isHeader) {
                        const cols = trimmed.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); 
                        if (cols.length > 5) {
                            const horseNo = cols[0]?.replace('▲','').replace('*', '');
                            if (!horseNo || currentRace.horses.find(h => h.no === horseNo)) return;

                            currentRace.horses.push({
                                no: horseNo,
                                name: cols[1],
                                origin: cols[2],
                                sex: cols[3],
                                age: cols[4],
                                rating: cols[5]?.trim(),
                                weight: cols[6]?.replace('*', ''),
                                weightDiff: cols[7],
                                jockey: cols[8],
                                trainer: cols[9],
                                owner: cols[10],
                                trainingCount: cols[11],
                                cycle: cols[12],
                                equipment: cols[13]?.replace(/"/g, ''),
                                sire: cols[15],
                                horseGrade: cols[16]?.trim() 
                            });
                        }
                    }
                });

                if (currentRace) parsedRaces.push(currentRace);
                return parsedRaces;
            };

            const parseHistoryCSV = (text) => {
                const lines = text.split('\n');
                const historyData = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line || line.startsWith('출전_경주일자') || line.startsWith('번호')) continue;
                    const cols = line.split(',');
                    if (cols.length < 10) continue;
                    historyData.push({
                        raceNo: cols[1]?.replace(/[^0-9]/g, '').trim(), 
                        horseNo: cols[5]?.trim(),
                        horseName: cols[6]?.trim(),
                        date: cols[12]?.trim(),
                        grade: cols[13],
                        distance: cols[14]?.trim().replace('M',''),
                        record: cols[15]?.trim(),
                        rank: cols[16],
                        weather: cols[18],
                        jockey: cols[21]?.trim(), 
                        weight: cols[22]?.trim(),
                        s1f: cols[23]?.trim(),
                        g3f: cols[24]?.trim(),
                        g1f: cols[25]?.trim(),
                        runningWeight: cols[26]
                    });
                }
                return historyData;
            };

            const parseExpertPick = (text) => {
                const expertData = {};
                const raceSections = text.split(/(부산|서울|부경)\s*(\d+)\s*경주\s*:/);
                
                for (let i = 1; i < raceSections.length; i += 3) {
                    if (i + 2 >= raceSections.length) break;
                    
                    const locationStr = raceSections[i];
                    const raceNo = raceSections[i + 1];
                    const raceContent = raceSections[i + 2] || '';
                    const location = locationStr === '부경' ? 'busan' : (locationStr === '부산' ? 'busan' : 'seoul');
                    
                    const firstLine = raceContent.split('\n')[0]?.trim() || '';
                    const gradeMatch = firstLine.match(/(\d+)등급/);
                    
                    const race = {
                        raceNo: raceNo,
                        location: location,
                        info: firstLine,
                        recommended: [],
                        darkHorse: [],
                        frontRunner: [],
                        horseComments: {}
                    };
                    
                    const fullText = raceContent.replace(/\n/g, ' ');
                    
                    const recommendedMatch = fullText.match(/추천(?:[*]*)(?:\s*마번)?(?:[*]*)\s*[:：]\s*[*]*\s*(.+?)(?=\s*(?:[*]*)\s*(?:복병|선행)|$)/);
                    if (recommendedMatch) {
                        const horseMatches = recommendedMatch[1].matchAll(/\((\d+)\)\s*([가-힣a-zA-Z\.]+)/g);
                        for (const match of horseMatches) {
                            race.recommended.push({ no: match[1], name: normalizeName(match[2]) });
                        }
                    }
                    
                    const darkHorseMatch = fullText.match(/복병(?:[*]*)\s*[:：]\s*[*]*\s*([\d, ]+)/);
                    if (darkHorseMatch) {
                        race.darkHorse = darkHorseMatch[1].split(',').map(n => n.trim()).filter(n => n);
                    }
                    
                    const frontRunnerMatch = fullText.match(/선행(?:[*]*)(?:\s*유력)?(?:[*]*)\s*[:：]\s*[*]*\s*([\d, ]+)/);
                    if (frontRunnerMatch) {
                        race.frontRunner = frontRunnerMatch[1].split(',').map(n => n.trim()).filter(n => n);
                    }
                    
                    const horsePattern = /\((\d+)\)\s*([가-힣a-zA-Z]+)/g;
                    let match;
                    const horsePositions = [];
                    while ((match = horsePattern.exec(fullText)) !== null) {
                        horsePositions.push({
                            no: match[1],
                            name: normalizeName(match[2]),
                            start: match.index,
                            end: match.index + match[0].length
                        });
                    }
                    
                    for (let j = 0; j < horsePositions.length; j++) {
                        const horse = horsePositions[j];
                        const nextHorseStart = j < horsePositions.length - 1 ? horsePositions[j + 1].start : fullText.length;
                        const keywords = ['추천:', '추천 마번:', '복병:', '선행'].map(k => fullText.indexOf(k, horse.end)).filter(i => i > 0);
                        const nextKeyword = keywords.length > 0 ? Math.min(...keywords, nextHorseStart) : nextHorseStart;
                        
                        let comment = fullText.substring(horse.end, nextKeyword).trim();
                        comment = cleanText(comment).replace(/\s+/g, ' ');
                        
                        if (comment && comment.length > 5) {
                            race.horseComments[horse.no] = { name: horse.name, comment: comment };
                        }
                    }
                    
                    if (!expertData[location]) expertData[location] = {};
                    expertData[location][raceNo] = race;
                }
                return expertData;
            };

            const handleFileUpload = async (e, type, location) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const text = evt.target.result;
                    try {
                        if (type === 'entry') {
                            const parsedData = parseEntryCSV(text);
                            setData(prev => ({ ...prev, [location]: { ...prev[location], races: parsedData } }));
                            if (location === activeLocation) setSelectedRaceIdx(0);
                        } else if (type === 'history') {
                            const parsedData = parseHistoryCSV(text);
                            setData(prev => ({ ...prev, [location]: { ...prev[location], histories: parsedData } }));
                        } else if (type === 'json') {
                            const parsedData = JSON.parse(text);
                            setData(prev => ({ ...prev, [location]: { ...prev[location], easyRace: parsedData } }));
                        } else if (type === 'expertPick') {
                            const parsedData = parseExpertPick(text);
                            setData(prev => {
                                const newData = { ...prev };
                                Object.keys(parsedData).forEach(loc => {
                                    newData[loc] = { ...newData[loc], expertPick: parsedData[loc] || {} };
                                });
                                return newData;
                            });
                        }
                    } catch (err) {
                        alert('파일 처리 중 오류: ' + err.message);
                    }
                };
                reader.readAsText(file, 'UTF-8');
            };

            const getCurrentLocationData = () => data[activeLocation];

            const getHistoryForHorse = (raceNo, horseNo) => {
                const { histories } = getCurrentLocationData();
                const rawList = histories.filter(h => String(h.raceNo) === String(raceNo) && String(h.horseNo) === String(horseNo));
                const uniqueList = rawList.reduce((acc, current) => {
                    return acc.find(item => item.date === current.date) ? acc : acc.concat([current]);
                }, []);
                return uniqueList.sort((a, b) => new Date(b.date?.split('-')[0] || 0) - new Date(a.date?.split('-')[0] || 0));
            };

            const calculateRaceStats = (currentRace) => {
                const stats = { fastestStart: [], fastestFinish: [], bestRecords: {}, topRating: [], topTraining: [] };
                if(!currentRace) return stats;

                const raceDist = currentRace.distance?.replace('M','').trim();
                let maxRating = -1;
                let maxTraining = -1;
                
                currentRace.horses.forEach(h => {
                    const r = parseInt(h.rating) || 0;
                    const t = parseInt(h.trainingCount) || 0;
                    if (r > maxRating) maxRating = r;
                    if (t > maxTraining) maxTraining = t;
                });

                if (maxRating > 0) stats.topRating = currentRace.horses.filter(h => (parseInt(h.rating) || 0) === maxRating).map(h => h.no);
                if (maxTraining > 0) stats.topTraining = currentRace.horses.filter(h => (parseInt(h.trainingCount) || 0) === maxTraining).map(h => h.no);

                const speedList = currentRace.horses.map(horse => {
                    const myHistory = getHistoryForHorse(currentRace.no, horse.no);
                    const recent3 = myHistory.slice(0, 3);
                    const s1fVals = recent3.map(h => timeToSeconds(h.s1f)).filter(v => v < 100);
                    const avgS1f = s1fVals.length > 0 ? s1fVals.reduce((a,b) => a+b, 0) / s1fVals.length : 999;
                    const g1fVals = recent3.map(h => timeToSeconds(h.g1f)).filter(v => v < 100);
                    const avgG1f = g1fVals.length > 0 ? g1fVals.reduce((a,b) => a+b, 0) / g1fVals.length : 999;
                    const distHistory = myHistory.filter(h => h.distance == raceDist && h.record);
                    let bestRec = null;
                    if (distHistory.length > 0) {
                        bestRec = distHistory.reduce((prev, curr) => timeToSeconds(prev.record) < timeToSeconds(curr.record) ? prev : curr);
                    }
                    return { no: horse.no, avgS1f, avgG1f, bestRec };
                });

                stats.fastestStart = [...speedList].sort((a,b) => a.avgS1f - b.avgS1f).slice(0, 3).map(i => i.no);
                stats.fastestFinish = [...speedList].sort((a,b) => a.avgG1f - b.avgG1f).slice(0, 3).map(i => i.no);
                speedList.forEach(item => { if(item.bestRec) stats.bestRecords[item.no] = item.bestRec.record; });
                return stats;
            };

            useEffect(() => {
                const { races } = getCurrentLocationData();
                if (races.length > 0) {
                    const newStats = {};
                    races.forEach(race => { newStats[race.no] = calculateRaceStats(race); });
                    setRaceStats(newStats);
                }
            }, [activeLocation, data]);

            const { races, easyRace, expertPick } = getCurrentLocationData();
            const currentRace = races[selectedRaceIdx];
            const currentEasyRace = currentRace && easyRace.races[currentRace.no];
            const currentEasyHorses = currentRace && easyRace.horses[currentRace.no];
            const currentStats = currentRace && raceStats[currentRace.no];
            const currentExpertPick = currentRace && expertPick && expertPick[currentRace.no];

            return (
                <div className="min-h-screen bg-slate-100 font-sans text-gray-900 pb-20">
                    <header className="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
                        <div className="max-w-4xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-2 self-start sm:self-center">
                                <Trophy className="w-6 h-6 text-yellow-400" />
                                <h1 className="text-xl font-bold tracking-tight">스마트 통합 경마지</h1>
                            </div>
                            
                            <div className="flex items-center bg-slate-800 rounded-lg p-1 gap-1">
                                <button onClick={() => { setActiveLocation(LOCATIONS.SEOUL); setSelectedRaceIdx(0); }} className={`flex items-center px-4 py-1.5 rounded-md text-sm font-bold transition-all ${activeLocation === LOCATIONS.SEOUL ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-400 hover:text-white'}`}>
                                    <MapPin size={14} className="mr-1"/> 서울
                                </button>
                                <button onClick={() => { setActiveLocation(LOCATIONS.BUSAN); setSelectedRaceIdx(0); }} className={`flex items-center px-4 py-1.5 rounded-md text-sm font-bold transition-all ${activeLocation === LOCATIONS.BUSAN ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-400 hover:text-white'}`}>
                                    <MapPin size={14} className="mr-1"/> 부산
                                </button>
                            </div>

                            <div className="flex gap-2 self-end sm:self-center">
                                <button onClick={() => setActiveTab('view')} className={`text-xs px-3 py-1.5 rounded transition ${activeTab === 'view' ? 'bg-blue-500 text-white font-bold' : 'bg-slate-700 text-gray-300'}`}>경마지 보기</button>
                                <button onClick={() => setActiveTab('upload')} className={`text-xs px-3 py-1.5 rounded transition ${activeTab === 'upload' ? 'bg-purple-600 text-white font-bold' : 'bg-slate-700 text-gray-300'}`}>데이터 설정</button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto p-2 sm:p-4">
                        {activeTab === 'upload' && (
                            <div className="space-y-6 animate-in fade-in duration-300">
                                <div className={`border rounded-lg overflow-hidden ${activeLocation === LOCATIONS.SEOUL ? 'ring-2 ring-blue-500' : 'opacity-70 grayscale'}`}>
                                    <div className="bg-slate-200 p-3 font-bold text-slate-700 flex items-center justify-between">
                                        <span>서울 경마 데이터 설정</span>
                                        {activeLocation !== LOCATIONS.SEOUL && <button onClick={() => setActiveLocation(LOCATIONS.SEOUL)} className="text-xs bg-white px-2 py-1 rounded">활성화하기</button>}
                                    </div>
                                    <div className="p-4 bg-white grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="space-y-3">
                                            <h3 className="text-sm font-bold text-blue-800 flex items-center gap-2"><Upload size={14}/> CSV 파일</h3>
                                            <div>
                                                <label className="block text-xs font-bold text-gray-500 mb-1">통합 출전표 (서울)</label>
                                                <input type="file" accept=".csv" onChange={(e) => handleFileUpload(e, 'entry', 'seoul')} className="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"/>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-gray-500 mb-1">상세 전적 (서울)</label>
                                                <input type="file" accept=".csv" onChange={(e) => handleFileUpload(e, 'history', 'seoul')} className="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-green-50 file:text-green-700 hover:file:bg-green-100 cursor-pointer"/>
                                            </div>
                                        </div>
                                        <div className="space-y-3">
                                            <h3 className="text-sm font-bold text-purple-800 flex items-center gap-2"><FileText size={14}/> Easy Race (JSON)</h3>
                                            <div>
                                                <label className="block text-xs font-bold text-gray-500 mb-1">JSON 파일 (서울)</label>
                                                <input type="file" accept=".json" onChange={(e) => handleFileUpload(e, 'json', 'seoul')} className="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 cursor-pointer"/>
                                            </div>
                                        </div>
                                        <div className="space-y-3 md:col-span-2">
                                            <h3 className="text-sm font-bold text-orange-800 flex items-center gap-2"><Trophy size={14}/> Expert Pick</h3>
                                            <div>
                                                <label className="block text-xs font-bold text-gray-500 mb-1">ExpertPick.txt (통합)</label>
                                                <input type="file" accept=".txt" onChange={(e) => handleFileUpload(e, 'expertPick', 'both')} className="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100 cursor-pointer"/>
                                            </div>
                                        </div>
                                        <div className="md:col-span-2 border-t pt-4">
                                            <button onClick={() => setShowDebug(!showDebug)} className="w-full flex items-center justify-center gap-2 py-2 text-xs font-bold text-gray-600 bg-gray-100 hover:bg-gray-200 rounded transition-colors"><Code size={14}/> JSON 데이터 확인</button>
                                            {showDebug && <div className="mt-4 p-4 bg-slate-800 rounded text-xs font-mono overflow-x-auto"><pre className="text-blue-300">{JSON.stringify(data[activeLocation].easyRace, null, 2)}</pre></div>}
                                        </div>
                                    </div>
                                </div>

                                <div className={`border rounded-lg overflow-hidden ${activeLocation === LOCATIONS.BUSAN ? 'ring-2 ring-blue-500' : 'opacity-70 grayscale'}`}>
                                    <div className="bg-slate-200 p-3 font-bold text-slate-700 flex items-center justify-between">
                                        <span>부산 경마 데이터 설정</span>
                                        {activeLocation !== LOCATIONS.BUSAN && <button onClick={() => setActiveLocation(LOCATIONS.BUSAN)} className="text-xs bg-white px-2 py-1 rounded">활성화하기</button>}
                                    </div>
                                    <div className="p-4 bg-white grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="space-y-3">
                                            <h3 className="text-sm font-bold text-blue-800 flex items-center gap-2"><Upload size={14}/> CSV 파일</h3>
                                            <div>
                                                <label className="block text-xs font-bold text-gray-500 mb-1">통합 출전표 (부산)</label>
                                                <input type="file" accept=".csv" onChange={(e) => handleFileUpload(e, 'entry', 'busan')} className="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"/>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-gray-500 mb-1">상세 전적 (부산)</label>
                                                <input type="file" accept=".csv" onChange={(e) => handleFileUpload(e, 'history', 'busan')} className="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-green-50 file:text-green-700 hover:file:bg-green-100 cursor-pointer"/>
                                            </div>
                                        </div>
                                        <div className="space-y-3">
                                            <h3 className="text-sm font-bold text-purple-800 flex items-center gap-2"><FileText size={14}/> Easy Race (JSON)</h3>
                                            <div>
                                                <label className="block text-xs font-bold text-gray-500 mb-1">JSON 파일 (부산)</label>
                                                <input type="file" accept=".json" onChange={(e) => handleFileUpload(e, 'json', 'busan')} className="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 cursor-pointer"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'view' && (
                            <>
                                {races.length > 0 ? (
                                    <div className="flex overflow-x-auto gap-2 mb-4 pb-2 scrollbar-hide">
                                        {races.map((race, idx) => (
                                            <button key={idx} onClick={() => { setSelectedRaceIdx(idx); setExpandedHorse(null); }} className={`flex-shrink-0 px-4 py-2 rounded-full font-bold text-sm whitespace-nowrap transition-all shadow-sm ${selectedRaceIdx === idx ? 'bg-blue-700 text-white ring-2 ring-blue-300 shadow-md' : 'bg-white text-gray-500 hover:bg-gray-50 border border-gray-200'}`}>
                                                {race.no}경주
                                            </button>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-center py-10 text-gray-400 bg-white rounded-lg border border-dashed border-gray-300 mb-4">
                                        데이터가 없습니다. '데이터 설정' 탭에서 파일을 업로드해주세요.
                                    </div>
                                )}

                                {currentRace && (
                                    <div className="space-y-4">
                                        <div className="bg-white rounded-lg p-4 shadow-md border-l-4 border-l-yellow-400 flex flex-col gap-4 sticky top-16 z-40">
                                            <div className="flex flex-wrap items-center justify-between gap-2">
                                                <div className="flex flex-wrap items-center gap-2">
                                                    <span className="bg-slate-900 text-white text-xs px-2 py-1 rounded">{activeLocation === LOCATIONS.SEOUL ? '서울' : '부산'}</span>
                                                    <h2 className="text-xl sm:text-2xl font-black text-gray-900">제{currentRace.no}경주</h2>
                                                    <span className="text-sm sm:text-lg font-normal text-gray-500 flex items-center gap-1"><Clock size={14} className="sm:w-4 sm:h-4"/> {currentRace.startTime}</span>
                                                    <span className="bg-slate-800 text-white text-xs px-2 py-0.5 rounded font-bold">{currentRace.distance}</span>
                                                    <p className="text-xs text-gray-600 font-medium truncate max-w-[200px] sm:max-w-none">{currentRace.conditions}</p>
                                                </div>
                                                
                                                {currentEasyRace?.avgRecord ? (
                                                    <div className="bg-yellow-50 px-3 py-1.5 rounded-lg border border-yellow-200 text-right">
                                                        <span className="block text-[10px] text-yellow-700 font-bold uppercase">우승마 평균기록</span>
                                                        <span className="text-lg sm:text-xl font-black text-yellow-900 font-mono tracking-tight flex items-center gap-1 justify-end">
                                                            <Timer size={16} className="sm:w-[18px] sm:h-[18px]"/> {currentEasyRace.avgRecord}
                                                        </span>
                                                    </div>
                                                ) : (
                                                    <div className="text-xs text-gray-400 text-right">
                                                        Easy Race 데이터 없음
                                                    </div>
                                                )}
                                            </div>

                                            {currentExpertPick && (
                                                <div className="bg-gradient-to-r from-orange-50 to-amber-50 p-2 rounded-lg border border-orange-200">
                                                    <div className="flex flex-wrap items-center gap-2 text-xs">
                                                        <div className="flex items-center gap-1"><Trophy className="w-3 h-3 text-orange-600"/><span className="font-bold text-orange-800">Expert Pick:</span></div>
                                                        {currentExpertPick.recommended?.length > 0 && <span className="flex items-center gap-1"><span className="font-bold text-green-700">추천</span><span className="text-gray-700">{currentExpertPick.recommended.map((r, idx) => <span key={idx}>{idx > 0 && ', '}({r.no}){r.name}</span>)}</span></span>}
                                                        {currentExpertPick.darkHorse?.length > 0 && <span className="flex items-center gap-1"><span className="font-bold text-purple-700">복병</span><span className="text-gray-700">{currentExpertPick.darkHorse.map((d, idx) => <span key={idx}>{idx > 0 && ', '}{d}</span>)}</span></span>}
                                                        {currentExpertPick.frontRunner?.length > 0 && <span className="flex items-center gap-1"><span className="font-bold text-blue-700">선행</span><span className="text-gray-700">{currentExpertPick.frontRunner.map((f, idx) => <span key={idx}>{idx > 0 && ', '}{f}</span>)}</span></span>}
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        <div className="space-y-2">
                                            {currentRace.horses.map((horse) => {
                                                const colors = getHorseColor(horse.no);
                                                const isExpanded = expandedHorse === horse.no;
                                                const horseHistories = getHistoryForHorse(currentRace.no, horse.no);
                                                const easyInfo = currentEasyHorses ? currentEasyHorses[horse.name] : {};
                                                
                                                const isFastStart = currentStats?.fastestStart?.includes(horse.no);
                                                const isFastFinish = currentStats?.fastestFinish?.includes(horse.no);
                                                const isEasyFastStart = currentEasyRace?.analysis?.fastStart.some(h => h.no === horse.no);
                                                const isEasyFastFinish = currentEasyRace?.analysis?.fastFinish.some(h => h.no === horse.no);
                                                const bestRecord = currentStats?.bestRecords[horse.no];
                                                const isTopRating = currentStats?.topRating?.includes(horse.no);
                                                const isTopTraining = currentStats?.topTraining?.includes(horse.no);
                                                
                                                const lastRace = horseHistories.length > 0 ? horseHistories[0] : null;
                                                const normalizeJockeyName = (name) => name?.replace(/\([^)]*\)/g, '').replace(/\s/g, '');
                                                const cleanCurrentJockey = normalizeJockeyName(horse.jockey);
                                                const cleanLastJockey = normalizeJockeyName(lastRace?.jockey);
                                                const isJockeyChanged = lastRace && cleanLastJockey && cleanCurrentJockey !== cleanLastJockey;
                                                const isSuperFast = bestRecord && currentEasyRace?.avgRecord && timeToSeconds(bestRecord) < timeToSeconds(currentEasyRace.avgRecord);

                                                const expertHorseComment = currentExpertPick?.horseComments?.[horse.no];
                                                const isRecommended = currentExpertPick?.recommended?.some(r => r.no === horse.no);
                                                const isDarkHorse = currentExpertPick?.darkHorse?.includes(horse.no);
                                                const isFrontRunner = currentExpertPick?.frontRunner?.includes(horse.no);

                                                let gradeChangeInfo = null;
                                                const lastRaceGrade = lastRace?.grade;
                                                const raceInfoString = currentRace.conditions || currentRace.info;

                                                if (raceInfoString && horse.horseGrade) {
                                                    const raceGradeMatch = raceInfoString.match(/(\d+)등급/) || raceInfoString.match(/(\d+)/);
                                                    const horseGradeMatch = horse.horseGrade.match(/(\d+)/);
                                                    const lastRaceGradeMatch = lastRaceGrade && !lastRaceGrade.includes('주행') && lastRaceGrade.trim() !== '-' ? lastRaceGrade.match(/(\d+)/) : null;
                                                    
                                                    if (raceGradeMatch && horseGradeMatch) {
                                                        const raceGradeNum = parseInt(raceGradeMatch[1]);
                                                        const horseGradeNum = parseInt(horseGradeMatch[1]);
                                                        
                                                        if (horseGradeNum > raceGradeNum) gradeChangeInfo = { type: 'jump', text: '점핑출전' };
                                                        else if (horseGradeNum < raceGradeNum) gradeChangeInfo = { type: 'down', text: '강급' };
                                                        else if (horseGradeNum === raceGradeNum) {
                                                            if (lastRaceGradeMatch && parseInt(lastRaceGradeMatch[1]) > raceGradeNum) gradeChangeInfo = { type: 'up', text: '승급전' };
                                                            else if (lastRaceGrade && (lastRaceGrade.includes('주행') || lastRaceGrade.trim() === '-')) gradeChangeInfo = { type: 'new', text: '전적진입' };
                                                        }
                                                    }
                                                }

                                                return (
                                                    <Card key={horse.no} className={`transition-all duration-200 ${isExpanded ? 'ring-2 ring-blue-500 shadow-md' : 'hover:shadow'}`}>
                                                        <div className="p-3 flex items-start sm:items-center cursor-pointer relative" onClick={() => setExpandedHorse(isExpanded ? null : horse.no)}>
                                                            <div className="flex flex-col items-center mr-3 mt-1 sm:mt-0 min-w-[3rem]">
                                                                <div className={`w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full shadow-inner font-black text-xl sm:text-2xl ${colors.bg} ${colors.text} mb-1`}>{horse.no}</div>
                                                                <span className={`text-[10px] font-bold flex items-center gap-0.5 ${isTopRating ? 'text-blue-600 bg-blue-50 px-1 rounded ring-1 ring-blue-200 shadow-sm' : 'text-gray-400'}`}>{horse.rating ? `R${horse.rating}` : '-'}{isTopRating && <Crown size={10} className="fill-current"/>}</span>
                                                            </div>

                                                            <div className="flex-1 min-w-0">
                                                                <div className="flex flex-wrap items-center gap-2 mb-1">
                                                                    <h3 className="text-lg font-bold text-gray-900 leading-none">{horse.name}</h3>
                                                                    {gradeChangeInfo && <Badge color={gradeChangeInfo.type === 'jump' ? 'purple' : gradeChangeInfo.type === 'up' ? 'red' : gradeChangeInfo.type === 'new' ? 'green' : 'teal'} className="animate-pulse">{gradeChangeInfo.text}</Badge>}
                                                                    {isRecommended && <Badge color="green"><Trophy size={10}/> 추천</Badge>}
                                                                    {isDarkHorse && <Badge color="purple"><Flame size={10}/> 복병</Badge>}
                                                                    {isFrontRunner && <Badge color="blue"><Rocket size={10}/> 선행</Badge>}
                                                                    {(isFastStart || isEasyFastStart) && <Badge color="red"><Rocket size={10}/> 초반빠름</Badge>}
                                                                    {(isFastFinish || isEasyFastFinish) && <Badge color="blue"><Zap size={10}/> 후반빠름</Badge>}
                                                                    {Math.abs(parseInt(horse.weightDiff || 0)) >= 10 && <Badge color="orange"><Scale size={10}/> 체중{horse.weightDiff}</Badge>}
                                                                </div>

                                                                <div className="flex flex-wrap text-xs text-gray-500 gap-x-3 gap-y-1 mb-1 items-center">
                                                                    <span className={`flex items-center gap-1 font-medium px-1.5 py-0.5 rounded transition-all ${isJockeyChanged ? 'bg-red-50 text-red-700 ring-1 ring-red-200 font-bold shadow-sm' : 'text-gray-700'}`}><User size={12}/> {horse.jockey}{isJockeyChanged && <span className="text-[9px] bg-white text-red-600 border border-red-200 px-0.5 rounded flex items-center"><Repeat size={8} className="mr-0.5"/>교체</span>}</span>
                                                                    <span className="text-gray-400">({horse.trainer})</span>
                                                                    <span className="w-px h-3 bg-gray-300"></span>
                                                                    <span className="flex items-center gap-1">{horse.weight}kg{horse.weightDiff !== '0' && <span className={horse.weightDiff.includes('-') ? 'text-blue-600' : 'text-red-500'}>({horse.weightDiff})</span>}</span>
                                                                    <span className="w-px h-3 bg-gray-300"></span>
                                                                    <span className="text-gray-600 font-medium bg-gray-50 px-1.5 py-0.5 rounded border border-gray-100">{horse.origin}/{horse.sex}/{horse.age}세{horse.horseGrade && ` (${horse.horseGrade})`}</span>
                                                                </div>

                                                                <div className="flex flex-wrap gap-2 mt-1 items-center">
                                                                    <span className={`flex items-center gap-1 text-[10px] sm:text-xs font-medium px-1.5 py-0.5 rounded transition-all ${isTopTraining ? 'bg-orange-100 text-orange-800 ring-1 ring-orange-200 shadow-sm' : 'bg-slate-100 text-slate-700'}`}><Activity size={10}/> {horse.trainingCount}회{isTopTraining && <span className="text-[9px] font-black bg-white px-0.5 rounded text-orange-600 border border-orange-200">TOP</span>}<span className={isTopTraining ? "text-orange-300" : "text-gray-400"}>/</span> {horse.cycle || '-'}</span>
                                                                    {bestRecord ? <div className={`text-[10px] sm:text-xs px-2 py-0.5 rounded font-mono font-bold flex items-center gap-1 border ${isSuperFast ? 'bg-yellow-100 text-yellow-800 border-yellow-300' : 'bg-gray-100 text-gray-600 border-gray-200'}`}><Medal size={10}/> {currentRace.distance} Best: {bestRecord}</div> : <span className="text-[10px] text-gray-400 self-center">해당 거리 기록 없음</span>}
                                                                    {(easyInfo?.stats) && <div className="text-[10px] sm:text-xs bg-purple-50 text-purple-800 px-2 py-0.5 rounded font-medium border border-purple-100 flex items-center">{cleanText(easyInfo.stats)}</div>}
                                                                </div>
                                                            </div>
                                                            <div className="absolute top-3 right-3 sm:static">{isExpanded ? <ChevronUp className="text-gray-300"/> : <ChevronDown className="text-gray-300"/>}</div>
                                                        </div>

                                                        {isExpanded && (
                                                            <div className="bg-slate-50 border-t border-gray-200 p-4 text-sm animate-in slide-in-from-top-1">
                                                                {isJockeyChanged && <div className="mb-3 flex items-center text-xs text-red-600 bg-red-50 p-2 rounded border border-red-100"><AlertTriangle size={12} className="mr-1.5"/><span><b>기수 변경 감지:</b> 직전 경주({lastRace.date})에서는 <span className="font-bold underline ml-1">{lastRace.jockey}</span> 기수가 기승했습니다.</span></div>}
                                                                {easyInfo?.note && <div className="mb-4 bg-white p-3 rounded border-l-4 border-purple-500 shadow-sm"><h4 className="text-xs font-bold text-purple-700 uppercase mb-1 flex items-center gap-1"><Info size={12}/> Easy Race 분석</h4><p className="text-gray-700 text-xs sm:text-sm">{cleanText(easyInfo.note)}</p></div>}
                                                                {expertHorseComment && <div className="mb-4 bg-gradient-to-r from-orange-50 to-amber-50 p-3 rounded border-l-4 border-orange-500 shadow-sm"><h4 className="text-xs font-bold text-orange-700 uppercase mb-1 flex items-center gap-1"><Trophy size={12}/> Expert Pick 분석</h4><p className="text-gray-700 text-xs sm:text-sm leading-relaxed">{cleanText(expertHorseComment.comment)}</p></div>}
                                                                <div className="grid grid-cols-2 gap-3 mb-4 text-xs">
                                                                    <div className="bg-white p-2 rounded border border-gray-100"><span className="text-gray-400 block mb-0.5">부마</span><span className="font-semibold">{horse.sire || '-'}</span></div>
                                                                    <div className="bg-white p-2 rounded border border-gray-100"><span className="text-gray-400 block mb-0.5">장구현황</span><span className="font-semibold truncate">{horse.equipment || '-'}</span></div>
                                                                </div>
                                                                <h4 className="font-bold text-gray-700 mb-2 text-xs uppercase tracking-wider flex items-center gap-1"><Calendar size={14}/> 최근 전적</h4>
                                                                {horseHistories.length > 0 ? (
                                                                    <div className="overflow-x-auto rounded border border-gray-200">
                                                                        <table className="w-full text-xs text-center whitespace-nowrap bg-white">
                                                                            <thead className="bg-gray-100 text-gray-600 font-semibold"><tr><th className="p-2 border-b">일자</th><th className="p-2 border-b">등급</th><th className="p-2 border-b">거리</th><th className="p-2 border-b">기록</th><th className="p-2 border-b">순위</th><th className="p-2 border-b">기수</th><th className="p-2 border-b">부중</th><th className="p-2 border-b text-red-500">S-1F</th><th className="p-2 border-b text-yellow-600">G-3F</th><th className="p-2 border-b text-blue-500">G-1F</th><th className="p-2 border-b">체중</th></tr></thead>
                                                                            <tbody>{horseHistories.map((h, idx) => {
                                                                                const rankNum = parseInt(h.rank?.split('/')[0]);
                                                                                const rankClass = rankNum === 1 ? 'bg-yellow-100 text-yellow-800 font-bold' : rankNum === 2 ? 'bg-gray-100 text-gray-800 font-bold' : rankNum === 3 ? 'bg-orange-100 text-orange-800 font-bold' : '';
                                                                                const distClass = h.distance == currentRace.distance?.replace('M','') ? 'bg-blue-50 font-bold text-blue-900' : '';
                                                                                return (<tr key={idx} className="hover:bg-gray-50 border-b last:border-0"><td className="p-2 text-gray-600">{h.date}</td><td className="p-2">{h.grade}</td><td className={`p-2 ${distClass}`}>{h.distance}</td><td className={`p-2 font-mono ${distClass}`}>{h.record}</td><td className={`p-2 ${rankClass}`}>{h.rank}</td><td className="p-2 text-gray-600">{h.jockey}</td><td className="p-2 text-gray-800 font-medium">{h.weight}</td><td className="p-2 text-gray-500">{h.s1f}</td><td className="p-2 text-yellow-700">{h.g3f}</td><td className="p-2 text-gray-500">{h.g1f}</td><td className="p-2 text-gray-400">{h.runningWeight}</td></tr>);
                                                                            })}</tbody>
                                                                        </table>
                                                                    </div>
                                                                ) : <div className="text-center py-4 text-gray-400 bg-white rounded border border-gray-200">상세 전적 없음</div>}
                                                            </div>
                                                        )}
                                                    </Card>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RaceCardApp />);
    </script>
</body>
</html>
