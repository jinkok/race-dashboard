<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²½ë§ˆ ë‹¨ìŠ¹ ë°°ë‹¹ë¥  ì…ë ¥ê¸° (ì›ë³¸ì²¨ë¶€ ëª¨ë“œ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .step-card { transition: all 0.3s ease-in-out; }
        .hidden { display: none; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden">
            <header class="bg-blue-700 text-white p-6">
                <h1 class="text-2xl sm:text-3xl font-bold text-center">ì¶œì „í‘œ ë°°ë‹¹ë¥  ì¶”ê°€ ì…ë ¥ê¸°</h1>
                <p class="text-center text-blue-200 mt-2">ì›ë³¸ ì¶œì „í‘œì— ë°°ë‹¹ë¥  ì»¬ëŸ¼ì„ ì¶”ê°€í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.</p>
            </header>

            <main class="p-6 space-y-8">
                <!-- Step 1: Upload Chuljeonpyo -->
                <section id="step1" class="step-card bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <div class="flex items-center mb-4">
                        <span class="flex items-center justify-center w-8 h-8 bg-blue-600 text-white rounded-full font-bold text-lg mr-4">1</span>
                        <h2 class="text-xl font-bold text-gray-800">'ì¶œì „í‘œ' íŒŒì¼ ì—…ë¡œë“œ</h2>
                    </div>
                    <p class="text-gray-600 mb-4 text-sm">ë°°ë‹¹ë¥ ì„ ì¶”ê°€í•  ê²½ì£¼ì˜ 'ì¶œì „í‘œ.csv' íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                    <div>
                        <label for="chuljeonpyo-file" class="block text-sm font-medium text-gray-700">ì¶œì „í‘œ.csv</label>
                        <input type="file" id="chuljeonpyo-file" accept=".csv" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    </div>
                    <div id="file-status" class="mt-4 text-sm text-center"></div>
                    <div class="mt-6 text-center">
                        <button id="load-horses-btn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            ì¶œì „ë§ˆ ë¶ˆëŸ¬ì˜¤ê¸°
                        </button>
                    </div>
                </section>

                <!-- Step 2: Input Data (Hidden Initially) -->
                <section id="step2" class="step-card bg-gray-50 p-6 rounded-lg border border-gray-200 hidden">
                    <div class="flex items-center mb-4">
                        <span class="flex items-center justify-center w-8 h-8 bg-blue-600 text-white rounded-full font-bold text-lg mr-4">2</span>
                        <h2 class="text-xl font-bold text-gray-800">ì •ë³´ ì…ë ¥</h2>
                    </div>
                    
                    <!-- í•¨ìˆ˜ìœ¨ ì…ë ¥ ì„¹ì…˜ -->
                    <div class="mb-8 p-4 bg-indigo-50 rounded-lg border border-indigo-100">
                        <label for="moisture-content" class="block text-sm font-bold text-gray-700 mb-2">ğŸ“¢ ì£¼ë¡œ í•¨ìˆ˜ìœ¨ (%)</label>
                        <div class="flex items-center">
                            <div class="relative rounded-md shadow-sm w-full sm:w-1/3">
                                <input type="number" id="moisture-content" placeholder="ì˜ˆ: 3" class="block w-full rounded-md border-gray-300 pl-3 pr-12 py-3 focus:border-blue-500 focus:ring-blue-500 sm:text-lg border text-right font-bold text-indigo-800">
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                                    <span class="text-gray-500 font-bold">%</span>
                                </div>
                            </div>
                            <span class="ml-3 text-sm text-gray-500">ì €ì¥ë  íŒŒì¼ëª…ì— í¬í•¨ë©ë‹ˆë‹¤.</span>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 my-6"></div>

                    <p class="text-gray-600 mb-4 text-sm font-medium">ê° ë§ì˜ ë‹¨ìŠ¹ ë°°ë‹¹ë¥ ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
                    
                    <!-- ë§ ì •ë³´ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
                    <div id="horse-data-list" class="space-y-3">
                        <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ê°€ ì´ ê³³ì— ë§ ì •ë³´ ì¹´ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. -->
                    </div>
                </section>

                <!-- Step 3: Download CSV (Hidden Initially) -->
                <section id="step3" class="text-center hidden pt-4">
                     <button id="generate-csv-btn" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-16 rounded-lg shadow-xl text-lg transition-transform transform hover:scale-105">
                        ì›ë³¸ íŒŒì¼ì— ë°°ë‹¹ ì¶”ê°€í•˜ì—¬ ì €ì¥
                    </button>
                </section>
            </main>
        </div>
        <footer class="text-center mt-6 text-sm text-gray-500">
            <p>&copy; 2025 Race Day Odds Generator.</p>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const fileInput = document.getElementById('chuljeonpyo-file');
        const loadHorsesBtn = document.getElementById('load-horses-btn');
        const generateCsvBtn = document.getElementById('generate-csv-btn');
        const fileStatusDiv = document.getElementById('file-status');
        const horseDataList = document.getElementById('horse-data-list');
        const step2Section = document.getElementById('step2');
        const step3Section = document.getElementById('step3');
        const moistureInput = document.getElementById('moisture-content');

        // ì›ë³¸ ë°ì´í„°ë¥¼ ì €ì¥í•  ë³€ìˆ˜
        let originalData = [];
        // í™”ë©´ í‘œì‹œìš© ê°„ì†Œí™” ë°ì´í„°
        let displayData = [];
        let baseFileName = 'ê²½ì£¼';

        loadHorsesBtn.addEventListener('click', () => {
            if (fileInput.files.length === 0) {
                fileStatusDiv.innerHTML = `<p class="text-red-500 font-semibold">ì˜¤ë¥˜: 'ì¶œì „í‘œ.csv' íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>`;
                return;
            }

            const file = fileInput.files[0];

            // íŒŒì¼ëª… ì²˜ë¦¬
            const originalFileName = file.name;
            const underscoreIndex = originalFileName.lastIndexOf('_');
            
            if (underscoreIndex !== -1) {
                baseFileName = originalFileName.substring(0, underscoreIndex).trim();
            } else {
                baseFileName = originalFileName.replace(/\.csv$/i, '');
            }

            fileStatusDiv.innerHTML = `<div class="flex items-center justify-center"><div class="loader mr-2"></div><p class="text-blue-600 font-semibold">íŒŒì¼ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p></div>`;

            Papa.parse(file, {
                skipEmptyLines: true,
                // í—¤ë”ê°€ ë‚˜ì˜¬ ë•Œê¹Œì§€ ì•ë¶€ë¶„ ê±´ë„ˆë›°ëŠ” ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼)
                beforeFirstChunk: (chunk) => {
                    const lines = chunk.split('\n');
                    const headerIndex = lines.findIndex(line => line.includes('ë²ˆí˜¸â–²') && line.includes('ë§ˆëª…'));
                    if (headerIndex > -1) {
                        return lines.slice(headerIndex).join('\n');
                    }
                    return chunk;
                },
                header: true,
                complete: (results) => {
                    if (results.errors.length > 0) {
                        fileStatusDiv.innerHTML = `<p class="text-red-500 font-semibold">íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: ${results.errors[0].message}</p>`;
                        return;
                    }
                    
                    // [í•µì‹¬ ë³€ê²½] ì›ë³¸ ë°ì´í„°ë¥¼ í†µì§¸ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
                    originalData = results.data;

                    // í™”ë©´ í‘œì‹œë¥¼ ìœ„í•´ í•„ìš”í•œ ì •ë³´ë§Œ ì¶”ì¶œ (í•„í„°ë§)
                    displayData = originalData.map(row => ({
                        number: row['ë²ˆí˜¸â–²'],
                        name: row['ë§ˆëª…']
                    })).filter(h => h.number && h.name);

                    if (displayData.length === 0) {
                         fileStatusDiv.innerHTML = `<p class="text-red-500 font-semibold">ì˜¤ë¥˜: ì¶œì „ë§ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>`;
                         return;
                    }

                    populateHorseCards();
                    
                    fileStatusDiv.innerHTML = `<p class="text-green-600 font-semibold">âœ… ${displayData.length}ë§ˆì˜ ì¶œì „ë§ˆë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.</p>`;
                    step2Section.classList.remove('hidden');
                    step3Section.classList.remove('hidden');
                    
                    setTimeout(() => moistureInput.focus(), 100);
                },
                error: (err) => {
                    fileStatusDiv.innerHTML = `<p class="text-red-500 font-semibold">íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: ${err.message}</p>`;
                }
            });
        });

        function populateHorseCards() {
            horseDataList.innerHTML = ''; 
            
            displayData.forEach(horse => {
                const card = `
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200 flex items-center justify-between">
                        <div class="flex items-center flex-1">
                            <span class="flex-shrink-0 flex items-center justify-center w-10 h-10 bg-blue-100 text-blue-800 rounded-full font-bold text-lg">${horse.number}</span>
                            <span class="ml-3 text-lg font-semibold text-gray-900 truncate">${horse.name}</span>
                        </div>

                        <div class="flex-shrink-0 w-32 sm:w-40">
                            <div class="relative rounded-md shadow-sm">
                                <input type="number" step="0.1" name="odds" id="odds-${horse.number}" data-horse-number="${horse.number}" placeholder="ë°°ë‹¹ë¥ " class="block w-full rounded-md border-gray-300 pl-3 pr-12 py-2 focus:border-blue-500 focus:ring-blue-500 sm:text-sm border bg-yellow-50 text-right font-bold">
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                                    <span class="text-gray-500 sm:text-sm">ë°°</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                horseDataList.insertAdjacentHTML('beforeend', card);
            });
        }

        generateCsvBtn.addEventListener('click', () => {
            const moistureValue = moistureInput.value.trim();

            // [í•µì‹¬ ë³€ê²½] ì›ë³¸ ë°ì´í„°ë¥¼ ìˆœíšŒí•˜ë©° ë°°ë‹¹ë¥  ì»¬ëŸ¼ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
            const updatedCsvData = originalData.map(row => {
                // í˜„ì¬ í–‰(row)ì˜ ë§ ë²ˆí˜¸ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
                const horseNumber = row['ë²ˆí˜¸â–²'];
                
                // í•´ë‹¹ ë²ˆí˜¸ì— ì…ë ¥ëœ ë°°ë‹¹ë¥  ê°’ì„ ì°¾ìŠµë‹ˆë‹¤.
                let oddsValue = '';
                if (horseNumber) {
                    const oddsInput = document.querySelector(`input[name="odds"][data-horse-number="${horseNumber}"]`);
                    if (oddsInput) {
                        oddsValue = oddsInput.value;
                    }
                }

                // ê¸°ì¡´ í–‰ ë°ì´í„°(row)ë¥¼ ë³µì‚¬(...)í•˜ê³  'ë‹¨ìŠ¹ë°°ë‹¹ë¥ ' í‚¤ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
                return {
                    ...row,
                    'ë‹¨ìŠ¹ë°°ë‹¹ë¥ ': oddsValue
                };
            });

            // CSV ë¬¸ìì—´ë¡œ ë³€í™˜
            const csvString = Papa.unparse(updatedCsvData);
            
            // íŒŒì¼ëª… ìƒì„±
            let fileName = `${baseFileName}_ë‹¨ìŠ¹ë°°ë‹¹í¬í•¨`;
            if (moistureValue) {
                fileName += `_í•¨ìˆ˜ìœ¨${moistureValue}%`;
            }
            fileName += '.csv';

            downloadCsv(csvString, fileName);
        });

        function downloadCsv(csvString, fileName) {
            // í•œê¸€ ê¹¨ì§ ë°©ì§€ë¥¼ ìœ„í•´ BOM(\uFEFF) ì¶”ê°€
            const blob = new Blob([`\uFEFF${csvString}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    });
    </script>

</body>
</html>
