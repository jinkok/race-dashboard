<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²½ë§ˆ ë°ì´í„° í†µí•© ì…ë ¥ê¸° (ë°°ë‹¹ë¥ /ì²´ì¤‘)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .hidden { display: none; }
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .custom-table th { background-color: #f3f4f6; position: sticky; top: 0; z-index: 10; }
        .custom-table td { vertical-align: middle; }
        /* íƒ­ í™œì„±í™” ìŠ¤íƒ€ì¼ */
        .tab-active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .tab-inactive { background-color: white; color: #4b5563; border-color: #e5e7eb; }
        .tab-inactive:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

    <div class="max-w-5xl mx-auto p-4 md:p-6">
        <!-- í—¤ë” -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ‡ ê²½ë§ˆ ë°ì´í„° í†µí•© ì…ë ¥ê¸°</h1>
            <p class="text-gray-600">ì‘ì—…í•˜ì‹¤ ë‚´ìš©ì„ ì•„ë˜ íƒ­ì—ì„œ ì„ íƒí•˜ì„¸ìš”.</p>
        </div>

        <!-- íƒ­ ë©”ë‰´ -->
        <div class="flex mb-6 border-b-2 border-gray-200">
            <button id="tabOdds" class="flex-1 py-3 px-6 text-lg font-bold border-b-2 rounded-t-lg transition-colors tab-active">
                â‘  ë°°ë‹¹ë¥  ì…ë ¥ (ì¶œì „í‘œ)
            </button>
            <button id="tabWeight" class="flex-1 py-3 px-6 text-lg font-bold border-b-2 rounded-t-lg transition-colors tab-inactive">
                â‘¡ ì²´ì¤‘ ì…ë ¥ (ì²´ì¤‘í˜„í™©)
            </button>
        </div>

        <!-- ========================================== -->
        <!-- [View 1] ë°°ë‹¹ë¥  ì…ë ¥ í˜ì´ì§€ -->
        <!-- ========================================== -->
        <div id="viewOdds" class="block">
            <!-- Step 1: íŒŒì¼ ì—…ë¡œë“œ -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-bold mb-4 text-blue-700 flex items-center">
                    <span class="bg-blue-100 text-blue-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm border border-blue-200">1</span>
                    ì¶œì „í‘œ íŒŒì¼ ì—…ë¡œë“œ
                </h2>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors bg-gray-50">
                    <input type="file" id="oddsFileInput" accept=".csv" class="hidden">
                    <label for="oddsFileInput" class="cursor-pointer block">
                        <span class="block text-lg font-medium text-gray-700 mb-1">ì¶œì „í‘œ CSV ì„ íƒ</span>
                        <span class="text-sm text-gray-400">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</span>
                    </label>
                    <div id="oddsFileName" class="mt-2 text-sm font-semibold text-blue-600 hidden"></div>
                </div>
            </div>

            <!-- Step 2: ë°ì´í„° ì…ë ¥ -->
            <div id="oddsStep2" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-blue-700 flex items-center">
                        <span class="bg-blue-100 text-blue-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm border border-blue-200">2</span>
                        ë°°ë‹¹ë¥  ë° í•¨ìˆ˜ìœ¨
                    </h2>
                    <div class="flex items-center space-x-2">
                        <label for="moistureInput" class="font-bold text-gray-700">í•¨ìˆ˜ìœ¨(%):</label>
                        <input type="number" id="moistureInput" placeholder="3" class="border border-gray-300 rounded px-3 py-1 w-20 text-right focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>

                <div class="overflow-x-auto bg-white border border-gray-200 rounded-lg max-h-[500px] overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200 custom-table text-sm">
                        <thead>
                            <tr>
                                <th class="px-4 py-3 text-center font-bold text-gray-600 w-16">ë²ˆí˜¸</th>
                                <th class="px-4 py-3 text-left font-bold text-gray-600">ë§ˆëª…</th>
                                <th class="px-4 py-3 text-center font-bold text-gray-600">ê¸°ìˆ˜</th>
                                <th class="px-4 py-3 text-center font-bold text-blue-600 w-32">ë‹¨ìŠ¹ ë°°ë‹¹ë¥ </th>
                            </tr>
                        </thead>
                        <tbody id="oddsTableBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <!-- Step 3: ë‹¤ìš´ë¡œë“œ -->
            <div id="oddsStep3" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <button id="oddsDownloadBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    ë°°ë‹¹ë¥  í¬í•¨ CSV ì €ì¥
                </button>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- [View 2] ì²´ì¤‘ ì…ë ¥ í˜ì´ì§€ -->
        <!-- ========================================== -->
        <div id="viewWeight" class="hidden">
            <!-- Step 1: íŒŒì¼ ì—…ë¡œë“œ -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-bold mb-4 text-green-700 flex items-center">
                    <span class="bg-green-100 text-green-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm border border-green-200">1</span>
                    ì²´ì¤‘í˜„í™© íŒŒì¼ ì—…ë¡œë“œ
                </h2>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-green-500 transition-colors bg-gray-50">
                    <input type="file" id="weightFileInput" accept=".csv" class="hidden">
                    <label for="weightFileInput" class="cursor-pointer block">
                        <span class="block text-lg font-medium text-gray-700 mb-1">ì²´ì¤‘í˜„í™© CSV ì„ íƒ</span>
                        <span class="text-sm text-gray-400">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</span>
                    </label>
                    <div id="weightFileName" class="mt-2 text-sm font-semibold text-green-600 hidden"></div>
                </div>
            </div>

            <!-- Step 2: ë°ì´í„° ì…ë ¥ -->
            <div id="weightStep2" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <h2 class="text-xl font-bold mb-4 text-green-700 flex items-center">
                    <span class="bg-green-100 text-green-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm border border-green-200">2</span>
                    ì²´ì¤‘ ë° ì¦ê° ì…ë ¥
                </h2>

                <div class="overflow-x-auto bg-white border border-gray-200 rounded-lg max-h-[500px] overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200 custom-table text-sm">
                        <thead>
                            <tr>
                                <th class="px-4 py-3 text-center font-bold text-gray-600 w-16">ë²ˆí˜¸</th>
                                <th class="px-4 py-3 text-left font-bold text-gray-600">ë§ˆëª…</th>
                                <th class="px-4 py-3 text-center font-bold text-green-700 w-32">ê¸ˆì¼ì²´ì¤‘</th>
                                <th class="px-4 py-3 text-center font-bold text-red-600 w-32">ì¦ê°(+/-)</th>
                            </tr>
                        </thead>
                        <tbody id="weightTableBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <!-- Step 3: ë‹¤ìš´ë¡œë“œ -->
            <div id="weightStep3" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <button id="weightDownloadBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    ì²´ì¤‘/ì¦ê° í¬í•¨ CSV ì €ì¥
                </button>
            </div>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- íƒ­ ì „í™˜ ë¡œì§ ---
        const tabOdds = document.getElementById('tabOdds');
        const tabWeight = document.getElementById('tabWeight');
        const viewOdds = document.getElementById('viewOdds');
        const viewWeight = document.getElementById('viewWeight');

        function switchTab(mode) {
            if (mode === 'odds') {
                viewOdds.classList.remove('hidden');
                viewWeight.classList.add('hidden');
                tabOdds.className = "flex-1 py-3 px-6 text-lg font-bold border-b-2 rounded-t-lg transition-colors tab-active";
                tabWeight.className = "flex-1 py-3 px-6 text-lg font-bold border-b-2 rounded-t-lg transition-colors tab-inactive";
            } else {
                viewOdds.classList.add('hidden');
                viewWeight.classList.remove('hidden');
                tabOdds.className = "flex-1 py-3 px-6 text-lg font-bold border-b-2 rounded-t-lg transition-colors tab-inactive";
                tabWeight.className = "flex-1 py-3 px-6 text-lg font-bold border-b-2 rounded-t-lg transition-colors tab-active";
            }
        }

        tabOdds.addEventListener('click', () => switchTab('odds'));
        tabWeight.addEventListener('click', () => switchTab('weight'));


        // ==========================================
        // [ë¡œì§ 1] ë°°ë‹¹ë¥  ì…ë ¥ ê´€ë ¨
        // ==========================================
        let oddsData = {
            meta: [], header: [], rows: [], fileName: "", headerIndex: 0
        };

        const oddsFileInput = document.getElementById('oddsFileInput');
        const oddsTableBody = document.getElementById('oddsTableBody');
        
        oddsFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('oddsFileName').textContent = file.name;
            document.getElementById('oddsFileName').classList.remove('hidden');
            oddsData.fileName = file.name.replace('.csv', '');

            const reader = new FileReader();
            reader.onload = function(evt) {
                const lines = evt.target.result.split(/\r\n|\n/);
                // "ë²ˆí˜¸"ì™€ "ë§ˆëª…"ì´ ìˆëŠ” ì¤„ ì°¾ê¸°
                let hIndex = lines.findIndex(l => (l.includes('ë²ˆí˜¸') || l.includes('No')) && l.includes('ë§ˆëª…'));
                if(hIndex === -1) hIndex = 0;

                oddsData.headerIndex = hIndex;
                oddsData.meta = lines.slice(0, hIndex);
                
                const dataPart = lines.slice(hIndex).join('\n');
                Papa.parse(dataPart, {
                    header: true, skipEmptyLines: true,
                    complete: function(res) {
                        oddsData.header = res.meta.fields;
                        oddsData.rows = res.data;
                        renderOddsTable(oddsData.rows);
                        document.getElementById('oddsStep2').classList.remove('hidden');
                        document.getElementById('oddsStep3').classList.remove('hidden');
                    }
                });
            };
            reader.readAsText(file, 'UTF-8');
        });

        function renderOddsTable(rows) {
            oddsTableBody.innerHTML = '';
            rows.forEach((row, idx) => {
                const numKey = Object.keys(row).find(k => k.includes('ë²ˆí˜¸'));
                const nameKey = Object.keys(row).find(k => k.includes('ë§ˆëª…'));
                const jockeyKey = Object.keys(row).find(k => k.includes('ê¸°ìˆ˜'));

                const num = row[numKey] || (idx+1);
                const name = row[nameKey] || '';
                const jockey = row[jockeyKey] || '';
                if(!name && !num) return;

                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition-colors";
                tr.innerHTML = `
                    <td class="px-4 py-2 text-center font-bold text-gray-700">${num}</td>
                    <td class="px-4 py-2 text-gray-800 font-medium">${name}</td>
                    <td class="px-4 py-2 text-center text-gray-600 text-sm">${jockey}</td>
                    <td class="px-4 py-2 text-center">
                        <input type="number" step="0.1" data-id="${num}" class="odds-input w-24 text-center border border-gray-300 rounded p-1 font-bold text-blue-700 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0.0">
                    </td>
                `;
                oddsTableBody.appendChild(tr);
            });
        }

        document.getElementById('oddsDownloadBtn').addEventListener('click', () => {
            const moisture = document.getElementById('moistureInput').value.trim();
            const inputs = document.querySelectorAll('.odds-input');
            const map = {};
            inputs.forEach(inp => map[inp.dataset.id] = inp.value);

            const newRows = oddsData.rows.map(row => {
                const numKey = Object.keys(row).find(k => k.includes('ë²ˆí˜¸'));
                return { ...row, 'ë‹¨ìŠ¹ë°°ë‹¹ë¥ ': map[row[numKey]] || '' };
            });

            const csvBody = Papa.unparse(newRows, { quotes: false, columns: [...oddsData.header, 'ë‹¨ìŠ¹ë°°ë‹¹ë¥ '] });
            const metaStr = oddsData.meta.length > 0 ? oddsData.meta.join('\n') + '\n' : '';
            
            let fname = `${oddsData.fileName}_ë‹¨ìŠ¹ë°°ë‹¹`;
            if(moisture) fname += `_í•¨ìˆ˜ìœ¨${moisture}%`;
            downloadFile(metaStr + csvBody, fname + '.csv');
        });


        // ==========================================
        // [ë¡œì§ 2] ì²´ì¤‘ ì…ë ¥ ê´€ë ¨
        // ==========================================
        let weightData = {
            meta: [], header: [], rows: [], fileName: "", headerIndex: 0
        };

        const weightFileInput = document.getElementById('weightFileInput');
        const weightTableBody = document.getElementById('weightTableBody');

        weightFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('weightFileName').textContent = file.name;
            document.getElementById('weightFileName').classList.remove('hidden');
            weightData.fileName = file.name.replace('.csv', '');

            const reader = new FileReader();
            reader.onload = function(evt) {
                const lines = evt.target.result.split(/\r\n|\n/);
                let hIndex = lines.findIndex(l => (l.includes('ë²ˆí˜¸') || l.includes('No')) && l.includes('ë§ˆëª…'));
                if(hIndex === -1) hIndex = 0;

                weightData.headerIndex = hIndex;
                weightData.meta = lines.slice(0, hIndex);

                const dataPart = lines.slice(hIndex).join('\n');
                Papa.parse(dataPart, {
                    header: true, skipEmptyLines: true,
                    complete: function(res) {
                        weightData.header = res.meta.fields;
                        weightData.rows = res.data;
                        renderWeightTable(weightData.rows);
                        document.getElementById('weightStep2').classList.remove('hidden');
                        document.getElementById('weightStep3').classList.remove('hidden');
                    }
                });
            };
            reader.readAsText(file, 'UTF-8');
        });

        function renderWeightTable(rows) {
            weightTableBody.innerHTML = '';
            rows.forEach((row, idx) => {
                const numKey = Object.keys(row).find(k => k.includes('ë²ˆí˜¸'));
                const nameKey = Object.keys(row).find(k => k.includes('ë§ˆëª…'));
                
                // ê¸°ì¡´ ê°’ ë¶ˆëŸ¬ì˜¤ê¸° (CSVì— ì´ë¯¸ ê°’ì´ ìˆì„ ê²½ìš°)
                const weightKey = Object.keys(row).find(k => k.includes('ì²´ì¤‘') && !k.includes('ì¦ê°')); // 'ê¸ˆì¼ì²´ì¤‘' ë“±
                const changeKey = Object.keys(row).find(k => k.includes('ì¦ê°'));

                const num = row[numKey] || (idx+1);
                const name = row[nameKey] || '';
                if(!name && !num) return;

                const currentWeight = row[weightKey] || '';
                const currentChange = row[changeKey] || '';

                const tr = document.createElement('tr');
                tr.className = "hover:bg-green-50 transition-colors";
                tr.innerHTML = `
                    <td class="px-4 py-2 text-center font-bold text-gray-700">${num}</td>
                    <td class="px-4 py-2 text-gray-800 font-medium">${name}</td>
                    <td class="px-4 py-2 text-center">
                        <input type="number" data-id="${num}" value="${currentWeight}" class="weight-val w-28 text-center border border-gray-300 rounded p-1 font-bold text-green-700 focus:ring-2 focus:ring-green-500 outline-none" placeholder="ì²´ì¤‘">
                    </td>
                    <td class="px-4 py-2 text-center">
                        <input type="number" data-id="${num}" value="${currentChange}" class="weight-chg w-24 text-center border border-gray-300 rounded p-1 font-bold text-red-600 focus:ring-2 focus:ring-red-500 outline-none" placeholder="+/-">
                    </td>
                `;
                weightTableBody.appendChild(tr);
            });
        }

        document.getElementById('weightDownloadBtn').addEventListener('click', () => {
            const wInputs = document.querySelectorAll('.weight-val');
            const cInputs = document.querySelectorAll('.weight-chg');
            
            const wMap = {};
            const cMap = {};
            
            wInputs.forEach(inp => wMap[inp.dataset.id] = inp.value);
            cInputs.forEach(inp => cMap[inp.dataset.id] = inp.value);

            const newRows = weightData.rows.map(row => {
                const numKey = Object.keys(row).find(k => k.includes('ë²ˆí˜¸'));
                const num = row[numKey];
                
                // ì›ë³¸ CSVì˜ í‚¤ ì´ë¦„ ì°¾ê¸°
                const weightKey = Object.keys(row).find(k => k.includes('ì²´ì¤‘') && !k.includes('ì¦ê°')) || 'ê¸ˆì¼ì²´ì¤‘';
                const changeKey = Object.keys(row).find(k => k.includes('ì¦ê°')) || 'ì¦ê°';

                let newRow = { ...row };
                newRow[weightKey] = wMap[num] || '';
                newRow[changeKey] = cMap[num] || '';
                return newRow;
            });

            // í—¤ë”ì— ì—†ìœ¼ë©´ ì¶”ê°€ (í˜¹ì‹œ ëª¨ë¥¼ ê²½ìš° ëŒ€ë¹„)
            let finalHeader = [...weightData.header];
            const weightKey = finalHeader.find(k => k.includes('ì²´ì¤‘') && !k.includes('ì¦ê°')) || 'ê¸ˆì¼ì²´ì¤‘';
            const changeKey = finalHeader.find(k => k.includes('ì¦ê°')) || 'ì¦ê°';
            
            if(!finalHeader.includes(weightKey)) finalHeader.push(weightKey);
            if(!finalHeader.includes(changeKey)) finalHeader.push(changeKey);

            const csvBody = Papa.unparse(newRows, { quotes: false, columns: finalHeader });
            const metaStr = weightData.meta.length > 0 ? weightData.meta.join('\n') + '\n' : '';

            downloadFile(metaStr + csvBody, `${weightData.fileName}_ì²´ì¤‘ì…ë ¥ì™„ë£Œ.csv`);
        });

        // ê³µí†µ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        function downloadFile(content, fileName) {
            const blob = new Blob(["\uFEFF" + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ (ê³µí†µ í´ë˜ìŠ¤ ì²˜ë¦¬ ë¶ˆê°€ë¡œ ê°œë³„ ì²˜ë¦¬)
        setupDragDrop('oddsFileInput', 'bg-blue-50', 'border-blue-500');
        setupDragDrop('weightFileInput', 'bg-green-50', 'border-green-500');

        function setupDragDrop(inputId, bgClass, borderClass) {
            const input = document.getElementById(inputId);
            const dropZone = input.parentElement;

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add(borderClass, bgClass);
            });
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove(borderClass, bgClass);
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove(borderClass, bgClass);
                if (e.dataTransfer.files.length > 0) {
                    input.files = e.dataTransfer.files;
                    input.dispatchEvent(new Event('change'));
                }
            });
        }
    });
    </script>
</body>
</html>
