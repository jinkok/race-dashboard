<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMART RACING PRO V9</title>
    
    <!-- 1. ÌïÑÏàò ÎùºÏù¥Î∏åÎü¨Î¶¨ (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- ÏïÑÏù¥ÏΩò -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Ïä§ÌÉÄÏùº -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700;800&display=swap');
        
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; color: #0f172a; -webkit-tap-highlight-color: transparent; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .animate-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Í∑∏ÎûòÌîÑ Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .bar-fill { animation: fillBar 1s ease-out forwards; transform-origin: left; transform: scaleX(0); }
        @keyframes fillBar { to { transform: scaleX(1); } }
        
        /* Ïà´Ïûê Îì±Ìè≠ Ìè∞Ìä∏ (Ï†ïÎ†¨Ïö©) */
        .tabular { font-variant-numeric: tabular-nums; }
        
        /* Sticky ÏÉÅÎã® Í≥†Ï†ï Ïãú Î∞∞Í≤Ω Î∏îÎü¨ Ï≤òÎ¶¨ */
        .sticky-header-blur {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            background-color: rgba(255, 255, 255, 0.95);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 2. Firebase SDK ÏÑ§Ï†ï -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVJRqmpFjR9g91AgQsJIV65_7BJ7yYEOU",
            authDomain: "race-app-3e41d.firebaseapp.com",
            projectId: "race-app-3e41d",
            storageBucket: "race-app-3e41d.firebasestorage.app",
            messagingSenderId: "232853669556",
            appId: "1:232853669556:web:f9e7c8ccfde227f50679e1",
            measurementId: "G-H6MB9KZ8M8"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            window.fb = { auth, db, doc, setDoc, onSnapshot, signInAnonymously, onAuthStateChanged, isReady: true };
            console.log("Firebase initialized");
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = ({ name, size = 16, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons({ root: ref.current, name, attrs: { width: size, height: size, class: className } });
            }, [name, className, size]);
            return <i ref={ref} data-lucide={name}></i>;
        };

        const getBadgeStyle = (no) => {
            const n = parseInt(no);
            const base = "border-2 shadow-sm box-border";
            if (n===1) return `${base} bg-white text-slate-900 border-slate-900`;
            if (n===2) return `${base} bg-yellow-400 text-slate-900 border-yellow-400`;
            if (n===3) return `${base} bg-red-600 text-white border-red-600`;
            if (n===4) return `${base} bg-slate-900 text-white border-slate-900`;
            if (n===5) return `${base} bg-blue-600 text-white border-blue-600`;
            if (n===6) return `${base} bg-green-600 text-white border-green-600`;
            if (n===7) return `${base} bg-[#8B4513] text-white border-[#8B4513]`;
            if (n===8) return `${base} bg-pink-400 text-white border-pink-400`;
            if (n===9) return `${base} bg-purple-700 text-white border-purple-700`;
            if (n===10) return `${base} bg-[#2ad0e4] text-slate-900 border-[#2ad0e4]`;
            if (n===11) return `${base} bg-white text-[#005c42] border-[#005c42]`;
            if (n===12) return `${base} bg-yellow-400 text-[#005c42] border-[#005c42]`;
            return `${base} bg-slate-200 text-slate-500 border-slate-300`;
        };

        // Í∏∞Î°ùÏö© Ï∞®Ìä∏ (ÎÇÆÏùÑÏàòÎ°ù Ï¢ãÏùå - ÏãúÍ∞Ñ)
        const BarChart = ({ data, color }) => {
            if (!data) return null;
            const parsedData = data.map(d => ({ ...d, val: parseFloat(d.rec) }));
            const min = Math.min(...parsedData.map(d => d.val));
            const max = Math.max(...parsedData.map(d => d.val));
            const range = max - min || 1; 

            return (
                <div className="space-y-3">
                    {parsedData.map((item, idx) => {
                        const percentage = 100 - ((item.val - min) / range * 40);
                        const isTop = idx === 0;
                        return (
                            <div key={idx} className="flex items-center gap-3">
                                <div className="w-6 shrink-0 flex justify-center">
                                    <span className={`w-6 h-6 rounded-full text-[11px] font-bold flex items-center justify-center ${getBadgeStyle(item.no)}`}>
                                        {item.no}
                                    </span>
                                </div>
                                <div className="flex-1 min-w-0">
                                    <div className="flex items-end justify-between mb-1">
                                        <span className={`text-xs truncate ${isTop ? 'font-black text-slate-900' : 'font-medium text-slate-600'}`}>{item.name}</span>
                                    </div>
                                    <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden relative">
                                        <div className={`h-full rounded-full bar-fill ${color === 'red' ? 'bg-red-500' : 'bg-blue-500'}`} style={{ width: `${percentage}%` }}></div>
                                    </div>
                                </div>
                                <div className={`w-12 text-right font-mono text-xs tabular font-bold ${isTop ? (color === 'red' ? 'text-red-600' : 'text-blue-600') : 'text-slate-500'}`}>
                                    {item.rec}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // ÏàòÏπòÏö© Ï∞®Ìä∏ (ÎÜíÏùÑÏàòÎ°ù Ï¢ãÏùå - ÏÉÅÍ∏à, ÏäπÎ•†)
        const ValueChart = ({ data, color, valueKey }) => {
            if (!data) return null;
            
            // Îç∞Ïù¥ÌÑ∞ ÌååÏã± (Ïà´Ïûê Ï∂îÏ∂ú)
            const parsedData = data.map(d => {
                const rawVal = d[valueKey]; // "9.9Î∞±Îßå" or "16.7%"
                const numVal = parseFloat(rawVal.replace(/[^0-9.]/g, '')) || 0;
                return { ...d, val: numVal, raw: rawVal };
            });
            
            const max = Math.max(...parsedData.map(d => d.val)) || 1;

            return (
                <div className="space-y-3">
                    {parsedData.map((item, idx) => {
                        const percentage = (item.val / max) * 100; // ÎÜíÏùÑÏàòÎ°ù Í∏¥ Î∞î
                        const isTop = idx === 0;
                        
                        let barColorClass = 'bg-blue-500';
                        if (color === 'green') barColorClass = 'bg-emerald-500';
                        if (color === 'purple') barColorClass = 'bg-purple-500';

                        return (
                            <div key={idx} className="flex items-center gap-3">
                                <div className="w-6 shrink-0 flex justify-center">
                                    <span className={`w-6 h-6 rounded-full text-[11px] font-bold flex items-center justify-center ${getBadgeStyle(item.no)}`}>
                                        {item.no}
                                    </span>
                                </div>
                                <div className="flex-1 min-w-0">
                                    <div className="flex items-end justify-between mb-1">
                                        <span className={`text-xs truncate ${isTop ? 'font-black text-slate-900' : 'font-medium text-slate-600'}`}>{item.name}</span>
                                    </div>
                                    <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden relative">
                                        <div 
                                            className={`h-full rounded-full bar-fill ${barColorClass}`}
                                            style={{ width: `${percentage}%` }}
                                        ></div>
                                    </div>
                                </div>
                                <div className={`w-16 text-right font-mono text-xs tabular font-bold ${isTop ? 'text-slate-900' : 'text-slate-500'}`}>
                                    {item.raw}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [viewMode, setViewMode] = useState('app');
            const [syncStatus, setSyncStatus] = useState('connecting');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [loc, setLoc] = useState('seoul');
            const [raceIdx, setRaceIdx] = useState(0);
            const [expanded, setExpanded] = useState(null);
            
            const defaultData = {
                date: "Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå",
                locations: {
                    seoul: { location_name: "ÏÑúÏö∏", races: [] },
                    busan: { location_name: "Î∂ÄÏÇ∞", races: [] }
                }
            };
            const [dbData, setDbData] = useState(defaultData);

            useEffect(() => {
                const interval = setInterval(() => {
                    if (window.fb && window.fb.isReady) {
                        clearInterval(interval);
                        startSync();
                    }
                }, 100);
                return () => clearInterval(interval);
            }, [date]);

            const startSync = async () => {
                const { auth, db, doc, onSnapshot, signInAnonymously, onAuthStateChanged } = window.fb;
                try {
                    await signInAnonymously(auth);
                    onAuthStateChanged(auth, (u) => {
                        setUser(u);
                        if (u) {
                            const docRef = doc(db, 'artifacts', 'race-app-3e41d', 'public', 'data', 'raceDataJson', date);
                            onSnapshot(docRef, (snap) => {
                                if (snap.exists()) {
                                    setDbData(snap.data());
                                    setSyncStatus('synced');
                                } else {
                                    setDbData(defaultData);
                                    setSyncStatus('no-data');
                                }
                            });
                        }
                    });
                } catch (e) {
                    console.error(e);
                    setSyncStatus('error');
                }
            };

            const handleJsonUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    try {
                        const json = JSON.parse(ev.target.result);
                        if (!json.locations || !json.date) throw new Error("Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏùÄ JSON ÌòïÏãùÏûÖÎãàÎã§.");
                        
                        const dateMatch = json.date.match(/(\d{4}-\d{2}-\d{2})/);
                        if (!dateMatch) throw new Error("ÎÇ†Ïßú ÌòïÏãùÏùÑ Ïù∏ÏãùÌï† Ïàò ÏóÜÏäµÎãàÎã§.");
                        const targetDate = dateMatch[1];

                        setDate(targetDate);
                        setDbData(json);
                        
                        if (user) {
                            const { db, doc, setDoc } = window.fb;
                            const docRef = doc(db, 'artifacts', 'race-app-3e41d', 'public', 'data', 'raceDataJson', targetDate);
                            await setDoc(docRef, { ...json, lastUpdated: new Date().toISOString() });
                            alert(`‚úÖ ${targetDate} Îç∞Ïù¥ÌÑ∞ ÏóÖÎ°úÎìú ÏôÑÎ£å`);
                            setSyncStatus('synced');
                        }
                    } catch (err) {
                        alert("Ïò§Î•ò: " + err.message);
                    }
                };
                reader.readAsText(file);
            };

            const currentLocData = dbData.locations[loc] || { location_name: loc === 'seoul' ? "ÏÑúÏö∏" : "Î∂ÄÏÇ∞", races: [] };
            const races = currentLocData.races || [];
            const race = races[raceIdx];
            const expert = race?.expert_opinion;
            const stats = race?.stats_analysis;
            const info = race?.race_info;

            // --- Î∞∞ÏßÄ Í≥ÑÏÇ∞ÏùÑ ÏúÑÌïú Ìó¨Ìçº Ìï®Ïàò ---
            const getNum = (str) => parseFloat(String(str).replace(/[^\d.]/g, '')) || 0;
            const getClassNum = (str) => {
                if(!str) return 99;
                const match = str.match(/\d+/);
                return match ? parseInt(match[0]) : 99;
            };

            // Ï†ÑÏ≤¥ Îßê ÎπÑÍµêÎ•º ÏúÑÌïú Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ (1Îëê ÏÑ†Ï†ïÏùÑ ÏúÑÌï®)
            let maxRating = 0;
            let maxTraining = 0;
            let minWeight = 999;
            let maxWeight = 0;
            let topStartHorseNo = null;
            let topFinishHorseNo = null;

            if (race?.horses) {
                maxRating = Math.max(...race.horses.map(h => getNum(h.rating)));
                maxTraining = Math.max(...race.horses.map(h => getNum(h.training_cnt)));
                
                const weights = race.horses.map(h => getNum(h.weight)).filter(w => w > 0);
                if (weights.length > 0) {
                    minWeight = Math.min(...weights);
                    maxWeight = Math.max(...weights);
                }
            }
            if (stats?.fast_start_horses?.length > 0) topStartHorseNo = parseInt(stats.fast_start_horses[0].no);
            if (stats?.fast_finish_horses?.length > 0) topFinishHorseNo = parseInt(stats.fast_finish_horses[0].no);

            return (
                <div className="max-w-md mx-auto min-h-screen flex flex-col bg-[#f8fafc] relative shadow-2xl font-sans">
                    <header className="bg-slate-900 text-white pt-6 pb-6 px-6 rounded-b-[30px] shadow-xl z-20 relative">
                        <div className="flex justify-between items-center mb-6">
                            <div className="flex items-center gap-2">
                                <div className="bg-yellow-400 p-1.5 rounded-lg text-slate-900"><Icon name="trophy" size={16} /></div>
                                <span className="font-black italic text-lg tracking-tighter">SMART<span className="text-yellow-400">RACING</span> V9</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="bg-slate-800 text-white text-xs font-bold px-2 py-1.5 rounded-lg outline-none border border-slate-700 focus:border-yellow-400"/>
                                <button onClick={() => setViewMode(viewMode === 'app' ? 'admin' : 'app')} className={`p-2 rounded-full transition-colors ${viewMode === 'admin' ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-400 hover:text-white'}`}><Icon name={viewMode === 'app' ? 'settings' : 'x'} size={16} /></button>
                            </div>
                        </div>

                        {viewMode === 'app' ? (
                            <>
                                <div className="flex justify-between items-end">
                                    <div>
                                        <div className="text-[11px] text-slate-400 font-medium mb-1 flex items-center gap-1 opacity-80"><Icon name="calendar" size={12}/> {dbData.date || date}</div>
                                        <div className="flex items-center gap-2">
                                            <h2 className="text-2xl font-black text-white italic tracking-tight">{currentLocData.location_name} {race?.race_no}<span className="text-lg font-bold text-slate-400 not-italic ml-1">Í≤ΩÏ£º</span></h2>
                                            <div className="flex bg-slate-800 rounded-lg p-0.5 ml-2">
                                                <button onClick={() => setLoc('seoul')} className={`px-2 py-1 rounded-md text-[10px] font-bold transition-all ${loc === 'seoul' ? 'bg-white text-slate-900' : 'text-slate-400'}`}>ÏÑúÏö∏</button>
                                                <button onClick={() => setLoc('busan')} className={`px-2 py-1 rounded-md text-[10px] font-bold transition-all ${loc === 'busan' ? 'bg-blue-600 text-white' : 'text-slate-400'}`}>Î∂ÄÏÇ∞</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-4 flex gap-1.5 overflow-x-auto pb-2 scrollbar-hide">
                                    {races.length > 0 ? races.map((r, i) => (
                                        <button key={i} onClick={() => { setRaceIdx(i); setExpanded(null); window.scrollTo({top:0, behavior:'smooth'}); }} className={`flex-shrink-0 w-9 h-9 rounded-full text-xs font-bold flex items-center justify-center transition-all ${raceIdx === i ? 'bg-yellow-400 text-slate-900 scale-110 shadow-lg ring-2 ring-yellow-400/30' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>{r.race_no}</button>
                                    )) : <div className="text-slate-500 text-xs py-2">Ìï¥Îãπ ÎÇ†Ïßú/ÏßÄÏó≠Ïùò Í≤ΩÏ£º Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>}
                                </div>
                            </>
                        ) : (
                            <div className="text-white"><h2 className="text-xl font-bold mb-1">Í¥ÄÎ¶¨Ïûê Î™®Îìú</h2><p className="text-xs text-slate-400">JSON ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÏó¨ Îç∞Ïù¥ÌÑ∞Î•º Í∞±Ïã†ÌïòÏÑ∏Ïöî.</p></div>
                        )}
                    </header>

                    <main className="flex-1 p-0 pb-24 space-y-5">
                        {viewMode === 'admin' ? (
                            <div className="p-6 animate-up">
                                <div className="bg-white p-6 rounded-3xl shadow-lg border border-slate-100">
                                    <div className="text-center mb-6">
                                        <div className="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="upload-cloud" size={32} /></div>
                                        <h3 className="font-bold text-slate-900 text-lg">Îç∞Ïù¥ÌÑ∞ ÌååÏùº ÏóÖÎ°úÎìú</h3>
                                        <p className="text-sm text-slate-500 mt-1">Ï§ÄÎπÑÎêú <code>race-app.json</code> ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</p>
                                    </div>
                                    <label className="block w-full cursor-pointer group">
                                        <div className="border-2 border-dashed border-slate-300 rounded-2xl p-8 text-center transition-colors group-hover:border-indigo-500 group-hover:bg-indigo-50">
                                            <span className="text-sm font-bold text-slate-600 group-hover:text-indigo-600">ÌååÏùº ÏÑ†ÌÉùÌïòÍ∏∞</span>
                                            <input type="file" accept=".json" onChange={handleJsonUpload} className="hidden" />
                                        </div>
                                    </label>
                                    <div className="mt-6 p-4 bg-slate-50 rounded-xl border border-slate-200">
                                        <h4 className="font-bold text-xs text-slate-500 uppercase mb-2">ÌòÑÏû¨ ÏÉÅÌÉú</h4>
                                        <div className="flex items-center justify-between text-sm"><span className="text-slate-600">ÎèôÍ∏∞Ìôî ÏÉÅÌÉú:</span><span className={`font-bold ${syncStatus === 'synced' ? 'text-green-600' : 'text-orange-500'}`}>{syncStatus === 'synced' ? 'ÏµúÏã† Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö© Ï§ë' : syncStatus}</span></div>
                                        <div className="flex items-center justify-between text-sm mt-1"><span className="text-slate-600">ÏÑ†ÌÉùÎêú ÎÇ†Ïßú:</span><span className="font-mono font-bold text-slate-800">{date}</span></div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <>
                                {info && (
                                    <div className="sticky top-0 z-50 px-4 pt-0 pb-2">
                                        <div className="sticky-header-blur rounded-3xl p-4 shadow-[0_8px_30px_rgb(0,0,0,0.06)] border border-slate-200/50 animate-up">
                                            <div className="flex items-center justify-between mb-2 pb-2 border-b border-slate-100">
                                                <div className="flex items-center gap-3">
                                                    <span className="bg-indigo-600 text-white text-[11px] font-black px-2.5 py-1 rounded-lg shadow-sm shadow-indigo-200">{info.class}</span>
                                                    <span className="text-base font-bold text-slate-800 tabular">{info.distance}</span>
                                                    <span className="text-xs text-slate-400 font-medium tabular">| {info.start_time}</span>
                                                </div>
                                                <div className="flex flex-col items-end">
                                                    <span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Ïö∞ÏäπÎßà ÌèâÍ∑†Í∏∞Î°ù</span>
                                                    <div className="font-black text-slate-800 text-sm tabular tracking-tight flex items-center gap-1"><Icon name="timer" size={14} className="text-indigo-500"/>{stats?.avg_record || '-'}</div>
                                                </div>
                                            </div>
                                            <div className="text-xs text-slate-500 font-medium leading-tight bg-slate-50 p-2.5 rounded-xl border border-slate-100 flex gap-2 items-start mb-2">
                                                <Icon name="info" size={14} className="text-indigo-400 shrink-0 mt-0.5"/>
                                                <span className="line-clamp-2">{info.conditions}</span>
                                            </div>
                                            {expert && (
                                                <div className="flex items-center gap-4 text-xs overflow-x-auto scrollbar-hide">
                                                    <div className="flex items-center gap-3 shrink-0">
                                                        <span className="bg-slate-900 text-white px-2.5 py-1 rounded-full text-[10px] font-bold tracking-wide shadow-md shadow-slate-200">Ï∂îÏ≤ú</span>
                                                        <div className="flex -space-x-1 hover:space-x-1 transition-all duration-300">
                                                            {expert.picks.map(no => <span key={no} className={`w-7 h-7 rounded-full font-bold text-xs flex items-center justify-center ${getBadgeStyle(no)}`}>{no}</span>)}
                                                        </div>
                                                    </div>
                                                    <div className="w-px h-6 bg-slate-200 shrink-0 mx-1"></div>
                                                    <div className="flex items-center gap-3 shrink-0">
                                                        <span className="bg-white border border-slate-200 text-slate-600 px-2.5 py-1 rounded-full text-[10px] font-bold tracking-wide">Î≥µÎ≥ë</span>
                                                        <div className="flex gap-1.5">
                                                            {expert.upset_picks.map(no => <span key={no} className={`w-7 h-7 rounded-full font-bold text-xs flex items-center justify-center ${getBadgeStyle(no)}`}>{no}</span>)}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}

                                <div className="px-4 space-y-3">
                                    {race?.horses.map((h, i) => {
                                        const isExp = expanded === h.horse_no;
                                        const picksText = expert?.picks_text?.find(p => parseInt(p.no) === h.horse_no)?.coment;
                                        const isPick = expert?.picks?.includes(h.horse_no);
                                        const targetDist = info ? parseInt(info.distance.replace(/\D/g, '')) : 0;
                                        const recentRecObj = h.recent_history?.find(r => r.distance === targetDist);
                                        const recentRecord = recentRecObj ? recentRecObj.record : null;
                                        
                                        // --- Î∞∞ÏßÄ ÏÉùÏÑ± Î°úÏßÅ ---
                                        const badges = [];

                                        // 1. ÏµúÍ∑º Í∏∞Î°ù (Ìï≠ÏÉÅ ÏµúÏö∞ÏÑ†)
                                        if (recentRecord) {
                                            badges.push({ emoji: "‚è±Ô∏è", text: recentRecord, color: "yellow" });
                                        }

                                        // 2. Ï†ÑÎ¨∏Í∞Ä Ï∂îÏ≤ú
                                        if (isPick) badges.push({ emoji: "‚≠ê", text: "Ï∂îÏ≤ú", color: "red" });
                                        if (expert?.upset_picks?.includes(h.horse_no)) badges.push({ emoji: "üí£", text: "Î≥µÎ≥ë", color: "purple" });

                                        // 3. Í∏∞Ïàò ÍµêÏ≤¥
                                        const lastRace = h.recent_history?.[0];
                                        if (lastRace && lastRace.jockey !== h.jockey) {
                                            badges.push({ emoji: "üîÑ", text: "Í∏∞ÏàòÍµêÏ≤¥", color: "gray" });
                                        }

                                        // 4. ÏäπÍ∏âÏ†Ñ / Í∞ïÍ∏âÏ†Ñ
                                        if (info && lastRace && lastRace.class) {
                                            const currentClassNum = getClassNum(info.class);
                                            const lastClassNum = getClassNum(lastRace.class);
                                            if (currentClassNum < lastClassNum) {
                                                if (lastClassNum - currentClassNum > 1) {
                                                    badges.push({ emoji: "üöÄ", text: "Ï†êÌïëÏ†Ñ", color: "red" });
                                                } else {
                                                    badges.push({ emoji: "üÜô", text: "ÏäπÍ∏âÏ†Ñ", color: "red" });
                                                }
                                            } else if (currentClassNum > lastClassNum) {
                                                badges.push({ emoji: "‚¨áÔ∏è", text: "Í∞ïÍ∏âÏ†Ñ", color: "gray" });
                                            }
                                        }

                                        // 5. ÌõàÎ†®Ïôï
                                        const myTraining = getNum(h.training_cnt);
                                        if (myTraining > 0 && myTraining === maxTraining) {
                                            badges.push({ emoji: "üí™", text: "ÌõàÎ†®Ïôï", color: "blue" });
                                        }

                                        // 6. Î†àÏù¥ÌåÖÏôï
                                        const myRating = getNum(h.rating);
                                        if (myRating > 0 && myRating === maxRating) {
                                            badges.push({ emoji: "üëë", text: "Î†àÏù¥ÌåÖÏôï", color: "purple" });
                                        }

                                        // 7. Î∂ÄÏ§ë
                                        const myWeight = getNum(h.weight);
                                        if (myWeight > 0) {
                                            if (myWeight === minWeight) badges.push({ emoji: "ü™∂", text: "Î∂ÄÏ§ë‚Üì", color: "cyan" });
                                            if (myWeight === maxWeight) badges.push({ emoji: "üèãÔ∏è", text: "Î∂ÄÏ§ë‚Üë", color: "orange" });
                                        }

                                        // 8. Ï¥àÎ∞ò/ÌõÑÎ∞ò Ïä§ÌîºÎìú
                                        if (h.horse_no === topStartHorseNo) badges.push({ emoji: "üöÄ", text: "Ï¥àÎ∞ò", color: "red" });
                                        if (h.horse_no === topFinishHorseNo) badges.push({ emoji: "‚ö°", text: "ÌõÑÎ∞ò", color: "blue" });

                                        return (
                                            <div 
                                                key={h.horse_no} 
                                                className={`bg-white rounded-2xl shadow-sm border transition-all duration-300 overflow-hidden animate-up ${isExp ? 'border-indigo-500 ring-1 ring-indigo-500 shadow-[0_10px_30px_-10px_rgba(79,70,229,0.2)]' : 'border-slate-100 shadow-[0_2px_10px_-5px_rgba(0,0,0,0.05)]'}`}
                                                style={{animationDelay: `${0.2 + (i * 0.05)}s`}}
                                            >
                                                <div className="p-3 flex items-center gap-3 cursor-pointer active:bg-slate-50 min-h-[70px]" onClick={() => setExpanded(isExp ? null : h.horse_no)}>
                                                    {/* 1. ÎßàÎ≤à (Ï¢åÏ∏°) */}
                                                    <div className={`w-[45px] h-[45px] rounded-xl flex items-center justify-center shadow-inner font-black text-lg italic tracking-tighter shrink-0 ${getBadgeStyle(h.horse_no)}`}>
                                                        {h.horse_no}
                                                    </div>
                                                    
                                                    {/* 2. Îßê Ï†ïÎ≥¥ (Ïù¥Î¶Ñ/ÏÉÅÏÑ∏ - ÏúÑÏπò Í≥†Ï†ï) */}
                                                    <div className="flex flex-col justify-center shrink-0 w-[85px]">
                                                        <div className="flex items-center gap-1 mb-0.5">
                                                            <h3 className="font-bold text-slate-900 text-[15px] truncate leading-tight">{h.name}</h3>
                                                            {isPick && <Icon name="thumbs-up" size={12} className="text-yellow-500 fill-yellow-500 shrink-0"/>}
                                                        </div>
                                                        <div className="text-[11px] text-slate-400 font-medium tabular leading-none">
                                                            {h.origin}/{h.sex}/{h.age}
                                                        </div>
                                                    </div>

                                                    {/* 3. Î∞∞ÏßÄ ÏòÅÏó≠ (Ïù¥Î¶Ñ ÏòÜ ÎÇ®ÏùÄ Í≥µÍ∞Ñ Ï±ÑÏõÄ) */}
                                                    <div className="flex-1 flex flex-wrap gap-1 items-center justify-start content-center min-h-[45px]">
                                                        {badges.map((b, idx) => (
                                                            <div key={idx} className={`flex-shrink-0 px-1.5 py-0.5 rounded flex items-center justify-center border ${
                                                                b.color === 'red' ? 'bg-red-50 text-red-600 border-red-100' :
                                                                b.color === 'blue' ? 'bg-blue-50 text-blue-600 border-blue-100' :
                                                                b.color === 'purple' ? 'bg-purple-50 text-purple-600 border-purple-100' :
                                                                b.color === 'yellow' ? 'bg-yellow-50 text-yellow-700 border-yellow-200' :
                                                                b.color === 'cyan' ? 'bg-cyan-50 text-cyan-600 border-cyan-100' :
                                                                b.color === 'orange' ? 'bg-orange-50 text-orange-600 border-orange-100' :
                                                                b.color === 'gray' ? 'bg-slate-100 text-slate-600 border-slate-200' :
                                                                'bg-slate-50 text-slate-600 border-slate-100'
                                                            }`}>
                                                                <span className="text-[10px] leading-none mr-1">{b.emoji}</span>
                                                                <span className="text-[9px] font-bold tracking-tight leading-none whitespace-nowrap">{b.text}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>

                                                {isExp && (
                                                    <div className="bg-slate-50/50 border-t border-slate-100 p-5">
                                                        
                                                        {/* ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏÑπÏÖò: 1. ÌïµÏã¨ ÏßÄÌëú Í∑∏Î¶¨Îìú */}
                                                        <div className="mb-4 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                                                            <div className="grid grid-cols-5 divide-x divide-slate-100">
                                                                <div className="p-2 text-center">
                                                                    <div className="text-[9px] text-slate-400 font-bold mb-0.5">Îì±Í∏â</div>
                                                                    <div className="font-bold text-slate-800 text-xs truncate">{h.grade}</div>
                                                                </div>
                                                                <div className="p-2 text-center">
                                                                    <div className="text-[9px] text-slate-400 font-bold mb-0.5">Î∂ÄÏ§ë</div>
                                                                    <div className="font-bold text-slate-800 text-xs truncate">{h.weight}</div>
                                                                </div>
                                                                <div className="p-2 text-center bg-blue-50/30">
                                                                    <div className="text-[9px] text-blue-500 font-bold mb-0.5">ÌõàÎ†®</div>
                                                                    <div className="font-bold text-blue-700 text-xs truncate">{h.training_cnt || '-'}Ìöå</div>
                                                                </div>
                                                                <div className="p-2 text-center bg-blue-50/30">
                                                                    <div className="text-[9px] text-blue-500 font-bold mb-0.5">Ï£ºÍ∏∞</div>
                                                                    <div className="font-bold text-blue-700 text-xs truncate">{h.participation_period || '-'}</div>
                                                                </div>
                                                                <div className="p-2 text-center">
                                                                    <div className="text-[9px] text-slate-400 font-bold mb-0.5">Î†àÏù¥ÌåÖ</div>
                                                                    <div className="font-bold text-slate-800 text-xs truncate">{h.rating}</div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* 2. Ï†ÑÎ¨∏Í∞Ä ÏΩîÎ©òÌä∏ */}
                                                        {picksText ? (
                                                            <div className="mb-4 bg-white p-4 rounded-2xl border-l-[3px] border-yellow-400 shadow-sm">
                                                                <div className="flex items-center gap-2 mb-2 text-yellow-600 font-black text-[10px] uppercase tracking-wider">
                                                                    <Icon name="message-circle" size={12}/> Expert Insight
                                                                </div>
                                                                <p className="text-[13px] font-medium text-slate-700 leading-relaxed break-keep tracking-tight">
                                                                    {picksText}
                                                                </p>
                                                            </div>
                                                        ) : (
                                                            <div className="mb-4 text-center text-xs text-slate-400 py-2 border border-dashed border-slate-200 rounded-xl">Ï†ÑÎ¨∏Í∞Ä ÏΩîÎ©òÌä∏ ÏóÜÏùå</div>
                                                        )}

                                                        {/* 3. Ïù∏Î¨º Ï†ïÎ≥¥ (Í∏∞Ïàò/Ï°∞ÍµêÏÇ¨/ÎßàÏ£º) */}
                                                        <div className="grid grid-cols-3 gap-3 mb-5">
                                                            <div className="bg-white p-2.5 rounded-xl border border-slate-200 shadow-sm text-center">
                                                                <div className="text-[9px] text-slate-400 font-bold mb-1 uppercase">Í∏∞Ïàò</div>
                                                                <div className="font-bold text-slate-800 text-xs truncate">{h.jockey}</div>
                                                            </div>
                                                            <div className="bg-white p-2.5 rounded-xl border border-slate-200 shadow-sm text-center">
                                                                <div className="text-[9px] text-slate-400 font-bold mb-1 uppercase">Ï°∞ÍµêÏÇ¨</div>
                                                                <div className="font-bold text-slate-800 text-xs truncate">{h.trainer}</div>
                                                            </div>
                                                            <div className="bg-white p-2.5 rounded-xl border border-slate-200 shadow-sm text-center">
                                                                <div className="text-[9px] text-slate-400 font-bold mb-1 uppercase">ÎßàÏ£º</div>
                                                                <div className="font-bold text-slate-800 text-xs truncate">{h.owner}</div>
                                                            </div>
                                                        </div>

                                                        {/* 4. Í∏∞Î°ù ÌÖåÏù¥Î∏î */}
                                                        <div className="bg-white rounded-2xl overflow-hidden shadow-sm border border-slate-200">
                                                            <div className="bg-slate-50/80 px-4 py-2.5 text-[10px] font-bold text-slate-500 uppercase flex justify-between items-center border-b border-slate-100">
                                                                <span>Recent History</span>
                                                                <Icon name="history" size={12}/>
                                                            </div>
                                                            <div className="overflow-x-auto">
                                                                <table className="w-full text-[11px] text-center whitespace-nowrap">
                                                                    <thead className="bg-white text-slate-400 border-b border-slate-50">
                                                                        <tr>
                                                                            <th className="py-2.5 px-2 font-medium">ÎÇ†Ïßú</th>
                                                                            <th className="font-medium">Îì±Í∏â</th>
                                                                            <th className="font-medium">Í±∞Î¶¨</th>
                                                                            <th className="font-medium">Í∏∞Î°ù</th>
                                                                            <th className="font-medium">ÏàúÏúÑ</th>
                                                                            <th className="font-medium text-slate-500">Î∂ÄÏ§ë</th>
                                                                            <th className="font-medium text-slate-500">Í∏∞Ïàò</th>
                                                                            <th className="font-medium text-rose-400">S1F</th>
                                                                            <th className="font-medium text-green-600">G3F</th>
                                                                            <th className="font-medium text-blue-400">G1F</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody className="divide-y divide-slate-50 tabular font-medium">
                                                                        {h.recent_history && h.recent_history.length > 0 ? (
                                                                            h.recent_history.map((hist, hIdx) => (
                                                                                <tr key={hIdx}>
                                                                                    <td className="py-2.5 px-2 text-slate-500">{hist.date}</td>
                                                                                    <td className="text-slate-700 text-[10px]">{hist.class}</td>
                                                                                    <td className="text-slate-700">{hist.distance}</td>
                                                                                    <td className="font-bold text-slate-900">{hist.record}</td>
                                                                                    <td className={`font-bold ${hist.result_rank <= 3 ? 'text-rose-600' : 'text-slate-400'}`}>{hist.result_rank}ÏúÑ</td>
                                                                                    <td className="text-slate-500">{hist.weight}</td>
                                                                                    <td className="text-slate-500 text-[10px]">{hist.jockey}</td>
                                                                                    <td className="text-slate-500">{hist.s1f}</td>
                                                                                    <td className="text-green-600 font-bold">{hist.g3f}</td>
                                                                                    <td className="text-slate-500">{hist.g1f}</td>
                                                                                </tr>
                                                                            ))
                                                                        ) : (
                                                                            <tr>
                                                                                <td colSpan="10" className="py-6 text-slate-400 text-center text-xs">ÏµúÍ∑º Ï†ÑÏ†Å Ï†ïÎ≥¥ ÏóÜÏùå</td>
                                                                            </tr>
                                                                        )}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                                {stats && (
                                    <div className="px-4 pb-10">
                                        <div className="bg-white rounded-3xl p-6 shadow-[0_10px_40px_-10px_rgba(0,0,0,0.08)] border border-slate-100 animate-up">
                                            <h3 className="text-sm font-black text-slate-800 flex items-center gap-2 mb-6"><div className="bg-green-100 p-1 rounded text-green-600"><Icon name="bar-chart-2" size={14}/></div>Îç∞Ïù¥ÌÑ∞ Ï†ïÎ∞Ä Î∂ÑÏÑù</h3>
                                            <div className="space-y-8">
                                                <div><div className="flex justify-between items-center mb-3"><span className="text-[11px] font-bold text-red-500 flex items-center gap-1.5 bg-red-50 px-2 py-1 rounded-md"><Icon name="zap" size={12}/> Ï¥àÎ∞ò Ïä§ÌîºÎìú (S1F)</span></div><BarChart data={stats.fast_start_horses} color="red" /></div>
                                                <div><div className="flex justify-between items-center mb-3"><span className="text-[11px] font-bold text-blue-500 flex items-center gap-1.5 bg-blue-50 px-2 py-1 rounded-md"><Icon name="activity" size={12}/> ÌõÑÎ∞ò ÌÉÑÎ†• (G1F)</span></div><BarChart data={stats.fast_finish_horses} color="blue" /></div>
                                                
                                                {/* ÏÉÅÍ∏à Î∂ÑÏÑù Ï∂îÍ∞Ä */}
                                                {stats.prize_money_6mon && (
                                                    <div>
                                                        <div className="flex justify-between items-center mb-3">
                                                            <span className="text-[11px] font-bold text-emerald-600 flex items-center gap-1.5 bg-emerald-50 px-2 py-1 rounded-md">
                                                                <Icon name="dollar-sign" size={12}/> ÏµúÍ∑º 6Í∞úÏõî ÏÉÅÍ∏à
                                                            </span>
                                                        </div>
                                                        <ValueChart data={stats.prize_money_6mon} color="green" valueKey="won" />
                                                    </div>
                                                )}

                                                {/* Î≥µÏäπÎ•† Î∂ÑÏÑù Ï∂îÍ∞Ä */}
                                                {stats.horse_bok_win && (
                                                    <div>
                                                        <div className="flex justify-between items-center mb-3">
                                                            <span className="text-[11px] font-bold text-purple-600 flex items-center gap-1.5 bg-purple-50 px-2 py-1 rounded-md">
                                                                <Icon name="percent" size={12}/> Îßê Î≥µÏäπÎ•†
                                                            </span>
                                                        </div>
                                                        <ValueChart data={stats.horse_bok_win} color="purple" valueKey="bok_win" />
                                                    </div>
                                                )}

                                            </div>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
