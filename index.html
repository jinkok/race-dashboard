<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMART RACING PRO V9</title>
    
    <!-- 1. ÌïÑÏàò ÎùºÏù¥Î∏åÎü¨Î¶¨ (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- ÏïÑÏù¥ÏΩò -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Ïä§ÌÉÄÏùº -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700;800&display=swap');
        
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; color: #0f172a; -webkit-tap-highlight-color: transparent; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .animate-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .bar-fill { animation: fillBar 1s ease-out forwards; transform-origin: left; transform: scaleX(0); }
        @keyframes fillBar { to { transform: scaleX(1); } }
        
        .tabular { font-variant-numeric: tabular-nums; }
        
        .sticky-header-blur {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            background-color: rgba(255, 255, 255, 0.95);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 2. Firebase SDK ÏÑ§Ï†ï -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVJRqmpFjR9g91AgQsJIV65_7BJ7yYEOU",
            authDomain: "race-app-3e41d.firebaseapp.com",
            projectId: "race-app-3e41d",
            storageBucket: "race-app-3e41d.firebasestorage.app",
            messagingSenderId: "232853669556",
            appId: "1:232853669556:web:f9e7c8ccfde227f50679e1",
            measurementId: "G-H6MB9KZ8M8"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            window.fb = { auth, db, doc, setDoc, onSnapshot, signInAnonymously, onAuthStateChanged, isReady: true };
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = ({ name, size = 16, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons({ root: ref.current, name, attrs: { width: size, height: size, class: className } });
            }, [name, className, size]);
            return <i ref={ref} data-lucide={name}></i>;
        };

        const getBadgeStyle = (no) => {
            const n = parseInt(no);
            const base = "border-2 shadow-sm box-border";
            if (n===1) return `${base} bg-white text-slate-900 border-slate-900`;
            if (n===2) return `${base} bg-yellow-400 text-slate-900 border-yellow-400`;
            if (n===3) return `${base} bg-red-600 text-white border-red-600`;
            if (n===4) return `${base} bg-slate-900 text-white border-slate-900`;
            if (n===5) return `${base} bg-blue-600 text-white border-blue-600`;
            if (n===6) return `${base} bg-green-600 text-white border-green-600`;
            if (n===7) return `${base} bg-[#8B4513] text-white border-[#8B4513]`;
            if (n===8) return `${base} bg-pink-400 text-white border-pink-400`;
            if (n===9) return `${base} bg-purple-700 text-white border-purple-700`;
            if (n===10) return `${base} bg-[#2ad0e4] text-slate-900 border-[#2ad0e4]`;
            if (n===11) return `${base} bg-white text-[#005c42] border-[#005c42]`;
            if (n===12) return `${base} bg-yellow-400 text-[#005c42] border-[#005c42]`;
            return `${base} bg-slate-200 text-slate-500 border-slate-300`;
        };

        const BarChart = ({ data, color }) => {
            if (!data) return null;
            const parsedData = data.map(d => ({ ...d, val: parseFloat(d.rec) }));
            const min = Math.min(...parsedData.map(d => d.val));
            const max = Math.max(...parsedData.map(d => d.val));
            const range = max - min || 1; 

            return (
                <div className="space-y-3">
                    {parsedData.map((item, idx) => {
                        const percentage = 100 - ((item.val - min) / range * 40);
                        const isTop = idx === 0;
                        return (
                            <div key={idx} className="flex items-center gap-3">
                                <div className="w-6 shrink-0 flex justify-center">
                                    <span className={`w-6 h-6 rounded-full text-[11px] font-bold flex items-center justify-center ${getBadgeStyle(item.no)}`}>
                                        {item.no}
                                    </span>
                                </div>
                                <div className="flex-1 min-w-0">
                                    <div className="flex items-end justify-between mb-1">
                                        <span className={`text-xs truncate ${isTop ? 'font-black text-slate-900' : 'font-medium text-slate-600'}`}>{item.name}</span>
                                    </div>
                                    <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden relative">
                                        <div className={`h-full rounded-full bar-fill ${color === 'red' ? 'bg-red-500' : 'bg-blue-500'}`} style={{ width: `${percentage}%` }}></div>
                                    </div>
                                </div>
                                <div className={`w-12 text-right font-mono text-xs tabular font-bold ${isTop ? (color === 'red' ? 'text-red-600' : 'text-blue-600') : 'text-slate-500'}`}>
                                    {item.rec}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const ValueChart = ({ data, color, valueKey }) => {
            if (!data) return null;
            const parsedData = data.map(d => {
                const rawVal = d[valueKey];
                const numVal = parseFloat(rawVal.replace(/[^0-9.]/g, '')) || 0;
                return { ...d, val: numVal, raw: rawVal };
            });
            const max = Math.max(...parsedData.map(d => d.val)) || 1;
            return (
                <div className="space-y-3">
                    {parsedData.map((item, idx) => {
                        const percentage = (item.val / max) * 100;
                        const isTop = idx === 0;
                        let barColorClass = 'bg-blue-500';
                        if (color === 'green') barColorClass = 'bg-emerald-500';
                        if (color === 'purple') barColorClass = 'bg-purple-500';
                        return (
                            <div key={idx} className="flex items-center gap-3">
                                <div className="w-6 shrink-0 flex justify-center">
                                    <span className={`w-6 h-6 rounded-full text-[11px] font-bold flex items-center justify-center ${getBadgeStyle(item.no)}`}>
                                        {item.no}
                                    </span>
                                </div>
                                <div className="flex-1 min-w-0">
                                    <div className="flex items-end justify-between mb-1">
                                        <span className={`text-xs truncate ${isTop ? 'font-black text-slate-900' : 'font-medium text-slate-600'}`}>{item.name}</span>
                                    </div>
                                    <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden relative">
                                        <div className={`h-full rounded-full bar-fill ${barColorClass}`} style={{ width: `${percentage}%` }}></div>
                                    </div>
                                </div>
                                <div className={`w-16 text-right font-mono text-xs tabular font-bold ${isTop ? 'text-slate-900' : 'text-slate-500'}`}>
                                    {item.raw}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [viewMode, setViewMode] = useState('app');
            const [syncStatus, setSyncStatus] = useState('connecting');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [loc, setLoc] = useState('seoul');
            const [raceIdx, setRaceIdx] = useState(0);
            const [expanded, setExpanded] = useState(null);
            
            const defaultData = {
                date: "Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå",
                locations: {
                    seoul: { location_name: "ÏÑúÏö∏", races: [] },
                    busan: { location_name: "Î∂ÄÏÇ∞", races: [] }
                }
            };
            const [dbData, setDbData] = useState(defaultData);

            // ÏßÄÏó≠ Î≥ÄÍ≤Ω Ïãú Ïù∏Îç±Ïä§ Ï¥àÍ∏∞Ìôî
            const changeLocation = (newLoc) => {
                setLoc(newLoc);
                setRaceIdx(0);
                setExpanded(null);
            };

            useEffect(() => {
                const interval = setInterval(() => {
                    if (window.fb && window.fb.isReady) {
                        clearInterval(interval);
                        startSync();
                    }
                }, 100);
                return () => clearInterval(interval);
            }, [date]);

            const startSync = async () => {
                const { auth, db, doc, onSnapshot, signInAnonymously, onAuthStateChanged } = window.fb;
                try {
                    await signInAnonymously(auth);
                    onAuthStateChanged(auth, (u) => {
                        setUser(u);
                        if (u) {
                            const docRef = doc(db, 'artifacts', 'race-app-3e41d', 'public', 'data', 'raceDataJson', date);
                            onSnapshot(docRef, (snap) => {
                                if (snap.exists()) {
                                    setDbData(snap.data());
                                    setSyncStatus('synced');
                                } else {
                                    setDbData(defaultData);
                                    setSyncStatus('no-data');
                                }
                            });
                        }
                    });
                } catch (e) {
                    setSyncStatus('error');
                }
            };

            const handleJsonUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    try {
                        const json = JSON.parse(ev.target.result);
                        const dateMatch = json.date.match(/(\d{4}-\d{2}-\d{2})/);
                        const targetDate = dateMatch ? dateMatch[1] : date;
                        setDate(targetDate);
                        setDbData(json);
                        if (user) {
                            const { db, doc, setDoc } = window.fb;
                            const docRef = doc(db, 'artifacts', 'race-app-3e41d', 'public', 'data', 'raceDataJson', targetDate);
                            await setDoc(docRef, { ...json, lastUpdated: new Date().toISOString() });
                            setSyncStatus('synced');
                        }
                    } catch (err) { alert("Ïò§Î•ò: " + err.message); }
                };
                reader.readAsText(file);
            };

            const currentLocData = dbData.locations[loc] || { location_name: loc === 'seoul' ? "ÏÑúÏö∏" : "Î∂ÄÏÇ∞", races: [] };
            const races = currentLocData.races || [];
            const race = races[raceIdx];
            const expert = race?.expert_opinion;
            const stats = race?.stats_analysis;
            const info = race?.race_info;

            const getNum = (str) => parseFloat(String(str).replace(/[^\d.]/g, '')) || 0;
            const getClassNum = (str) => {
                if(!str) return 99;
                const match = str.match(/\d+/);
                return match ? parseInt(match[0]) : 99;
            };

            // ÏãúÍ∞Ñ Î≥ÄÌôò Ìï®Ïàò
            const timeToSeconds = (timeStr) => {
                if (!timeStr || typeof timeStr !== 'string') return 9999;
                const parts = timeStr.split(':');
                if (parts.length === 2) return parseFloat(parts[0]) * 60 + parseFloat(parts[1]);
                return parseFloat(timeStr) || 9999;
            };

            const formatTime = (seconds) => {
                if (seconds >= 9999) return "-";
                const m = Math.floor(seconds / 60);
                const s = (seconds % 60).toFixed(1);
                return m > 0 ? `${m}:${s.padStart(4, '0')}` : s;
            };

            let maxRating = 0, maxTraining = 0, minWeight = 999, maxWeight = 0;
            let topStartHorseNo = null, topFinishHorseNo = null;
            let topDistHorseNo = null, avgDistHorseNo = null, recentDistHorseNo = null;
            let bestTimeMap = {}, avgTimeMap = {}, recentTimeMap = {};

            if (race?.horses) {
                maxRating = Math.max(...race.horses.map(h => getNum(h.rating)));
                maxTraining = Math.max(...race.horses.map(h => getNum(h.training_cnt)));
                const weights = race.horses.map(h => getNum(h.weight)).filter(w => w > 0);
                if (weights.length > 0) { minWeight = Math.min(...weights); maxWeight = Math.max(...weights); }

                const targetDistNum = info ? parseInt(info.distance.replace(/\D/g, '')) : 0;
                
                const horsePerformance = race.horses.map(h => {
                    const validHistory = h.recent_history?.filter(hist => 
                        parseInt(hist.distance) === targetDistNum && !hist.class?.includes("Ï£ºÌñâ")
                    ) || [];
                    if (validHistory.length === 0) return { no: h.horse_no, best: 9999, avg: 9999, recent: 9999 };
                    const times = validHistory.map(hist => timeToSeconds(hist.record));
                    return {
                        no: h.horse_no,
                        best: Math.min(...times),
                        avg: times.reduce((a, b) => a + b, 0) / times.length,
                        recent: times[0]
                    };
                });

                const globalBestDistTime = Math.min(...horsePerformance.map(p => p.best));
                const globalBestDistAvg = Math.min(...horsePerformance.map(p => p.avg));
                const globalBestRecentTime = Math.min(...horsePerformance.map(p => p.recent));
                
                topDistHorseNo = horsePerformance.find(p => p.best === globalBestDistTime && p.best < 9999)?.no;
                avgDistHorseNo = horsePerformance.find(p => p.avg === globalBestDistAvg && p.avg < 9999)?.no;
                recentDistHorseNo = horsePerformance.find(p => p.recent === globalBestRecentTime && p.recent < 9999)?.no;

                horsePerformance.forEach(p => {
                    bestTimeMap[p.no] = p.best;
                    avgTimeMap[p.no] = p.avg;
                    recentTimeMap[p.no] = p.recent;
                });
            }
            if (stats?.fast_start_horses?.length > 0) topStartHorseNo = parseInt(stats.fast_start_horses[0].no);
            if (stats?.fast_finish_horses?.length > 0) topFinishHorseNo = parseInt(stats.fast_finish_horses[0].no);

            return (
                <div className="max-w-md mx-auto min-h-screen flex flex-col bg-[#f8fafc] relative shadow-2xl font-sans">
                    <header className="bg-slate-900 text-white pt-6 pb-6 px-6 rounded-b-[30px] shadow-xl z-20 relative">
                        <div className="flex justify-between items-center mb-6">
                            <div className="flex items-center gap-2">
                                <div className="bg-yellow-400 p-1.5 rounded-lg text-slate-900"><Icon name="trophy" size={16} /></div>
                                <span className="font-black italic text-lg tracking-tighter">SMART<span className="text-yellow-400">RACING</span> V9</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="bg-slate-800 text-white text-xs font-bold px-2 py-1.5 rounded-lg outline-none border border-slate-700 focus:border-yellow-400"/>
                                <button onClick={() => setViewMode(viewMode === 'app' ? 'admin' : 'app')} className={`p-2 rounded-full transition-colors ${viewMode === 'admin' ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-400 hover:text-white'}`}><Icon name={viewMode === 'app' ? 'settings' : 'x'} size={16} /></button>
                            </div>
                        </div>
                        {viewMode === 'app' && (
                            <>
                                <div className="flex justify-between items-end">
                                    <div>
                                        <div className="text-[11px] text-slate-400 font-medium mb-1 flex items-center gap-1 opacity-80"><Icon name="calendar" size={12}/> {dbData.date || date}</div>
                                        <div className="flex items-center gap-2">
                                            <h2 className="text-2xl font-black text-white italic tracking-tight">{currentLocData.location_name} {race?.race_no}<span className="text-lg font-bold text-slate-400 not-italic ml-1">Í≤ΩÏ£º</span></h2>
                                            <div className="flex bg-slate-800 rounded-lg p-0.5 ml-2 border border-slate-700">
                                                <button onClick={() => changeLocation('seoul')} className={`px-2.5 py-1.5 rounded-md text-[10px] font-black transition-all ${loc === 'seoul' ? 'bg-white text-slate-900 shadow-md' : 'text-slate-400'}`}>ÏÑúÏö∏</button>
                                                <button onClick={() => changeLocation('busan')} className={`px-2.5 py-1.5 rounded-md text-[10px] font-black transition-all ${loc === 'busan' ? 'bg-blue-600 text-white shadow-md shadow-blue-900/50' : 'text-slate-400'}`}>Î∂ÄÏÇ∞</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-4 flex gap-1.5 overflow-x-auto pb-2 scrollbar-hide">
                                    {races.map((r, i) => (
                                        <button key={i} onClick={() => { setRaceIdx(i); setExpanded(null); window.scrollTo({top:0, behavior:'smooth'}); }} className={`flex-shrink-0 w-9 h-9 rounded-full text-xs font-bold flex items-center justify-center transition-all ${raceIdx === i ? 'bg-yellow-400 text-slate-900 scale-110 shadow-lg ring-2 ring-yellow-400/30' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>{r.race_no}</button>
                                    ))}
                                </div>
                            </>
                        )}
                    </header>

                    <main className="flex-1 p-0 pb-24 space-y-5">
                        {viewMode === 'admin' ? (
                            <div className="p-6 animate-up">
                                <div className="bg-white p-6 rounded-3 shadow-lg border border-slate-100">
                                    <label className="block w-full cursor-pointer group">
                                        <div className="border-2 border-dashed border-slate-300 rounded-2xl p-8 text-center transition-colors group-hover:border-indigo-500 group-hover:bg-indigo-50">
                                            <span className="text-sm font-bold text-slate-600 group-hover:text-indigo-600">ÌååÏùº ÏÑ†ÌÉùÌïòÍ∏∞</span>
                                            <input type="file" accept=".json" onChange={handleJsonUpload} className="hidden" />
                                        </div>
                                    </label>
                                </div>
                            </div>
                        ) : (
                            <>
                                {info && (
                                    <div className="sticky top-0 z-50 px-4 pt-0 pb-2">
                                        <div className="sticky-header-blur rounded-3xl p-4 shadow-lg border border-slate-200/50 animate-up">
                                            <div className="flex items-center justify-between mb-2 pb-2 border-b border-slate-100">
                                                <div className="flex flex-col gap-1.5">
                                                    <div className="flex items-center gap-3">
                                                        <span className="bg-indigo-600 text-white text-[11px] font-black px-2.5 py-1 rounded-lg">{info.class}</span>
                                                        <span className="text-base font-bold text-slate-800 tabular">{info.distance}</span>
                                                        <span className="text-xs text-slate-400 font-medium tabular">| {info.start_time}</span>
                                                    </div>
                                                    {info.conditions && (
                                                        <div className="text-[10px] text-slate-500 font-bold flex items-center gap-1 mt-0.5 bg-slate-100/50 px-2 py-0.5 rounded-md w-fit">
                                                            <Icon name="info" size={10} className="text-slate-400"/> {info.conditions}
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="flex flex-col items-end">
                                                    <span className="text-[10px] text-slate-400 font-bold uppercase">Ïö∞ÏäπÎßà ÌèâÍ∑†Í∏∞Î°ù</span>
                                                    <div className="font-black text-slate-800 text-sm tabular flex items-center gap-1"><Icon name="timer" size={14} className="text-indigo-500"/>{stats?.avg_record || '-'}</div>
                                                </div>
                                            </div>
                                            {expert && (
                                                <div className="flex items-center gap-4 text-xs overflow-x-auto scrollbar-hide mt-1">
                                                    <div className="flex items-center gap-3 shrink-0">
                                                        <span className="bg-slate-900 text-white px-2.5 py-1 rounded-full text-[10px] font-bold">Ï∂îÏ≤ú</span>
                                                        <div className="flex -space-x-1">
                                                            {expert.picks?.map(no => <span key={no} className={`w-7 h-7 rounded-full font-bold text-xs flex items-center justify-center ${getBadgeStyle(no)}`}>{no}</span>)}
                                                        </div>
                                                    </div>
                                                    {expert.upset_picks && expert.upset_picks.length > 0 && (
                                                        <>
                                                            <div className="w-px h-6 bg-slate-200 shrink-0 mx-1"></div>
                                                            <div className="flex items-center gap-3 shrink-0">
                                                                <span className="bg-white border border-slate-200 text-slate-600 px-2.5 py-1 rounded-full text-[10px] font-bold">Î≥µÎ≥ë</span>
                                                                <div className="flex -space-x-1">
                                                                    {expert.upset_picks.map(no => <span key={no} className={`w-7 h-7 rounded-full font-bold text-xs flex items-center justify-center ${getBadgeStyle(no)}`}>{no}</span>)}
                                                                </div>
                                                            </div>
                                                        </>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}

                                <div className="px-4 space-y-3">
                                    {race?.horses.map((h, i) => {
                                        const isExp = expanded === h.horse_no;
                                        const picksText = expert?.picks_text?.find(p => parseInt(p.no) === h.horse_no)?.coment;
                                        const isPick = expert?.picks?.includes(h.horse_no);
                                        const targetDist = info ? parseInt(info.distance.replace(/\D/g, '')) : 0;
                                        const recentRecObj = h.recent_history?.find(r => r.distance === targetDist);
                                        const recentRecord = recentRecObj ? recentRecObj.record : null;
                                        const myWeight = getNum(h.weight);
                                        
                                        const badges = [];
                                        if (recentRecord) badges.push({ emoji: "‚è±Ô∏è", text: recentRecord, color: "yellow" });
                                        if (isPick) badges.push({ emoji: "‚≠ê", text: "Ï∂îÏ≤ú", color: "red" });
                                        if (expert?.upset_picks?.includes(h.horse_no)) badges.push({ emoji: "üí£", text: "Î≥µÎ≥ë", color: "purple" });

                                        if (h.horse_no === topDistHorseNo) badges.push({ emoji: "ü•á", text: `TOP ${formatTime(bestTimeMap[h.horse_no])}`, color: "yellow" });
                                        if (h.horse_no === avgDistHorseNo) badges.push({ emoji: "üìä", text: `AVG ${formatTime(avgTimeMap[h.horse_no])}`, color: "blue" });
                                        if (h.horse_no === recentDistHorseNo) badges.push({ emoji: "üïí", text: `REC ${formatTime(recentTimeMap[h.horse_no])}`, color: "green" });

                                        const actualHistory = h.recent_history?.filter(hist => !hist.class?.includes("Ï£ºÌñâ")) || [];
                                        const lastActualRace = actualHistory[0];
                                        
                                        if (info && h.grade) {
                                            const curRaceC = getClassNum(info.class);
                                            const horseGradeC = getClassNum(h.grade);
                                            const lastRaceC = lastActualRace ? getClassNum(lastActualRace.class) : null;

                                            if (curRaceC < horseGradeC) {
                                                badges.push({ emoji: "üöÄ", text: "Ï†êÌïëÏ†Ñ", color: "red" });
                                            } else if (curRaceC === horseGradeC) {
                                                const hasPlayedThisGrade = actualHistory.some(hist => getClassNum(hist.class) <= curRaceC);
                                                if (!hasPlayedThisGrade) {
                                                    if (curRaceC === 6) badges.push({ emoji: "üÜï", text: "Îç∞Î∑îÏ†Ñ", color: "red" });
                                                    else badges.push({ emoji: "üÜô", text: "ÏäπÍ∏âÏ†Ñ", color: "red" });
                                                }
                                            }
                                            if (lastRaceC !== null && curRaceC > lastRaceC) {
                                                badges.push({ emoji: "‚¨áÔ∏è", text: "Í∞ïÍ∏âÏ†Ñ", color: "gray" });
                                            }
                                        }

                                        if (lastActualRace && lastActualRace.jockey !== h.jockey) badges.push({ emoji: "üîÑ", text: "Í∏∞ÏàòÍµêÏ≤¥", color: "gray" });
                                        if (getNum(h.training_cnt) === maxTraining && maxTraining > 0) badges.push({ emoji: "üí™", text: "ÌõàÎ†®Ïôï", color: "blue" });
                                        if (getNum(h.rating) === maxRating && maxRating > 0) badges.push({ emoji: "üëë", text: "Î†àÏù¥ÌåÖÏôï", color: "purple" });
                                        if (myWeight > 0) {
                                            if (myWeight === minWeight) badges.push({ emoji: "ü™∂", text: "Î∂ÄÏ§ë‚Üì", color: "cyan" });
                                            if (myWeight === maxWeight) badges.push({ emoji: "üèãÔ∏è", text: "Î∂ÄÏ§ë‚Üë", color: "orange" });
                                        }
                                        
                                        if (h.horse_no === topStartHorseNo) badges.push({ emoji: "üöÄ", text: "Ï¥àÎ∞ò", color: "red" });
                                        if (h.horse_no === topFinishHorseNo) badges.push({ emoji: "‚ö°", text: "ÌõÑÎ∞ò", color: "blue" });

                                        return (
                                            <div key={h.horse_no} className={`bg-white rounded-2xl shadow-sm border transition-all duration-300 overflow-hidden animate-up ${isExp ? 'border-indigo-500 ring-1 ring-indigo-500' : 'border-slate-100'}`} style={{animationDelay: `${0.2 + (i * 0.05)}s`}}>
                                                <div className="p-3 flex items-center gap-3 cursor-pointer min-h-[70px]" onClick={() => setExpanded(isExp ? null : h.horse_no)}>
                                                    <div className={`w-[45px] h-[45px] rounded-xl flex items-center justify-center font-black text-lg italic tracking-tighter shrink-0 ${getBadgeStyle(h.horse_no)}`}>{h.horse_no}</div>
                                                    
                                                    {/* ÎßàÎ™Ö ÏÑπÏÖò: ÏõêÎ≥∏ Íµ¨Ï°∞ Î≥µÍµ¨ */}
                                                    <div className="flex flex-col justify-center shrink-0 w-[85px]">
                                                        <div className="flex items-center gap-1 mb-0.5">
                                                            <h3 className="font-bold text-slate-900 text-[15px] truncate">{h.name}</h3>
                                                            {isPick && <Icon name="thumbs-up" size={12} className="text-yellow-500 fill-yellow-500"/>}
                                                        </div>
                                                        <div className="text-[11px] text-slate-400 tabular">{h.origin}/{h.sex}/{h.age}</div>
                                                    </div>

                                                    {/* Î∞∞ÏßÄ ÏÑπÏÖò: ÏõêÎ≥∏ ÏúÑÏπò(Ïö∞Ï∏°) Î≥µÍµ¨ */}
                                                    <div className="flex-1 flex flex-wrap gap-1 items-center justify-start content-center min-h-[45px]">
                                                        {badges.map((b, idx) => (
                                                            <div key={idx} className={`flex-shrink-0 px-1.5 py-0.5 rounded flex items-center border ${
                                                                b.color === 'red' ? 'bg-red-50 text-red-600 border-red-100' :
                                                                b.color === 'blue' ? 'bg-blue-50 text-blue-600 border-blue-100' :
                                                                b.color === 'green' ? 'bg-emerald-50 text-emerald-600 border-emerald-100' :
                                                                b.color === 'purple' ? 'bg-purple-50 text-purple-600 border-purple-100' :
                                                                b.color === 'yellow' ? 'bg-yellow-50 text-yellow-700 border-yellow-200' :
                                                                b.color === 'cyan' ? 'bg-cyan-50 text-cyan-600 border-cyan-100' :
                                                                b.color === 'orange' ? 'bg-orange-50 text-orange-600 border-orange-100' :
                                                                'bg-slate-50 text-slate-600 border-slate-100'
                                                            }`}>
                                                                <span className="text-[10px] mr-1">{b.emoji}</span>
                                                                <span className="text-[9px] font-bold whitespace-nowrap">{b.text}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                                {isExp && (
                                                    <div className="bg-slate-50/50 border-t border-slate-100 p-5">
                                                        <div className="mb-4 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                                                            <div className="grid grid-cols-5 divide-x divide-slate-100">
                                                                <div className="p-2 text-center"><div className="text-[9px] text-slate-400 font-bold mb-0.5">Îì±Í∏â</div><div className="font-bold text-slate-800 text-xs">{h.grade}</div></div>
                                                                <div className="p-2 text-center"><div className="text-[9px] text-slate-400 font-bold mb-0.5">Î∂ÄÏ§ë</div><div className="font-bold text-slate-800 text-xs">{h.weight}</div></div>
                                                                <div className="p-2 text-center bg-blue-50/30"><div className="text-[9px] text-blue-500 font-bold mb-0.5">ÌõàÎ†®</div><div className="font-bold text-blue-700 text-xs">{h.training_cnt || '-'}Ìöå</div></div>
                                                                <div className="p-2 text-center bg-blue-50/30"><div className="text-[9px] text-blue-500 font-bold mb-0.5">Ï£ºÍ∏∞</div><div className="font-bold text-blue-700 text-xs">{h.participation_period || '-'}</div></div>
                                                                <div className="p-2 text-center"><div className="text-[9px] text-slate-400 font-bold mb-0.5">Î†àÏù¥ÌåÖ</div><div className="font-bold text-slate-800 text-xs">{h.rating}</div></div>
                                                            </div>
                                                        </div>

                                                        {picksText ? (
                                                            <div className="mb-4 bg-white p-4 rounded-2xl border-l-[3px] border-yellow-400 shadow-sm">
                                                                <div className="flex items-center gap-2 mb-2 text-yellow-600 font-black text-[10px] uppercase tracking-wider">
                                                                    <Icon name="message-circle" size={12}/> Expert Insight
                                                                </div>
                                                                <p className="text-[13px] font-medium text-slate-700 leading-relaxed break-keep tracking-tight">
                                                                    {picksText}
                                                                </p>
                                                            </div>
                                                        ) : (
                                                            <div className="mb-4 text-center text-xs text-slate-400 py-2 border border-dashed border-slate-200 rounded-xl">Ï†ÑÎ¨∏Í∞Ä ÏΩîÎ©òÌä∏ ÏóÜÏùå</div>
                                                        )}

                                                        <div className="grid grid-cols-3 gap-3 mb-5">
                                                            <div className="bg-white p-2.5 rounded-xl border border-slate-200 shadow-sm text-center">
                                                                <div className="text-[9px] text-slate-400 font-bold mb-1 uppercase">Í∏∞Ïàò</div>
                                                                <div className="font-bold text-slate-800 text-xs truncate">{h.jockey}</div>
                                                            </div>
                                                            <div className="bg-white p-2.5 rounded-xl border border-slate-200 shadow-sm text-center">
                                                                <div className="text-[9px] text-slate-400 font-bold mb-1 uppercase">Ï°∞ÍµêÏÇ¨</div>
                                                                <div className="font-bold text-slate-800 text-xs truncate">{h.trainer}</div>
                                                            </div>
                                                            <div className="bg-white p-2.5 rounded-xl border border-slate-200 shadow-sm text-center">
                                                                <div className="text-[9px] text-slate-400 font-bold mb-1 uppercase">ÎßàÏ£º</div>
                                                                <div className="font-bold text-slate-800 text-xs truncate">{h.owner}</div>
                                                            </div>
                                                        </div>

                                                        <div className="overflow-x-auto bg-white rounded-xl border border-slate-200">
                                                            <table className="w-full text-[11px] text-center whitespace-nowrap">
                                                                <thead className="bg-slate-50 text-slate-400 border-b">
                                                                    <tr>
                                                                        <th className="py-2 px-2">ÎÇ†Ïßú</th>
                                                                        <th>Îì±Í∏â</th>
                                                                        <th>Í±∞Î¶¨</th>
                                                                        <th>Í∏∞Î°ù</th>
                                                                        <th>ÏàúÏúÑ</th>
                                                                        <th>Î∂ÄÏ§ë</th>
                                                                        <th>Í∏∞Ïàò</th>
                                                                        <th>S1F</th>
                                                                        <th>G3F</th>
                                                                        <th>G1F</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody className="divide-y tabular">
                                                                    {h.recent_history?.map((hist, hIdx) => (
                                                                        <tr key={hIdx}>
                                                                            <td className="py-2 px-2 text-slate-500">{hist.date}</td>
                                                                            <td className="text-slate-700 text-[10px]">{hist.class}</td>
                                                                            <td>{hist.distance}</td>
                                                                            <td className="font-bold text-slate-900">{hist.record}</td>
                                                                            <td className={`font-bold ${hist.result_rank <= 3 ? 'text-rose-600' : 'text-slate-400'}`}>{hist.result_rank}ÏúÑ</td>
                                                                            <td className="text-slate-600">{hist.weight}</td>
                                                                            <td className="text-[10px]">{hist.jockey}</td>
                                                                            <td>{hist.s1f}</td>
                                                                            <td className="text-green-600 font-bold">{hist.g3f}</td>
                                                                            <td>{hist.g1f}</td>
                                                                        </tr>
                                                                    ))}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                                {stats && (
                                    <div className="px-4 pb-10">
                                        <div className="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 animate-up">
                                            <h3 className="text-sm font-black text-slate-800 flex items-center gap-2 mb-6"><div className="bg-green-100 p-1 rounded text-green-600"><Icon name="bar-chart-2" size={14}/></div>Îç∞Ïù¥ÌÑ∞ Ï†ïÎ∞Ä Î∂ÑÏÑù</h3>
                                            <div className="space-y-8">
                                                <div><div className="flex justify-between items-center mb-3"><span className="text-[11px] font-bold text-red-500 bg-red-50 px-2 py-1 rounded-md">Ï¥àÎ∞ò Ïä§ÌîºÎìú (S1F)</span></div><BarChart data={stats.fast_start_horses} color="red" /></div>
                                                <div><div className="flex justify-between items-center mb-3"><span className="text-[11px] font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded-md">ÌõÑÎ∞ò ÌÉÑÎ†• (G1F)</span></div><BarChart data={stats.fast_finish_horses} color="blue" /></div>
                                            </div>
                                        </div>
                                    </div>
                                ) || <div className="px-4 py-10 text-center text-slate-400 text-xs">ÏÑ†ÌÉùÎêú Í≤ΩÏ£ºÏóê ÎåÄÌïú Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>}
                            </>
                        )}
                    </main>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
