<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²½ë§ˆ ë°ì´í„° í†µí•© ì…ë ¥ê¸° (Smart OCR)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- Tesseract.js CDN -->
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    <!-- heic2any CDN: ì•„ì´í° HEIC ì´ë¯¸ì§€ ë³€í™˜ìš© -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.3/heic2any.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .hidden { display: none; }
        .custom-table th { background-color: #f3f4f6; position: sticky; top: 0; z-index: 10; }
        .custom-table td { vertical-align: middle; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #16a34a; /* Green for this unified view */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

    <div class="max-w-6xl mx-auto p-4 md:p-6">
        <!-- í—¤ë” -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ‡ ê²½ë§ˆ í†µí•© ë°ì´í„° ì…ë ¥ê¸°</h1>
            <p class="text-gray-600">ì²´ì¤‘í˜„í™© íŒŒì¼ì„ ê¸°ì¤€ìœ¼ë¡œ ì²´ì¤‘, ì¦ê°, ë°°ë‹¹ì„ ì…ë ¥í•˜ê³  í•¨ìˆ˜ìœ¨ì„ ì§€ì •í•˜ì„¸ìš”.</p>
        </div>

        <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
        <div id="mainContainer" class="block">
            
            <!-- Step 1: íŒŒì¼ ì—…ë¡œë“œ -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-bold mb-4 text-green-700 flex items-center">
                    <span class="bg-green-100 text-green-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm border border-green-200">1</span>
                    ì²´ì¤‘í˜„í™© íŒŒì¼ ì—…ë¡œë“œ (CSV)
                </h2>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-green-500 transition-colors bg-gray-50">
                    <input type="file" id="weightFileInput" accept=".csv" class="hidden">
                    <label for="weightFileInput" class="cursor-pointer block">
                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <span class="block text-lg font-medium text-gray-700 mb-1">ì²´ì¤‘í˜„í™© CSV íŒŒì¼ ì„ íƒ</span>
                        <span class="text-sm text-gray-500">í´ë¦­í•˜ì—¬ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</span>
                    </label>
                    <div id="weightFileName" class="mt-4 text-base font-semibold text-green-600 hidden bg-green-50 inline-block px-4 py-1 rounded-full border border-green-200"></div>
                </div>
            </div>

            <!-- Step 2: ë°ì´í„° ì…ë ¥ -->
            <div id="weightStep2" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <div class="flex flex-col xl:flex-row justify-between items-start xl:items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold text-green-700 flex items-center">
                        <span class="bg-green-100 text-green-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm border border-green-200">2</span>
                        ë°ì´í„° ì…ë ¥ (ì²´ì¤‘ / ì¦ê° / ë°°ë‹¹)
                    </h2>
                    
                    <div class="flex flex-wrap items-center gap-3 bg-gray-50 p-3 rounded-lg border border-gray-200 w-full xl:w-auto">
                        <div class="flex items-center mr-4">
                            <input type="checkbox" id="weightUsePreprocess" checked class="w-5 h-5 text-green-600 rounded border-gray-300 focus:ring-green-500">
                            <label for="weightUsePreprocess" class="ml-2 text-sm font-bold text-gray-700 cursor-pointer">ê³ ëŒ€ë¹„ í•„í„° (ì¸ì‹ë¥ â†‘)</label>
                        </div>
                        
                        <!-- ì²´ì¤‘ OCR ë²„íŠ¼ -->
                        <div class="relative">
                            <input type="file" id="weightImageInput" accept="image/*, .heic, .heif" class="hidden">
                            <button onclick="document.getElementById('weightImageInput').click()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2.5 rounded shadow flex items-center text-sm font-bold transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path></svg>
                                ğŸ“· ì²´ì¤‘/ì¦ê° ì¸ì‹
                            </button>
                        </div>

                        <!-- ë°°ë‹¹ OCR ë²„íŠ¼ -->
                        <div class="relative">
                            <input type="file" id="weightOddsImageInput" accept="image/*, .heic, .heif" class="hidden">
                            <button onclick="document.getElementById('weightOddsImageInput').click()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2.5 rounded shadow flex items-center text-sm font-bold transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                ğŸ“· ë°°ë‹¹ ì¸ì‹
                            </button>
                        </div>
                    </div>
                </div>

                <!-- OCR ì§„í–‰ìƒíƒœ í‘œì‹œ -->
                <div id="weightOcrStatus" class="hidden mb-4 bg-green-50 p-4 rounded border border-green-200 text-sm text-green-800 animate-pulse">
                    <div class="flex items-center mb-2">
                        <div class="loader mr-3"></div>
                        <span id="weightOcrMsg" class="font-bold text-lg">ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...</span>
                    </div>
                    <p class="text-green-600 ml-9">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. ì‚¬ì§„ì´ í´ìˆ˜ë¡ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>

                <div class="overflow-x-auto bg-white border border-gray-200 rounded-lg max-h-[600px] overflow-y-auto shadow-inner">
                    <table class="min-w-full divide-y divide-gray-200 custom-table text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-center font-extrabold text-gray-600 w-16 border-b-2">ë²ˆí˜¸</th>
                                <th class="px-4 py-3 text-left font-extrabold text-gray-600 border-b-2">ë§ˆëª…</th>
                                <th class="px-4 py-3 text-center font-extrabold text-green-700 w-32 border-b-2 bg-green-50">ì²´ì¤‘</th>
                                <th class="px-4 py-3 text-center font-extrabold text-red-600 w-28 border-b-2 bg-red-50">ì¦ê°(+/-)</th>
                                <th class="px-4 py-3 text-center font-extrabold text-blue-700 w-32 border-b-2 bg-blue-50">ë°°ë‹¹(ë‹¨ìŠ¹)</th>
                            </tr>
                        </thead>
                        <tbody id="weightTableBody" class="divide-y divide-gray-200 bg-white"></tbody>
                    </table>
                </div>
            </div>

            <!-- Step 3: ë‹¤ìš´ë¡œë“œ -->
            <div id="weightStep3" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <h2 class="text-xl font-bold mb-4 text-green-700 flex items-center">
                    <span class="bg-green-100 text-green-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm border border-green-200">3</span>
                    ìµœì¢… íŒŒì¼ ì„¤ì • ë° ë‹¤ìš´ë¡œë“œ
                </h2>

                <div class="flex flex-col items-center justify-center gap-4">
                    <!-- í•¨ìˆ˜ìœ¨ ì…ë ¥ í•„ë“œ ì¶”ê°€ -->
                    <div class="w-full md:w-2/3 bg-blue-50 p-4 rounded-lg border border-blue-200 flex flex-col md:flex-row items-center justify-between gap-4">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">ğŸ’§</span>
                            <label for="moistureInput" class="font-bold text-blue-800 text-lg whitespace-nowrap">í•¨ìˆ˜ìœ¨ ì…ë ¥(%):</label>
                        </div>
                        <input type="number" id="moistureInput" class="flex-grow p-3 border-2 border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg font-bold text-center text-blue-900" placeholder="ì˜ˆ: 5 (ìˆ«ìë§Œ ì…ë ¥)">
                        <span class="text-sm text-blue-600 font-medium">* íŒŒì¼ëª…ì— ìë™ í¬í•¨ë©ë‹ˆë‹¤.</span>
                    </div>

                    <button id="weightDownloadBtn" class="w-full md:w-2/3 bg-gray-800 hover:bg-gray-900 text-white font-bold py-4 rounded-xl shadow-lg transition-transform transform hover:-translate-y-0.5 flex items-center justify-center text-lg mt-2">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        í†µí•© íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                    </button>
                    <p class="mt-2 text-sm text-gray-500 text-center">íŒŒì¼ëª… í˜•ì‹: <strong>[ì›ë³¸ëª…]_ë°°ë‹¹_í•¨ìˆ˜ìœ¨[N]%.csv</strong></p>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // ==========================================
        // [HEIC File Handling]
        // ==========================================
        async function checkAndConvertHEIC(file, statusElId, msgElId) {
            const statusEl = document.getElementById(statusElId);
            const msgEl = document.getElementById(msgElId);

            if (file.type === "image/heic" || file.type === "image/heif" || file.name.toLowerCase().endsWith(".heic")) {
                statusEl.classList.remove('hidden');
                msgEl.textContent = "ì•„ì´í° ì´ë¯¸ì§€(HEIC) ë³€í™˜ ì¤‘...";
                
                try {
                    const convertedBlob = await heic2any({ blob: file, toType: "image/jpeg", quality: 0.8 });
                    return Array.isArray(convertedBlob) ? convertedBlob[0] : convertedBlob;
                } catch (error) {
                    console.error("HEIC conversion failed:", error);
                    alert("HEIC ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    statusEl.classList.add('hidden');
                    return null;
                }
            }
            return file;
        }

        // ==========================================
        // [Advanced Image Preprocessing]
        // ==========================================
        function preprocessImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const scaleFactor = 2; 
                    canvas.width = img.width * scaleFactor;
                    canvas.height = img.height * scaleFactor;
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        const brightness = 0.34 * data[i] + 0.5 * data[i + 1] + 0.16 * data[i + 2];
                        const threshold = brightness < 140 ? 0 : 255;
                        data[i] = threshold;     // R
                        data[i + 1] = threshold; // G
                        data[i + 2] = threshold; // B
                    }
                    ctx.putImageData(imageData, 0, 0);
                    
                    canvas.toBlob((blob) => {
                        callback(blob);
                    }, 'image/png');
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ==========================================
        // [OCR Core Function]
        // ==========================================
        async function runOCR(imageFile, statusElementId, msgElementId, usePreprocess, whitelistChars, callback) {
            const statusEl = document.getElementById(statusElementId);
            const msgEl = document.getElementById(msgElementId);
            
            statusEl.classList.remove('hidden');
            msgEl.textContent = "ì´ë¯¸ì§€ ì „ì²˜ë¦¬ ì¤‘...";

            const executeTesseract = async (blobToProcess) => {
                msgEl.textContent = "OCR ì—”ì§„ ì´ˆê¸°í™” ë° ë¶„ì„ ì¤‘...";
                try {
                    const { data: { text } } = await Tesseract.recognize(
                        blobToProcess,
                        'eng',
                        {
                            tessedit_char_whitelist: whitelistChars,
                            logger: m => {
                                if(m.status === 'recognizing text') {
                                    msgEl.textContent = `ê¸€ì ì¸ì‹ ì¤‘... ${(m.progress * 100).toFixed(0)}%`;
                                }
                            }
                        }
                    );
                    msgEl.textContent = "ì™„ë£Œ! ë°ì´í„°ë¥¼ ì ìš©í•©ë‹ˆë‹¤.";
                    setTimeout(() => statusEl.classList.add('hidden'), 1500);
                    console.log("OCR Raw Text:", text);
                    callback(text);
                } catch (error) {
                    console.error(error);
                    msgEl.textContent = "ì˜¤ë¥˜ ë°œìƒ: ì¸ì‹ì„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                    alert("OCR ì˜¤ë¥˜ì…ë‹ˆë‹¤.");
                    statusEl.classList.add('hidden');
                }
            };

            if (usePreprocess) {
                preprocessImage(imageFile, (processedBlob) => {
                    executeTesseract(processedBlob);
                });
            } else {
                executeTesseract(imageFile);
            }
        }

        // ==========================================
        // [í†µí•© ë¡œì§] ì²´ì¤‘ + ë°°ë‹¹
        // ==========================================
        let weightData = { meta: [], header: [], rows: [], fileName: "", headerIndex: 0 };
        const weightFileInput = document.getElementById('weightFileInput');
        const weightTableBody = document.getElementById('weightTableBody');
        const weightImageInput = document.getElementById('weightImageInput');
        const weightOddsImageInput = document.getElementById('weightOddsImageInput');

        weightFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('weightFileName').textContent = file.name;
            document.getElementById('weightFileName').classList.remove('hidden');
            weightData.fileName = file.name.replace('.csv', '');
            const reader = new FileReader();
            reader.onload = function(evt) {
                const lines = evt.target.result.split(/\r\n|\n/);
                // í—¤ë” ì°¾ê¸° (ë²ˆí˜¸, ë§ˆëª… í•„ìˆ˜)
                let hIndex = lines.findIndex(l => (l.includes('ë²ˆí˜¸') || l.includes('No')) && l.includes('ë§ˆëª…'));
                if(hIndex === -1) hIndex = 0;
                weightData.headerIndex = hIndex;
                weightData.meta = lines.slice(0, hIndex);
                const dataPart = lines.slice(hIndex).join('\n');
                Papa.parse(dataPart, {
                    header: true, skipEmptyLines: true,
                    complete: function(res) {
                        weightData.header = res.meta.fields;
                        weightData.rows = res.data;
                        renderWeightTable(weightData.rows);
                        document.getElementById('weightStep2').classList.remove('hidden');
                        document.getElementById('weightStep3').classList.remove('hidden');
                    }
                });
            };
            reader.readAsText(file, 'UTF-8');
        });

        // [ì²´ì¤‘ OCR íŠ¸ë¦¬ê±°]
        weightImageInput.addEventListener('change', async (e) => {
            let file = e.target.files[0];
            if(!file) return;
            file = await checkAndConvertHEIC(file, 'weightOcrStatus', 'weightOcrMsg');
            if(!file) return;

            const usePre = document.getElementById('weightUsePreprocess').checked;
            const whitelist = '0123456789+-\n '; 

            runOCR(file, 'weightOcrStatus', 'weightOcrMsg', usePre, whitelist, (text) => {
                const lines = text.split('\n');
                const wInputs = document.querySelectorAll('.weight-val');
                let matchCount = 0;

                wInputs.forEach(wInput => {
                    const horseNum = wInput.dataset.id;
                    const cInput = document.querySelector(`.weight-chg[data-id="${horseNum}"]`);
                    
                    for(let line of lines) {
                        let cleanLine = line.trim();
                        // ë§ˆë²ˆìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ë¼ì¸ ì°¾ê¸°
                        if (cleanLine.startsWith(horseNum)) {
                            // íŒ¨í„´: [ë§ˆë²ˆ] ... [ì²´ì¤‘3ìë¦¬:300~699] ...
                            const weightMatch = cleanLine.match(/\b([3-6]\d{2})\b/);
                            if (weightMatch) {
                                wInput.value = weightMatch[1];
                                wInput.classList.add('bg-green-100', 'ring-2', 'ring-green-400');
                                
                                // ì²´ì¤‘ ë’¤ì— ìˆëŠ” ë¬¸ìì—´ì—ì„œ ì¦ê°(+/-ìˆ«ì) ì°¾ê¸°
                                const afterWeight = cleanLine.substring(cleanLine.indexOf(weightMatch[1]) + 3);
                                const changeMatch = afterWeight.match(/([+-]?\d{1,2})\b/);
                                
                                if (changeMatch) {
                                    cInput.value = changeMatch[1];
                                    cInput.classList.add('bg-green-100', 'ring-2', 'ring-green-400');
                                }
                                matchCount++;
                                break;
                            }
                        }
                    }
                });
                if(matchCount === 0) alert("ì¸ì‹ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                else alert(`${matchCount}ë§ˆë¦¬ì˜ ì²´ì¤‘ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            });
            weightImageInput.value = '';
        });

        // [ë°°ë‹¹ OCR íŠ¸ë¦¬ê±°]
        weightOddsImageInput.addEventListener('change', async (e) => {
            let file = e.target.files[0];
            if(!file) return;
            file = await checkAndConvertHEIC(file, 'weightOcrStatus', 'weightOcrMsg');
            if(!file) return;

            const usePre = document.getElementById('weightUsePreprocess').checked;
            // ë°°ë‹¹ì€ ì†Œìˆ˜ì  í•„ìˆ˜
            const whitelist = '0123456789.\n '; 

            runOCR(file, 'weightOcrStatus', 'weightOcrMsg', usePre, whitelist, (text) => {
                const lines = text.split('\n');
                const oInputs = document.querySelectorAll('.weight-odds-val');
                let matchCount = 0;

                oInputs.forEach(input => {
                    const horseNum = input.dataset.id;
                    for(let line of lines) {
                        let cleanLine = line.trim();
                        // ë°°ë‹¹ OCR íŒ¨í„´: [ë§ˆë²ˆ] [ê³µë°±] [ë°°ë‹¹ë¥ (ì†Œìˆ˜ì )]
                        // ì˜ˆ: "1 3.5", "10 12.3"
                        const regex = new RegExp(`^${horseNum}\\s+(\\d+\\.\\d+)`);
                        const match = cleanLine.match(regex);
                        if (match) {
                            input.value = match[1];
                            input.classList.add('bg-blue-100', 'ring-2', 'ring-blue-400');
                            matchCount++;
                            break;
                        }
                    }
                });
                if(matchCount === 0) alert("ì¸ì‹ëœ ë°°ë‹¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                else alert(`${matchCount}ë§ˆë¦¬ì˜ ë°°ë‹¹ ì •ë³´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            });
            weightOddsImageInput.value = '';
        });

        function renderWeightTable(rows) {
            weightTableBody.innerHTML = '';
            rows.forEach((row, idx) => {
                const numKey = Object.keys(row).find(k => k.includes('ë²ˆí˜¸'));
                const nameKey = Object.keys(row).find(k => k.includes('ë§ˆëª…'));
                
                // ê¸°ì¡´ ì²´ì¤‘/ì¦ê° ì»¬ëŸ¼ ì°¾ê¸° (ì—†ìœ¼ë©´ ê³µë€)
                const weightKey = Object.keys(row).find(k => k.includes('ì²´ì¤‘') && !k.includes('ì¦ê°'));
                const changeKey = Object.keys(row).find(k => k.includes('ì¦ê°'));

                const num = row[numKey] || (idx+1);
                const name = row[nameKey] || '';
                if(!name && !num) return; // ìœ íš¨í•˜ì§€ ì•Šì€ í–‰ ìŠ¤í‚µ

                const currentWeight = row[weightKey] || '';
                const currentChange = row[changeKey] || '';

                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors";
                tr.innerHTML = `
                    <td class="px-4 py-3 text-center font-bold text-gray-700">${num}</td>
                    <td class="px-4 py-3 text-gray-800 font-medium">${name}</td>
                    <td class="px-4 py-3 text-center">
                        <input type="number" data-id="${num}" value="${currentWeight}" class="weight-val w-28 text-center border border-gray-300 rounded-md p-2 font-bold text-green-700 focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition-shadow" placeholder="ì²´ì¤‘">
                    </td>
                    <td class="px-4 py-3 text-center">
                        <input type="text" data-id="${num}" value="${currentChange}" class="weight-chg w-24 text-center border border-gray-300 rounded-md p-2 font-bold text-red-600 focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-shadow" placeholder="+/-">
                    </td>
                    <td class="px-4 py-3 text-center">
                        <input type="number" step="0.1" data-id="${num}" class="weight-odds-val w-28 text-center border border-blue-300 rounded-md p-2 font-bold text-blue-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow" placeholder="0.0">
                    </td>
                `;
                weightTableBody.appendChild(tr);
            });
        }

        document.getElementById('weightDownloadBtn').addEventListener('click', () => {
            const wInputs = document.querySelectorAll('.weight-val');
            const cInputs = document.querySelectorAll('.weight-chg');
            const oInputs = document.querySelectorAll('.weight-odds-val'); 
            const moistureInput = document.getElementById('moistureInput');
            const moistureVal = moistureInput.value.trim();

            if (!moistureVal) {
                if(!confirm("í•¨ìˆ˜ìœ¨ì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í•¨ìˆ˜ìœ¨ ì—†ì´ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            }
            
            const wMap = {}, cMap = {}, oMap = {};
            wInputs.forEach(inp => wMap[inp.dataset.id] = inp.value);
            cInputs.forEach(inp => cMap[inp.dataset.id] = inp.value);
            oInputs.forEach(inp => oMap[inp.dataset.id] = inp.value);

            const newRows = weightData.rows.map(row => {
                const numKey = Object.keys(row).find(k => k.includes('ë²ˆí˜¸'));
                const num = row[numKey];
                
                // ê¸°ì¡´ ì»¬ëŸ¼ëª…ì„ ìµœëŒ€í•œ ìœ ì§€í•˜ë˜ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
                const weightKey = Object.keys(row).find(k => k.includes('ì²´ì¤‘') && !k.includes('ì¦ê°')) || 'ê¸ˆì¼ì²´ì¤‘';
                const changeKey = Object.keys(row).find(k => k.includes('ì¦ê°')) || 'ì¦ê°';
                
                let newRow = { ...row };
                
                // ê°’ ì—…ë°ì´íŠ¸
                newRow[weightKey] = wMap[num] || '';
                newRow[changeKey] = cMap[num] || '';
                
                // ë°°ë‹¹ì€ ë¬´ì¡°ê±´ ìƒˆë¡œ ì¶”ê°€/ë®ì–´ì“°ê¸°
                newRow['ë‹¨ìŠ¹ë°°ë‹¹ë¥ '] = oMap[num] || ''; 
                
                return newRow;
            });

            // í—¤ë” ì¬êµ¬ì„±
            let finalHeader = [...weightData.header];
            const weightKey = finalHeader.find(k => k.includes('ì²´ì¤‘') && !k.includes('ì¦ê°')) || 'ê¸ˆì¼ì²´ì¤‘';
            const changeKey = finalHeader.find(k => k.includes('ì¦ê°')) || 'ì¦ê°';
            
            if(!finalHeader.includes(weightKey)) finalHeader.push(weightKey);
            if(!finalHeader.includes(changeKey)) finalHeader.push(changeKey);
            
            finalHeader = finalHeader.filter(h => h !== 'ë‹¨ìŠ¹ë°°ë‹¹ë¥ '); 
            finalHeader.push('ë‹¨ìŠ¹ë°°ë‹¹ë¥ ');

            const csvBody = Papa.unparse(newRows, { quotes: false, columns: finalHeader });
            const metaStr = weightData.meta.length > 0 ? weightData.meta.join('\n') + '\n' : '';
            
            // ===============================================
            // [íŒŒì¼ëª… ìƒì„± ë¡œì§ ìˆ˜ì •] - ë°°ë‹¹ê³¼ í•¨ìˆ˜ìœ¨ë§Œ ì¶”ê°€
            // ===============================================
            let baseName = weightData.fileName;
            
            // 1. ê¸°ì¡´ í•¨ìˆ˜ìœ¨ íƒœê·¸ ì œê±° (ì—…ë°ì´íŠ¸ ìƒí™© ê³ ë ¤, ì¤‘ë³µ ë°©ì§€)
            baseName = baseName.replace(/_í•¨ìˆ˜ìœ¨\d+%?/g, '');

            // 2. 'ë°°ë‹¹' ì¤‘ë³µ ë°©ì§€ ì²´í¬ í›„ ì¶”ê°€
            if (!baseName.includes('ë°°ë‹¹')) {
                baseName += "_ë°°ë‹¹";
            }

            // 3. ìƒˆ í•¨ìˆ˜ìœ¨ ì¶”ê°€
            const moistureSuffix = moistureVal ? `_í•¨ìˆ˜ìœ¨${moistureVal}%` : '';
            const finalFileName = `${baseName}${moistureSuffix}.csv`;

            downloadFile(metaStr + csvBody, finalFileName);
        });

        function downloadFile(content, fileName) {
            const blob = new Blob(["\uFEFF" + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        setupDragDrop('weightFileInput', 'bg-green-50', 'border-green-500');

        function setupDragDrop(inputId, bgClass, borderClass) {
            const input = document.getElementById(inputId);
            const dropZone = input.parentElement;
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add(borderClass, bgClass); });
            dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove(borderClass, bgClass); });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault(); dropZone.classList.remove(borderClass, bgClass);
                if (e.dataTransfer.files.length > 0) { input.files = e.dataTransfer.files; input.dispatchEvent(new Event('change')); }
            });
        }
    });
    </script>
</body>
</html>
