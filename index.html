<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²½ë§ˆ ë‹¨ìŠ¹ ë°°ë‹¹ë¥  ì…ë ¥ê¸° (ë©”íƒ€ë°ì´í„° ìë™ì¸ì‹)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .step-card { transition: all 0.3s ease-in-out; }
        .hidden { display: none; }
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .custom-table th { background-color: #f3f4f6; position: sticky; top: 0; z-index: 10; }
        .custom-table td { vertical-align: middle; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

    <div class="max-w-4xl mx-auto p-4 md:p-6">
        <!-- í—¤ë” -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-blue-700 mb-2">ğŸ‡ ê²½ë§ˆ ë‹¨ìŠ¹ ë°°ë‹¹ë¥  ì…ë ¥ê¸°</h1>
            <p class="text-gray-600">ì¶œì „í‘œ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ë°°ë‹¹ë¥ ê³¼ í•¨ìˆ˜ìœ¨ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
        </div>

        <!-- Step 1: íŒŒì¼ ì—…ë¡œë“œ -->
        <div id="step1" class="step-card bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <span class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm">1</span>
                ì¶œì „í‘œ íŒŒì¼ ì„ íƒ
            </h2>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition-colors bg-gray-50">
                <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                <label for="csvFileInput" class="cursor-pointer flex flex-col items-center justify-center">
                    <svg class="w-12 h-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <span class="text-lg font-medium text-gray-700">ì—¬ê¸°ë¥¼ í´ë¦­í•˜ì—¬ CSV íŒŒì¼ ì—…ë¡œë“œ</span>
                    <span class="text-sm text-gray-500 mt-1">ë˜ëŠ” íŒŒì¼ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”</span>
                </label>
                <div id="fileNameDisplay" class="mt-4 text-sm font-semibold text-blue-600 hidden"></div>
            </div>
        </div>

        <!-- Step 2: ë°ì´í„° ì…ë ¥ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
        <div id="step2" class="step-card bg-white p-6 rounded-lg shadow-md mb-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold flex items-center">
                    <span class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm">2</span>
                    ë°°ë‹¹ë¥  ë° í•¨ìˆ˜ìœ¨ ì…ë ¥
                </h2>
                <div class="flex items-center space-x-2">
                    <label for="moistureInput" class="font-bold text-gray-700">í•¨ìˆ˜ìœ¨(%):</label>
                    <input type="number" id="moistureInput" placeholder="ì˜ˆ: 3" class="border border-gray-300 rounded px-3 py-1 w-24 text-right focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>

            <div class="overflow-x-auto bg-white border border-gray-200 rounded-lg max-h-[500px] overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200 custom-table text-sm">
                    <thead>
                        <tr>
                            <th class="px-4 py-3 text-center font-bold text-gray-600 w-16">ë²ˆí˜¸</th>
                            <th class="px-4 py-3 text-left font-bold text-gray-600">ë§ˆëª…</th>
                            <th class="px-4 py-3 text-center font-bold text-gray-600">ê¸°ìˆ˜</th>
                            <th class="px-4 py-3 text-center font-bold text-blue-600 w-32">ë‹¨ìŠ¹ ë°°ë‹¹ë¥ </th>
                        </tr>
                    </thead>
                    <tbody id="horseTableBody" class="divide-y divide-gray-200">
                        <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ë°ì´í„° ë¡œë“œë¨ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Step 3: ë‹¤ìš´ë¡œë“œ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
        <div id="step3" class="step-card bg-white p-6 rounded-lg shadow-md mb-6 hidden">
            <button id="downloadBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg shadow transition-colors flex items-center justify-center text-lg">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                ìˆ˜ì •ëœ CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            </button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const fileInput = document.getElementById('csvFileInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const horseTableBody = document.getElementById('horseTableBody');
        const downloadBtn = document.getElementById('downloadBtn');
        const moistureInput = document.getElementById('moistureInput');
        
        // ì „ì—­ ë³€ìˆ˜ë¡œ ë°ì´í„° ì €ì¥
        let originalMetaData = []; // í—¤ë” ìœ—ë¶€ë¶„ (ê²½ì£¼ ë‚ ì§œ ë“±)
        let originalHeader = [];   // ì‹¤ì œ í—¤ë” (ë²ˆí˜¸, ë§ˆëª…...)
        let parsedData = [];       // ì‹¤ì œ ë°ì´í„° í–‰ë“¤
        let originalFileName = ""; // ì›ë³¸ íŒŒì¼ëª…
        let headerRowIndex = 0;    // í—¤ë”ê°€ ë°œê²¬ëœ ì¤„ ë²ˆí˜¸

        // 1. íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            originalFileName = file.name.replace('.csv', ''); // í™•ì¥ì ì œê±°
            fileNameDisplay.textContent = `ì„ íƒëœ íŒŒì¼: ${file.name}`;
            fileNameDisplay.classList.remove('hidden');

            const reader = new FileReader();
            
            reader.onload = function(e) {
                const csvText = e.target.result;
                
                // ì¤„ ë‹¨ìœ„ë¡œ ë¶„ë¦¬
                const lines = csvText.split(/\r\n|\n/);
                
                // "ë²ˆí˜¸"ì™€ "ë§ˆëª…"ì´ í¬í•¨ëœ ì¤„ì„ ì°¾ì•„ì„œ í—¤ë”ë¡œ ì¸ì‹ (í•µì‹¬ ìˆ˜ì • ì‚¬í•­)
                headerRowIndex = lines.findIndex(line => 
                    (line.includes('ë²ˆí˜¸') || line.includes('No')) && line.includes('ë§ˆëª…')
                );

                if (headerRowIndex === -1) {
                    // í—¤ë”ë¥¼ ëª» ì°¾ì€ ê²½ìš° ì²« ì¤„ì„ í—¤ë”ë¡œ ê°€ì •í•˜ê±°ë‚˜ ì—ëŸ¬ ì²˜ë¦¬
                    headerRowIndex = 0; 
                    alert('ë°ì´í„° í˜•ì‹ì„ ìë™ìœ¼ë¡œ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. í‘œì¤€ í˜•ì‹ì´ ë§ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }

                // ë©”íƒ€ë°ì´í„°(í—¤ë” ìœ—ë¶€ë¶„) ì €ì¥
                originalMetaData = lines.slice(0, headerRowIndex);
                
                // ì‹¤ì œ ë°ì´í„° íŒŒì‹± (í—¤ë” í¬í•¨ ì•„ë«ë¶€ë¶„ë§Œ)
                // join('\n')ìœ¼ë¡œ ë‹¤ì‹œ í•©ì³ì„œ PapaParseì— ë„˜ê¹€
                const dataPart = lines.slice(headerRowIndex).join('\n');
                
                Papa.parse(dataPart, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        originalHeader = results.meta.fields;
                        parsedData = results.data;
                        renderTable(parsedData);
                        
                        // UI í‘œì‹œ
                        document.getElementById('step2').classList.remove('hidden');
                        document.getElementById('step3').classList.remove('hidden');
                    },
                    error: function(err) {
                        console.error(err);
                        alert("CSV íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            };

            reader.readAsText(file, 'UTF-8'); // í•œê¸€ ê¹¨ì§ ë°©ì§€ ì‹œ EUC-KR ê³ ë ¤ ê°€ëŠ¥í•˜ë‚˜, ë³´í†µ UTF-8 ê¶Œì¥
        });

        // 2. í…Œì´ë¸” ë Œë”ë§
        function renderTable(data) {
            horseTableBody.innerHTML = '';
            
            data.forEach((row, index) => {
                // ë°ì´í„° ì •ì œ (í‚¤ ì´ë¦„ì— íŠ¹ìˆ˜ë¬¸ìê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í¬í•¨ ì—¬ë¶€ë¡œ ì°¾ê¸°)
                const horseNumKey = Object.keys(row).find(k => k.includes('ë²ˆí˜¸'));
                const horseNameKey = Object.keys(row).find(k => k.includes('ë§ˆëª…'));
                const jockeyKey = Object.keys(row).find(k => k.includes('ê¸°ìˆ˜'));

                const horseNum = row[horseNumKey] || (index + 1);
                const horseName = row[horseNameKey] || '';
                const jockey = row[jockeyKey] || '';

                // ë°ì´í„°ê°€ ë¹„ì–´ìˆëŠ” í–‰ì€ ê±´ë„ˆëœ€ (CSV ëë¶€ë¶„ ë“±)
                if(!horseName && !horseNum) return;

                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition-colors";
                
                tr.innerHTML = `
                    <td class="px-4 py-2 text-center font-bold text-gray-700">${horseNum}</td>
                    <td class="px-4 py-2 text-gray-800 font-medium">${horseName}</td>
                    <td class="px-4 py-2 text-center text-gray-600 text-sm">${jockey}</td>
                    <td class="px-4 py-2 text-center">
                        <input type="number" step="0.1" name="odds" 
                            data-horse-num="${horseNum}" 
                            class="w-24 text-center border border-gray-300 rounded-md py-1 px-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm font-bold text-blue-700"
                            placeholder="0.0">
                    </td>
                `;
                horseTableBody.appendChild(tr);
            });
        }

        // 3. CSV ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬
        downloadBtn.addEventListener('click', () => {
            const moisture = moistureInput.value.trim();
            const inputs = document.querySelectorAll('input[name="odds"]');
            
            // ë°°ë‹¹ë¥  ë§µ ìƒì„± (ë§ˆë²ˆ -> ë°°ë‹¹ë¥ )
            const oddsMap = {};
            inputs.forEach(input => {
                const num = input.getAttribute('data-horse-num');
                const val = input.value;
                if(val) oddsMap[num] = val;
            });

            // ë°ì´í„° ì—…ë°ì´íŠ¸
            const updatedData = parsedData.map(row => {
                const horseNumKey = Object.keys(row).find(k => k.includes('ë²ˆí˜¸'));
                const num = row[horseNumKey];
                
                // ê¸°ì¡´ í–‰ ë³µì‚¬
                let newRow = { ...row };
                
                // 'ë‹¨ìŠ¹ë°°ë‹¹ë¥ ' ì»¬ëŸ¼ ì¶”ê°€ ë˜ëŠ” ê°±ì‹ 
                newRow['ë‹¨ìŠ¹ë°°ë‹¹ë¥ '] = oddsMap[num] || ''; 
                return newRow;
            });

            // 1) ë°ì´í„° ë¶€ë¶„ì„ ë‹¤ì‹œ CSV ë¬¸ìì—´ë¡œ ë³€í™˜
            const csvBodyString = Papa.unparse(updatedData, {
                quotes: false, // í•„ìš”ì‹œ true
                columns: [...originalHeader, 'ë‹¨ìŠ¹ë°°ë‹¹ë¥ '] // í—¤ë” ìˆœì„œ ìœ ì§€í•˜ë©° ëì— ì¶”ê°€
            });

            // 2) ì›ë³¸ ë©”íƒ€ë°ì´í„°(ìƒë‹¨ 3ì¤„ ë“±)ì™€ í•©ì¹˜ê¸°
            // ë©”íƒ€ë°ì´í„° ë¶€ë¶„ì€ ê·¸ëŒ€ë¡œ í…ìŠ¤íŠ¸ë¡œ ë³µì›
            const metaString = originalMetaData.length > 0 ? originalMetaData.join('\n') + '\n' : '';
            
            // ìµœì¢… CSV ë‚´ìš©
            const finalCsvContent = metaString + csvBodyString;

            // íŒŒì¼ëª… ìƒì„±
            let saveFileName = `${originalFileName}_ë‹¨ìŠ¹ë°°ë‹¹í¬í•¨`;
            if (moisture) {
                saveFileName += `_í•¨ìˆ˜ìœ¨${moisture}%`;
            }
            saveFileName += '.csv';

            downloadFile(finalCsvContent, saveFileName);
        });

        function downloadFile(content, fileName) {
            // í•œê¸€ ê¹¨ì§ ë°©ì§€ìš© BOM ì¶”ê°€
            const blob = new Blob(["\uFEFF" + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì§€ì›
        const dropZone = document.querySelector('label[for="csvFileInput"]').parentElement;
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                fileInput.dispatchEvent(new Event('change'));
            }
        });
    });
    </script>
</body>
</html>
