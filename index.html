<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²½ë§ˆ ë°ì´í„° í†µí•© ì…ë ¥ê¸° (OCR ì§€ì›)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- Tesseract.js CDN (OCRìš©) -->
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .hidden { display: none; }
        .custom-table th { background-color: #f3f4f6; position: sticky; top: 0; z-index: 10; }
        .custom-table td { vertical-align: middle; }
        .tab-active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .tab-inactive { background-color: white; color: #4b5563; border-color: #e5e7eb; }
        .tab-inactive:hover { background-color: #f3f4f6; }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

    <div class="max-w-5xl mx-auto p-4 md:p-6">
        <!-- í—¤ë” -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ‡ ê²½ë§ˆ ë°ì´í„° í†µí•© ì…ë ¥ê¸° (OCR)</h1>
            <p class="text-gray-600">CSVë¥¼ ë¨¼ì € ì—…ë¡œë“œí•œ í›„, ê°’ì„ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¡œ ì±„ìš°ì„¸ìš”.</p>
        </div>

        <!-- íƒ­ ë©”ë‰´ -->
        <div class="flex mb-6 border-b-2 border-gray-200">
            <button id="tabOdds" class="flex-1 py-3 px-6 text-lg font-bold border-b-2 rounded-t-lg transition-colors tab-active">
                â‘  ë°°ë‹¹ë¥  ì…ë ¥ (ì¶œì „í‘œ)
            </button>
            <button id="tabWeight" class="flex-1 py-3 px-6 text-lg font-bold border-b-2 rounded-t-lg transition-colors tab-inactive">
                â‘¡ ì²´ì¤‘ ì…ë ¥ (ì²´ì¤‘í˜„í™©)
            </button>
        </div>

        <!-- ========================================== -->
        <!-- [View 1] ë°°ë‹¹ë¥  ì…ë ¥ í˜ì´ì§€ -->
        <!-- ========================================== -->
        <div id="viewOdds" class="block">
            <!-- Step 1: íŒŒì¼ ì—…ë¡œë“œ -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-bold mb-4 text-blue-700 flex items-center">
                    <span class="bg-blue-100 text-blue-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm border border-blue-200">1</span>
                    ì¶œì „í‘œ íŒŒì¼ ì—…ë¡œë“œ (CSV)
                </h2>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors bg-gray-50">
                    <input type="file" id="oddsFileInput" accept=".csv" class="hidden">
                    <label for="oddsFileInput" class="cursor-pointer block">
                        <span class="block text-lg font-medium text-gray-700 mb-1">ì¶œì „í‘œ CSV ì„ íƒ</span>
                        <span class="text-sm text-gray-400">ê¸°ì¤€ ë°ì´í„°(ë§ˆë²ˆ, ë§ˆëª…)ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤</span>
                    </label>
                    <div id="oddsFileName" class="mt-2 text-sm font-semibold text-blue-600 hidden"></div>
                </div>
            </div>

            <!-- Step 2: ë°ì´í„° ì…ë ¥ -->
            <div id="oddsStep2" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                    <h2 class="text-xl font-bold text-blue-700 flex items-center">
                        <span class="bg-blue-100 text-blue-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm border border-blue-200">2</span>
                        ë°°ë‹¹ë¥  ë° í•¨ìˆ˜ìœ¨
                    </h2>
                    
                    <!-- OCR ë° í•¨ìˆ˜ìœ¨ ì»¨íŠ¸ë¡¤ -->
                    <div class="flex flex-wrap items-center gap-3 w-full md:w-auto">
                        <!-- OCR ë²„íŠ¼ -->
                        <div class="relative">
                            <input type="file" id="oddsImageInput" accept="image/*" class="hidden">
                            <button onclick="document.getElementById('oddsImageInput').click()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded shadow flex items-center text-sm font-medium transition-colors">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                ğŸ“· ì´ë¯¸ì§€ë¡œ ë°°ë‹¹ë¥  ì…ë ¥
                            </button>
                        </div>

                        <div class="flex items-center space-x-2 bg-gray-50 px-3 py-1 rounded border">
                            <label for="moistureInput" class="font-bold text-gray-700 text-sm">í•¨ìˆ˜ìœ¨(%):</label>
                            <input type="number" id="moistureInput" placeholder="3" class="border border-gray-300 rounded px-2 py-1 w-16 text-right focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                        </div>
                    </div>
                </div>

                <!-- OCR ì§„í–‰ìƒíƒœ í‘œì‹œ -->
                <div id="oddsOcrStatus" class="hidden mb-4 bg-blue-50 p-3 rounded border border-blue-200 text-sm text-blue-800 flex items-center">
                    <div class="loader mr-3"></div>
                    <span id="oddsOcrMsg">ì´ë¯¸ì§€ ë¶„ì„ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</span>
                </div>

                <div class="overflow-x-auto bg-white border border-gray-200 rounded-lg max-h-[500px] overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200 custom-table text-sm">
                        <thead>
                            <tr>
                                <th class="px-4 py-3 text-center font-bold text-gray-600 w-16">ë²ˆí˜¸</th>
                                <th class="px-4 py-3 text-left font-bold text-gray-600">ë§ˆëª…</th>
                                <th class="px-4 py-3 text-center font-bold text-gray-600">ê¸°ìˆ˜</th>
                                <th class="px-4 py-3 text-center font-bold text-blue-600 w-32">ë‹¨ìŠ¹ ë°°ë‹¹ë¥ </th>
                            </tr>
                        </thead>
                        <tbody id="oddsTableBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <!-- Step 3: ë‹¤ìš´ë¡œë“œ -->
            <div id="oddsStep3" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <button id="oddsDownloadBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    ë°°ë‹¹ë¥  í¬í•¨ CSV ì €ì¥
                </button>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- [View 2] ì²´ì¤‘ ì…ë ¥ í˜ì´ì§€ -->
        <!-- ========================================== -->
        <div id="viewWeight" class="hidden">
            <!-- Step 1: íŒŒì¼ ì—…ë¡œë“œ -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-bold mb-4 text-green-700 flex items-center">
                    <span class="bg-green-100 text-green-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm border border-green-200">1</span>
                    ì²´ì¤‘í˜„í™© íŒŒì¼ ì—…ë¡œë“œ (CSV)
                </h2>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-green-500 transition-colors bg-gray-50">
                    <input type="file" id="weightFileInput" accept=".csv" class="hidden">
                    <label for="weightFileInput" class="cursor-pointer block">
                        <span class="block text-lg font-medium text-gray-700 mb-1">ì²´ì¤‘í˜„í™© CSV ì„ íƒ</span>
                        <span class="text-sm text-gray-400">ê¸°ì¤€ ë°ì´í„°(ë§ˆë²ˆ, ë§ˆëª…)ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤</span>
                    </label>
                    <div id="weightFileName" class="mt-2 text-sm font-semibold text-green-600 hidden"></div>
                </div>
            </div>

            <!-- Step 2: ë°ì´í„° ì…ë ¥ -->
            <div id="weightStep2" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-green-700 flex items-center">
                        <span class="bg-green-100 text-green-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm border border-green-200">2</span>
                        ì²´ì¤‘ ë° ì¦ê° ì…ë ¥
                    </h2>
                    
                    <!-- OCR ë²„íŠ¼ -->
                    <div class="relative">
                        <input type="file" id="weightImageInput" accept="image/*" class="hidden">
                        <button onclick="document.getElementById('weightImageInput').click()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded shadow flex items-center text-sm font-medium transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            ğŸ“· ì´ë¯¸ì§€ë¡œ ì²´ì¤‘ ì…ë ¥
                        </button>
                    </div>
                </div>

                <!-- OCR ì§„í–‰ìƒíƒœ í‘œì‹œ -->
                <div id="weightOcrStatus" class="hidden mb-4 bg-green-50 p-3 rounded border border-green-200 text-sm text-green-800 flex items-center">
                    <div class="loader mr-3 border-t-green-500"></div>
                    <span id="weightOcrMsg">ì´ë¯¸ì§€ ë¶„ì„ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</span>
                </div>

                <div class="overflow-x-auto bg-white border border-gray-200 rounded-lg max-h-[500px] overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200 custom-table text-sm">
                        <thead>
                            <tr>
                                <th class="px-4 py-3 text-center font-bold text-gray-600 w-16">ë²ˆí˜¸</th>
                                <th class="px-4 py-3 text-left font-bold text-gray-600">ë§ˆëª…</th>
                                <th class="px-4 py-3 text-center font-bold text-green-700 w-32">ê¸ˆì¼ì²´ì¤‘</th>
                                <th class="px-4 py-3 text-center font-bold text-red-600 w-32">ì¦ê°(+/-)</th>
                            </tr>
                        </thead>
                        <tbody id="weightTableBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <!-- Step 3: ë‹¤ìš´ë¡œë“œ -->
            <div id="weightStep3" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <button id="weightDownloadBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    ì²´ì¤‘/ì¦ê° í¬í•¨ CSV ì €ì¥
                </button>
            </div>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- íƒ­ ì „í™˜ ë¡œì§ ---
        const tabOdds = document.getElementById('tabOdds');
        const tabWeight = document.getElementById('tabWeight');
        const viewOdds = document.getElementById('viewOdds');
        const viewWeight = document.getElementById('viewWeight');

        function switchTab(mode) {
            if (mode === 'odds') {
                viewOdds.classList.remove('hidden');
                viewWeight.classList.add('hidden');
                tabOdds.className = "flex-1 py-3 px-6 text-lg font-bold border-b-2 rounded-t-lg transition-colors tab-active";
                tabWeight.className = "flex-1 py-3 px-6 text-lg font-bold border-b-2 rounded-t-lg transition-colors tab-inactive";
            } else {
                viewOdds.classList.add('hidden');
                viewWeight.classList.remove('hidden');
                tabOdds.className = "flex-1 py-3 px-6 text-lg font-bold border-b-2 rounded-t-lg transition-colors tab-inactive";
                tabWeight.className = "flex-1 py-3 px-6 text-lg font-bold border-b-2 rounded-t-lg transition-colors tab-active";
            }
        }

        tabOdds.addEventListener('click', () => switchTab('odds'));
        tabWeight.addEventListener('click', () => switchTab('weight'));

        // ==========================================
        // [OCR ê³µí†µ í•¨ìˆ˜]
        // ==========================================
        async function runOCR(imageFile, statusElementId, msgElementId, callback) {
            const statusEl = document.getElementById(statusElementId);
            const msgEl = document.getElementById(msgElementId);
            
            statusEl.classList.remove('hidden');
            msgEl.textContent = "ì´ë¯¸ì§€ ì „ì²˜ë¦¬ ë° ì—”ì§„ ì´ˆê¸°í™” ì¤‘...";

            try {
                // Tesseract ì‹¤í–‰
                const { data: { text } } = await Tesseract.recognize(
                    imageFile,
                    'kor+eng', // í•œê¸€+ì˜ì–´ ë™ì‹œ ì¸ì‹
                    {
                        logger: m => {
                            if(m.status === 'recognizing text') {
                                msgEl.textContent = `ê¸€ì ì¸ì‹ ì¤‘... ${(m.progress * 100).toFixed(0)}%`;
                            }
                        }
                    }
                );

                msgEl.textContent = "ë¶„ì„ ì™„ë£Œ! ë°ì´í„°ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.";
                setTimeout(() => statusEl.classList.add('hidden'), 2000);
                
                console.log("OCR Result:", text); // ë””ë²„ê¹…ìš©
                callback(text);

            } catch (error) {
                console.error(error);
                msgEl.textContent = "ì˜¤ë¥˜ ë°œìƒ: ì´ë¯¸ì§€ë¥¼ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
                alert("ì´ë¯¸ì§€ ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ê°€ ë„ˆë¬´ í¬ê±°ë‚˜ í˜•ì‹ì´ ì§€ì›ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            }
        }


        // ==========================================
        // [ë¡œì§ 1] ë°°ë‹¹ë¥  ì…ë ¥ ê´€ë ¨
        // ==========================================
        let oddsData = { meta: [], header: [], rows: [], fileName: "", headerIndex: 0 };
        const oddsFileInput = document.getElementById('oddsFileInput');
        const oddsTableBody = document.getElementById('oddsTableBody');
        const oddsImageInput = document.getElementById('oddsImageInput');

        oddsFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('oddsFileName').textContent = file.name;
            document.getElementById('oddsFileName').classList.remove('hidden');
            oddsData.fileName = file.name.replace('.csv', '');

            const reader = new FileReader();
            reader.onload = function(evt) {
                const lines = evt.target.result.split(/\r\n|\n/);
                let hIndex = lines.findIndex(l => (l.includes('ë²ˆí˜¸') || l.includes('No')) && l.includes('ë§ˆëª…'));
                if(hIndex === -1) hIndex = 0;

                oddsData.headerIndex = hIndex;
                oddsData.meta = lines.slice(0, hIndex);
                
                const dataPart = lines.slice(hIndex).join('\n');
                Papa.parse(dataPart, {
                    header: true, skipEmptyLines: true,
                    complete: function(res) {
                        oddsData.header = res.meta.fields;
                        oddsData.rows = res.data;
                        renderOddsTable(oddsData.rows);
                        document.getElementById('oddsStep2').classList.remove('hidden');
                        document.getElementById('oddsStep3').classList.remove('hidden');
                    }
                });
            };
            reader.readAsText(file, 'UTF-8');
        });

        // OCR ì²˜ë¦¬ (ë°°ë‹¹ë¥ )
        oddsImageInput.addEventListener('change', (e) => {
            if(!e.target.files[0]) return;
            runOCR(e.target.files[0], 'oddsOcrStatus', 'oddsOcrMsg', (text) => {
                const lines = text.split('\n');
                const inputs = document.querySelectorAll('.odds-input');
                let matchCount = 0;

                inputs.forEach(input => {
                    const horseNum = input.dataset.id;
                    // OCR ê²°ê³¼ì—ì„œ í•´ë‹¹ ë§ˆë²ˆìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ì¤„ ì°¾ê¸° (ì˜ˆ: "1 ë§ˆí•˜ëŒ€ì‹œ 1.5")
                    // ì •ê·œì‹: ì¤„ ì‹œì‘(^), ìˆ«ì(\d+), ê³µë°±, ... ì†Œìˆ˜ì (\d+\.\d+) 
                    const regex = new RegExp(`^\\s*${horseNum}\\s+.*(\\d+\\.\\d+)`); 
                    
                    // ë˜ëŠ” ë‹¨ìˆœíˆ ë§ˆë²ˆì´ ì•ì— ìˆê³  ë’¤ì— ì†Œìˆ˜ì ì´ ìˆëŠ” ë¼ì¸ì„ ì°¾ìŒ
                    for(let line of lines) {
                        // ë…¸ì´ì¦ˆ ì œê±°
                        const cleanLine = line.trim().replace(/[\[\]\(\)]/g, ''); 
                        // ë§ˆë²ˆìœ¼ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸ (ë’¤ì— ê³µë°±ì´ë‚˜ ìˆ«ìê°€ ì•„ë‹Œ ë¬¸ìê°€ ì™€ì•¼ í•¨)
                        if (cleanLine.startsWith(horseNum) && !cleanLine.startsWith(horseNum + 'R')) { // 1R ê°™ì€ê±° ì œì™¸
                             // ì†Œìˆ˜ì  ìˆ«ì ì°¾ê¸° (ë°°ë‹¹ë¥  íŒ¨í„´)
                             const oddsMatch = cleanLine.match(/(\d+\.\d)/);
                             if (oddsMatch) {
                                 input.value = oddsMatch[0];
                                 input.classList.add('bg-yellow-100'); // ë³€ê²½ë¨ í‘œì‹œ
                                 matchCount++;
                                 break;
                             }
                        }
                    }
                });
                if(matchCount > 0) alert(`${matchCount}ê±´ì˜ ë°°ë‹¹ë¥ ì´ ì¸ì‹ë˜ì—ˆìŠµë‹ˆë‹¤. ì •í™•í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                else alert("ì¸ì‹ëœ ë°°ë‹¹ë¥  ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ì— 'ë§ˆë²ˆ'ê³¼ 'ì†Œìˆ˜ì  ë°°ë‹¹ë¥ 'ì´ ì˜ ë³´ì´ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
            });
            // ì…ë ¥ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ)
            oddsImageInput.value = '';
        });

        function renderOddsTable(rows) {
            oddsTableBody.innerHTML = '';
            rows.forEach((row, idx) => {
                const numKey = Object.keys(row).find(k => k.includes('ë²ˆí˜¸'));
                const nameKey = Object.keys(row).find(k => k.includes('ë§ˆëª…'));
                const jockeyKey = Object.keys(row).find(k => k.includes('ê¸°ìˆ˜'));
                const num = row[numKey] || (idx+1);
                const name = row[nameKey] || '';
                const jockey = row[jockeyKey] || '';
                if(!name && !num) return;

                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition-colors";
                tr.innerHTML = `
                    <td class="px-4 py-2 text-center font-bold text-gray-700">${num}</td>
                    <td class="px-4 py-2 text-gray-800 font-medium">${name}</td>
                    <td class="px-4 py-2 text-center text-gray-600 text-sm">${jockey}</td>
                    <td class="px-4 py-2 text-center">
                        <input type="number" step="0.1" data-id="${num}" class="odds-input w-24 text-center border border-gray-300 rounded p-1 font-bold text-blue-700 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0.0">
                    </td>
                `;
                oddsTableBody.appendChild(tr);
            });
        }

        document.getElementById('oddsDownloadBtn').addEventListener('click', () => {
            const moisture = document.getElementById('moistureInput').value.trim();
            const inputs = document.querySelectorAll('.odds-input');
            const map = {};
            inputs.forEach(inp => map[inp.dataset.id] = inp.value);
            const newRows = oddsData.rows.map(row => {
                const numKey = Object.keys(row).find(k => k.includes('ë²ˆí˜¸'));
                return { ...row, 'ë‹¨ìŠ¹ë°°ë‹¹ë¥ ': map[row[numKey]] || '' };
            });
            const csvBody = Papa.unparse(newRows, { quotes: false, columns: [...oddsData.header, 'ë‹¨ìŠ¹ë°°ë‹¹ë¥ '] });
            const metaStr = oddsData.meta.length > 0 ? oddsData.meta.join('\n') + '\n' : '';
            let fname = `${oddsData.fileName}_ë‹¨ìŠ¹ë°°ë‹¹`;
            if(moisture) fname += `_í•¨ìˆ˜ìœ¨${moisture}%`;
            downloadFile(metaStr + csvBody, fname + '.csv');
        });

        // ==========================================
        // [ë¡œì§ 2] ì²´ì¤‘ ì…ë ¥ ê´€ë ¨
        // ==========================================
        let weightData = { meta: [], header: [], rows: [], fileName: "", headerIndex: 0 };
        const weightFileInput = document.getElementById('weightFileInput');
        const weightTableBody = document.getElementById('weightTableBody');
        const weightImageInput = document.getElementById('weightImageInput');

        weightFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('weightFileName').textContent = file.name;
            document.getElementById('weightFileName').classList.remove('hidden');
            weightData.fileName = file.name.replace('.csv', '');
            const reader = new FileReader();
            reader.onload = function(evt) {
                const lines = evt.target.result.split(/\r\n|\n/);
                let hIndex = lines.findIndex(l => (l.includes('ë²ˆí˜¸') || l.includes('No')) && l.includes('ë§ˆëª…'));
                if(hIndex === -1) hIndex = 0;
                weightData.headerIndex = hIndex;
                weightData.meta = lines.slice(0, hIndex);
                const dataPart = lines.slice(hIndex).join('\n');
                Papa.parse(dataPart, {
                    header: true, skipEmptyLines: true,
                    complete: function(res) {
                        weightData.header = res.meta.fields;
                        weightData.rows = res.data;
                        renderWeightTable(weightData.rows);
                        document.getElementById('weightStep2').classList.remove('hidden');
                        document.getElementById('weightStep3').classList.remove('hidden');
                    }
                });
            };
            reader.readAsText(file, 'UTF-8');
        });

        // OCR ì²˜ë¦¬ (ì²´ì¤‘)
        weightImageInput.addEventListener('change', (e) => {
            if(!e.target.files[0]) return;
            runOCR(e.target.files[0], 'weightOcrStatus', 'weightOcrMsg', (text) => {
                const lines = text.split('\n');
                const wInputs = document.querySelectorAll('.weight-val');
                const cInputs = document.querySelectorAll('.weight-chg');
                let matchCount = 0;

                wInputs.forEach(wInput => {
                    const horseNum = wInput.dataset.id;
                    const cInput = document.querySelector(`.weight-chg[data-id="${horseNum}"]`);
                    
                    for(let line of lines) {
                        const cleanLine = line.trim();
                        // ë§ˆë²ˆìœ¼ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸
                        if (cleanLine.startsWith(horseNum)) {
                            // íŒ¨í„´: 3ìë¦¬ ìˆ«ì (300~600) -> ì²´ì¤‘
                            // ê·¸ ë’¤ì— +ìˆ«ì, -ìˆ«ì, í˜¹ì€ ê·¸ëƒ¥ 1ìë¦¬/2ìë¦¬ ìˆ«ì -> ì¦ê°
                            
                            // ì²´ì¤‘ ì°¾ê¸° (300~699 ì‚¬ì´)
                            const weightMatch = cleanLine.match(/(3\d{2}|4\d{2}|5\d{2}|6\d{2})/);
                            if (weightMatch) {
                                wInput.value = weightMatch[0];
                                wInput.classList.add('bg-green-100');
                                
                                // ì¦ê° ì°¾ê¸° (ì²´ì¤‘ ë’¤ì— ìˆëŠ” ìˆ«ì)
                                const remainingStr = cleanLine.substring(cleanLine.indexOf(weightMatch[0]) + 3);
                                // (+/-) ìˆ«ì í˜¹ì€ ê·¸ëƒ¥ ìˆ«ì ì°¾ê¸°. ê´„í˜¸ ì•ˆì— ìˆì„ ìˆ˜ë„ ìˆìŒ.
                                const changeMatch = remainingStr.match(/([+-]?\d+)/);
                                
                                if (changeMatch) {
                                    // ìˆ«ìê°€ ë„ˆë¬´ í¬ë©´(ë˜ ë‹¤ë¥¸ ì²´ì¤‘ ë“±) ë¬´ì‹œ, ë³´í†µ ì¦ê°ì€ -30 ~ +30 ë²”ìœ„
                                    const val = parseInt(changeMatch[0]);
                                    if (val > -50 && val < 50) {
                                        cInput.value = val;
                                        cInput.classList.add('bg-green-100');
                                    }
                                }
                                matchCount++;
                                break;
                            }
                        }
                    }
                });
                if(matchCount > 0) alert(`${matchCount}ê±´ì˜ ì²´ì¤‘ ì •ë³´ê°€ ì¸ì‹ë˜ì—ˆìŠµë‹ˆë‹¤. ì •í™•í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                else alert("ì¸ì‹ëœ ì²´ì¤‘ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë§ˆë²ˆê³¼ 3ìë¦¬ ì²´ì¤‘ ìˆ«ìê°€ ì˜ ë³´ì´ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
            });
            weightImageInput.value = '';
        });


        function renderWeightTable(rows) {
            weightTableBody.innerHTML = '';
            rows.forEach((row, idx) => {
                const numKey = Object.keys(row).find(k => k.includes('ë²ˆí˜¸'));
                const nameKey = Object.keys(row).find(k => k.includes('ë§ˆëª…'));
                const weightKey = Object.keys(row).find(k => k.includes('ì²´ì¤‘') && !k.includes('ì¦ê°'));
                const changeKey = Object.keys(row).find(k => k.includes('ì¦ê°'));

                const num = row[numKey] || (idx+1);
                const name = row[nameKey] || '';
                if(!name && !num) return;

                const currentWeight = row[weightKey] || '';
                const currentChange = row[changeKey] || '';

                const tr = document.createElement('tr');
                tr.className = "hover:bg-green-50 transition-colors";
                tr.innerHTML = `
                    <td class="px-4 py-2 text-center font-bold text-gray-700">${num}</td>
                    <td class="px-4 py-2 text-gray-800 font-medium">${name}</td>
                    <td class="px-4 py-2 text-center">
                        <input type="number" data-id="${num}" value="${currentWeight}" class="weight-val w-28 text-center border border-gray-300 rounded p-1 font-bold text-green-700 focus:ring-2 focus:ring-green-500 outline-none" placeholder="ì²´ì¤‘">
                    </td>
                    <td class="px-4 py-2 text-center">
                        <input type="number" data-id="${num}" value="${currentChange}" class="weight-chg w-24 text-center border border-gray-300 rounded p-1 font-bold text-red-600 focus:ring-2 focus:ring-red-500 outline-none" placeholder="+/-">
                    </td>
                `;
                weightTableBody.appendChild(tr);
            });
        }

        document.getElementById('weightDownloadBtn').addEventListener('click', () => {
            const wInputs = document.querySelectorAll('.weight-val');
            const cInputs = document.querySelectorAll('.weight-chg');
            const wMap = {}, cMap = {};
            wInputs.forEach(inp => wMap[inp.dataset.id] = inp.value);
            cInputs.forEach(inp => cMap[inp.dataset.id] = inp.value);
            const newRows = weightData.rows.map(row => {
                const numKey = Object.keys(row).find(k => k.includes('ë²ˆí˜¸'));
                const num = row[numKey];
                const weightKey = Object.keys(row).find(k => k.includes('ì²´ì¤‘') && !k.includes('ì¦ê°')) || 'ê¸ˆì¼ì²´ì¤‘';
                const changeKey = Object.keys(row).find(k => k.includes('ì¦ê°')) || 'ì¦ê°';
                let newRow = { ...row };
                newRow[weightKey] = wMap[num] || '';
                newRow[changeKey] = cMap[num] || '';
                return newRow;
            });
            let finalHeader = [...weightData.header];
            const weightKey = finalHeader.find(k => k.includes('ì²´ì¤‘') && !k.includes('ì¦ê°')) || 'ê¸ˆì¼ì²´ì¤‘';
            const changeKey = finalHeader.find(k => k.includes('ì¦ê°')) || 'ì¦ê°';
            if(!finalHeader.includes(weightKey)) finalHeader.push(weightKey);
            if(!finalHeader.includes(changeKey)) finalHeader.push(changeKey);
            const csvBody = Papa.unparse(newRows, { quotes: false, columns: finalHeader });
            const metaStr = weightData.meta.length > 0 ? weightData.meta.join('\n') + '\n' : '';
            downloadFile(metaStr + csvBody, `${weightData.fileName}_ì²´ì¤‘ì…ë ¥ì™„ë£Œ.csv`);
        });

        function downloadFile(content, fileName) {
            const blob = new Blob(["\uFEFF" + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        setupDragDrop('oddsFileInput', 'bg-blue-50', 'border-blue-500');
        setupDragDrop('weightFileInput', 'bg-green-50', 'border-green-500');

        function setupDragDrop(inputId, bgClass, borderClass) {
            const input = document.getElementById(inputId);
            const dropZone = input.parentElement;
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add(borderClass, bgClass); });
            dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove(borderClass, bgClass); });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault(); dropZone.classList.remove(borderClass, bgClass);
                if (e.dataTransfer.files.length > 0) { input.files = e.dataTransfer.files; input.dispatchEvent(new Event('change')); }
            });
        }
    });
    </script>
</body>
</html>
