<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²½ë§ˆ ë°ì´í„° í†µí•© ì…ë ¥ê¸° (Smart OCR)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- Tesseract.js CDN -->
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .hidden { display: none; }
        .custom-table th { background-color: #f3f4f6; position: sticky; top: 0; z-index: 10; }
        .custom-table td { vertical-align: middle; }
        .tab-active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .tab-inactive { background-color: white; color: #4b5563; border-color: #e5e7eb; }
        .tab-inactive:hover { background-color: #f3f4f6; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

    <div class="max-w-5xl mx-auto p-4 md:p-6">
        <!-- í—¤ë” -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ‡ ê²½ë§ˆ ë°ì´í„° í†µí•© ì…ë ¥ê¸° (Smart OCR)</h1>
            <p class="text-gray-600">ê³ ëŒ€ë¹„ í•„í„°ë¥¼ ì ìš©í•˜ì—¬ ì´ë¯¸ì§€ ì¸ì‹ë¥ ì„ ëŒ€í­ ë†’ì˜€ìŠµë‹ˆë‹¤.</p>
        </div>

        <!-- íƒ­ ë©”ë‰´ -->
        <div class="flex mb-6 border-b-2 border-gray-200">
            <button id="tabOdds" class="flex-1 py-3 px-6 text-lg font-bold border-b-2 rounded-t-lg transition-colors tab-active">
                â‘  ë°°ë‹¹ë¥  ì…ë ¥ (ì¶œì „í‘œ)
            </button>
            <button id="tabWeight" class="flex-1 py-3 px-6 text-lg font-bold border-b-2 rounded-t-lg transition-colors tab-inactive">
                â‘¡ ì²´ì¤‘ ì…ë ¥ (ì²´ì¤‘í˜„í™©)
            </button>
        </div>

        <!-- ========================================== -->
        <!-- [View 1] ë°°ë‹¹ë¥  ì…ë ¥ í˜ì´ì§€ -->
        <!-- ========================================== -->
        <div id="viewOdds" class="block">
            <!-- Step 1: íŒŒì¼ ì—…ë¡œë“œ -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-bold mb-4 text-blue-700 flex items-center">
                    <span class="bg-blue-100 text-blue-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm border border-blue-200">1</span>
                    ì¶œì „í‘œ íŒŒì¼ ì—…ë¡œë“œ (CSV)
                </h2>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors bg-gray-50">
                    <input type="file" id="oddsFileInput" accept=".csv" class="hidden">
                    <label for="oddsFileInput" class="cursor-pointer block">
                        <span class="block text-lg font-medium text-gray-700 mb-1">ì¶œì „í‘œ CSV ì„ íƒ</span>
                        <span class="text-sm text-gray-400">ê¸°ì¤€ ë°ì´í„°(ë§ˆë²ˆ, ë§ˆëª…)ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤</span>
                    </label>
                    <div id="oddsFileName" class="mt-2 text-sm font-semibold text-blue-600 hidden"></div>
                </div>
            </div>

            <!-- Step 2: ë°ì´í„° ì…ë ¥ -->
            <div id="oddsStep2" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                    <h2 class="text-xl font-bold text-blue-700 flex items-center">
                        <span class="bg-blue-100 text-blue-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm border border-blue-200">2</span>
                        ë°°ë‹¹ë¥  ì…ë ¥
                    </h2>
                    
                    <!-- OCR ë° í•¨ìˆ˜ìœ¨ ì»¨íŠ¸ë¡¤ -->
                    <div class="flex flex-wrap items-center gap-3 w-full md:w-auto bg-gray-50 p-2 rounded-lg border border-gray-200">
                        <div class="flex items-center mr-2">
                            <input type="checkbox" id="oddsUsePreprocess" checked class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                            <label for="oddsUsePreprocess" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer">ê³ ëŒ€ë¹„ í•„í„°(ê¶Œì¥)</label>
                        </div>

                        <!-- OCR ë²„íŠ¼ -->
                        <div class="relative">
                            <input type="file" id="oddsImageInput" accept="image/*" class="hidden">
                            <button onclick="document.getElementById('oddsImageInput').click()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded shadow flex items-center text-sm font-bold transition-colors">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                ğŸ“· ë°°ë‹¹ë¥  ì¸ì‹
                            </button>
                        </div>

                        <div class="flex items-center space-x-2 border-l pl-3 ml-1">
                            <label for="moistureInput" class="font-bold text-gray-700 text-sm">í•¨ìˆ˜ìœ¨(%):</label>
                            <input type="number" id="moistureInput" placeholder="3" class="border border-gray-300 rounded px-2 py-1 w-16 text-right focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                        </div>
                    </div>
                </div>

                <!-- OCR ì§„í–‰ìƒíƒœ í‘œì‹œ -->
                <div id="oddsOcrStatus" class="hidden mb-4 bg-blue-50 p-4 rounded border border-blue-200 text-sm text-blue-800">
                    <div class="flex items-center mb-2">
                        <div class="loader mr-3"></div>
                        <span id="oddsOcrMsg" class="font-bold">ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...</span>
                    </div>
                    <p class="text-xs text-blue-600 ml-9">íŒ: ê·¸ë¦¼ìê°€ ì—†ë„ë¡ ë°ì€ ê³³ì—ì„œ ì´¬ì˜í•˜ê³ , ìˆ«ìê°€ ì˜ ë³´ì´ê²Œ ì°ì–´ì£¼ì„¸ìš”.</p>
                </div>

                <div class="overflow-x-auto bg-white border border-gray-200 rounded-lg max-h-[500px] overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200 custom-table text-sm">
                        <thead>
                            <tr>
                                <th class="px-4 py-3 text-center font-bold text-gray-600 w-16">ë²ˆí˜¸</th>
                                <th class="px-4 py-3 text-left font-bold text-gray-600">ë§ˆëª…</th>
                                <th class="px-4 py-3 text-center font-bold text-gray-600">ê¸°ìˆ˜</th>
                                <th class="px-4 py-3 text-center font-bold text-blue-600 w-32">ë‹¨ìŠ¹ ë°°ë‹¹ë¥ </th>
                            </tr>
                        </thead>
                        <tbody id="oddsTableBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <!-- Step 3: ë‹¤ìš´ë¡œë“œ -->
            <div id="oddsStep3" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <button id="oddsDownloadBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    ë°°ë‹¹ë¥  í¬í•¨ CSV ì €ì¥
                </button>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- [View 2] ì²´ì¤‘ ì…ë ¥ í˜ì´ì§€ -->
        <!-- ========================================== -->
        <div id="viewWeight" class="hidden">
            <!-- Step 1: íŒŒì¼ ì—…ë¡œë“œ -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-bold mb-4 text-green-700 flex items-center">
                    <span class="bg-green-100 text-green-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm border border-green-200">1</span>
                    ì²´ì¤‘í˜„í™© íŒŒì¼ ì—…ë¡œë“œ (CSV)
                </h2>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-green-500 transition-colors bg-gray-50">
                    <input type="file" id="weightFileInput" accept=".csv" class="hidden">
                    <label for="weightFileInput" class="cursor-pointer block">
                        <span class="block text-lg font-medium text-gray-700 mb-1">ì²´ì¤‘í˜„í™© CSV ì„ íƒ</span>
                        <span class="text-sm text-gray-400">ê¸°ì¤€ ë°ì´í„°(ë§ˆë²ˆ, ë§ˆëª…)ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤</span>
                    </label>
                    <div id="weightFileName" class="mt-2 text-sm font-semibold text-green-600 hidden"></div>
                </div>
            </div>

            <!-- Step 2: ë°ì´í„° ì…ë ¥ -->
            <div id="weightStep2" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-green-700 flex items-center">
                        <span class="bg-green-100 text-green-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm border border-green-200">2</span>
                        ì²´ì¤‘ ë° ì¦ê° ì…ë ¥
                    </h2>
                    
                    <div class="flex items-center gap-3 bg-gray-50 p-2 rounded-lg border border-gray-200">
                        <div class="flex items-center mr-2">
                            <input type="checkbox" id="weightUsePreprocess" checked class="w-4 h-4 text-green-600 rounded border-gray-300 focus:ring-green-500">
                            <label for="weightUsePreprocess" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer">ê³ ëŒ€ë¹„ í•„í„°</label>
                        </div>
                        <!-- OCR ë²„íŠ¼ -->
                        <div class="relative">
                            <input type="file" id="weightImageInput" accept="image/*" class="hidden">
                            <button onclick="document.getElementById('weightImageInput').click()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow flex items-center text-sm font-bold transition-colors">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                ğŸ“· ì²´ì¤‘ ì¸ì‹
                            </button>
                        </div>
                    </div>
                </div>

                <!-- OCR ì§„í–‰ìƒíƒœ í‘œì‹œ -->
                <div id="weightOcrStatus" class="hidden mb-4 bg-green-50 p-4 rounded border border-green-200 text-sm text-green-800">
                    <div class="flex items-center mb-2">
                        <div class="loader mr-3 border-t-green-500"></div>
                        <span id="weightOcrMsg" class="font-bold">ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...</span>
                    </div>
                    <p class="text-xs text-green-600 ml-9">íŒ: í”Œë˜ì‹œë¥¼ ë„ê³  ì •ë©´ì—ì„œ ì°ì–´ì£¼ì„¸ìš”. ìˆ«ìê°€ ì„ ëª…í• ìˆ˜ë¡ ì¸ì‹ë¥ ì´ ë†’ìŠµë‹ˆë‹¤.</p>
                </div>

                <div class="overflow-x-auto bg-white border border-gray-200 rounded-lg max-h-[500px] overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200 custom-table text-sm">
                        <thead>
                            <tr>
                                <th class="px-4 py-3 text-center font-bold text-gray-600 w-16">ë²ˆí˜¸</th>
                                <th class="px-4 py-3 text-left font-bold text-gray-600">ë§ˆëª…</th>
                                <th class="px-4 py-3 text-center font-bold text-green-700 w-32">ê¸ˆì¼ì²´ì¤‘</th>
                                <th class="px-4 py-3 text-center font-bold text-red-600 w-32">ì¦ê°(+/-)</th>
                            </tr>
                        </thead>
                        <tbody id="weightTableBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <!-- Step 3: ë‹¤ìš´ë¡œë“œ -->
            <div id="weightStep3" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <button id="weightDownloadBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    ì²´ì¤‘/ì¦ê° í¬í•¨ CSV ì €ì¥
                </button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- íƒ­ ì „í™˜ ë¡œì§ ---
        const tabOdds = document.getElementById('tabOdds');
        const tabWeight = document.getElementById('tabWeight');
        const viewOdds = document.getElementById('viewOdds');
        const viewWeight = document.getElementById('viewWeight');

        function switchTab(mode) {
            if (mode === 'odds') {
                viewOdds.classList.remove('hidden');
                viewWeight.classList.add('hidden');
                tabOdds.className = "flex-1 py-3 px-6 text-lg font-bold border-b-2 rounded-t-lg transition-colors tab-active";
                tabWeight.className = "flex-1 py-3 px-6 text-lg font-bold border-b-2 rounded-t-lg transition-colors tab-inactive";
            } else {
                viewOdds.classList.add('hidden');
                viewWeight.classList.remove('hidden');
                tabOdds.className = "flex-1 py-3 px-6 text-lg font-bold border-b-2 rounded-t-lg transition-colors tab-inactive";
                tabWeight.className = "flex-1 py-3 px-6 text-lg font-bold border-b-2 rounded-t-lg transition-colors tab-active";
            }
        }

        tabOdds.addEventListener('click', () => switchTab('odds'));
        tabWeight.addEventListener('click', () => switchTab('weight'));

        // ==========================================
        // [Advanced Image Preprocessing]
        // ì´ë¯¸ì§€ë¥¼ í‘ë°±/ê³ ëŒ€ë¹„ë¡œ ë³€í™˜í•˜ê³  í™•ëŒ€í•˜ì—¬ ì¸ì‹ë¥ ì„ ë†’ì„
        // ==========================================
        function preprocessImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // 1. ì´ë¯¸ì§€ í™•ëŒ€ (Scale Up): ì‘ì€ í…ìŠ¤íŠ¸ ì¸ì‹ë¥  í–¥ìƒ (2ë°°)
                    const scaleFactor = 2; 
                    canvas.width = img.width * scaleFactor;
                    canvas.height = img.height * scaleFactor;
                    
                    // ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦¼
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // 2. í”½ì…€ ë°ì´í„° ì¡°ì‘ (Grayscale + Thresholding)
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        // ë°ê¸° ê³„ì‚° (ê°€ì¤‘ì¹˜ í‰ê· )
                        const brightness = 0.34 * data[i] + 0.5 * data[i + 1] + 0.16 * data[i + 2];
                        
                        // ì„ê³„ê°’ ì²˜ë¦¬ (Thresholding): ë°ì€ê±´ í°ìƒ‰, ì–´ë‘ìš´ê±´ ê²€ì€ìƒ‰ìœ¼ë¡œ ë°€ì–´ë²„ë¦¼ (Binarization)
                        // 128ë³´ë‹¤ ì•½ê°„ ë†’ê²Œ ì¡ì•„ ê¸€ì”¨ë¥¼ ë” ì§„í•˜ê²Œ ë‚¨ê¹€
                        const threshold = brightness < 140 ? 0 : 255;
                        
                        data[i] = threshold;     // R
                        data[i + 1] = threshold; // G
                        data[i + 2] = threshold; // B
                        // AlphaëŠ” ê·¸ëŒ€ë¡œ
                    }
                    ctx.putImageData(imageData, 0, 0);
                    
                    // ìº”ë²„ìŠ¤ë¥¼ Blobìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ë°˜í™˜
                    canvas.toBlob((blob) => {
                        callback(blob);
                    }, 'image/png');
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ==========================================
        // [OCR Core Function]
        // ==========================================
        async function runOCR(imageFile, statusElementId, msgElementId, usePreprocess, whitelistChars, callback) {
            const statusEl = document.getElementById(statusElementId);
            const msgEl = document.getElementById(msgElementId);
            
            statusEl.classList.remove('hidden');
            msgEl.textContent = "ì´ë¯¸ì§€ ì „ì²˜ë¦¬ ì¤‘...";

            // ë‚´ë¶€ ë¡œì§: ì‹¤ì œ OCR ì‹¤í–‰
            const executeTesseract = async (blobToProcess) => {
                msgEl.textContent = "OCR ì—”ì§„ ì´ˆê¸°í™” ë° ë¶„ì„ ì¤‘...";
                try {
                    const { data: { text } } = await Tesseract.recognize(
                        blobToProcess,
                        'eng', // ìˆ«ì ìœ„ì£¼ì´ë¯€ë¡œ 'eng' ëª¨ë¸ì´ 'kor'ë³´ë‹¤ ìˆ«ì ì¸ì‹ì— ìœ ë¦¬í•¨
                        {
                            // Whitelist: í—ˆìš©ëœ ë¬¸ìë§Œ ì¸ì‹í•˜ë„ë¡ ê°•ì œ (ë…¸ì´ì¦ˆ ì œê±° í•µì‹¬)
                            tessedit_char_whitelist: whitelistChars,
                            logger: m => {
                                if(m.status === 'recognizing text') {
                                    msgEl.textContent = `ê¸€ì ì¸ì‹ ì¤‘... ${(m.progress * 100).toFixed(0)}%`;
                                }
                            }
                        }
                    );
                    msgEl.textContent = "ì™„ë£Œ! ë°ì´í„°ë¥¼ ì ìš©í•©ë‹ˆë‹¤.";
                    setTimeout(() => statusEl.classList.add('hidden'), 2000);
                    console.log("OCR Raw Text:", text);
                    callback(text);
                } catch (error) {
                    console.error(error);
                    msgEl.textContent = "ì˜¤ë¥˜ ë°œìƒ: ì¸ì‹ì„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                    alert("OCR ì˜¤ë¥˜ì…ë‹ˆë‹¤.");
                }
            };

            if (usePreprocess) {
                preprocessImage(imageFile, (processedBlob) => {
                    executeTesseract(processedBlob);
                });
            } else {
                executeTesseract(imageFile);
            }
        }


        // ==========================================
        // [ë¡œì§ 1] ë°°ë‹¹ë¥  ì…ë ¥
        // ==========================================
        let oddsData = { meta: [], header: [], rows: [], fileName: "", headerIndex: 0 };
        const oddsFileInput = document.getElementById('oddsFileInput');
        const oddsTableBody = document.getElementById('oddsTableBody');
        const oddsImageInput = document.getElementById('oddsImageInput');

        oddsFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('oddsFileName').textContent = file.name;
            document.getElementById('oddsFileName').classList.remove('hidden');
            oddsData.fileName = file.name.replace('.csv', '');

            const reader = new FileReader();
            reader.onload = function(evt) {
                const lines = evt.target.result.split(/\r\n|\n/);
                let hIndex = lines.findIndex(l => (l.includes('ë²ˆí˜¸') || l.includes('No')) && l.includes('ë§ˆëª…'));
                if(hIndex === -1) hIndex = 0;
                oddsData.headerIndex = hIndex;
                oddsData.meta = lines.slice(0, hIndex);
                const dataPart = lines.slice(hIndex).join('\n');
                Papa.parse(dataPart, {
                    header: true, skipEmptyLines: true,
                    complete: function(res) {
                        oddsData.header = res.meta.fields;
                        oddsData.rows = res.data;
                        renderOddsTable(oddsData.rows);
                        document.getElementById('oddsStep2').classList.remove('hidden');
                        document.getElementById('oddsStep3').classList.remove('hidden');
                    }
                });
            };
            reader.readAsText(file, 'UTF-8');
        });

        // ë°°ë‹¹ë¥  OCR íŠ¸ë¦¬ê±°
        oddsImageInput.addEventListener('change', (e) => {
            if(!e.target.files[0]) return;
            
            const usePre = document.getElementById('oddsUsePreprocess').checked;
            // ë°°ë‹¹ë¥ ì€ ìˆ«ì(0-9)ì™€ ì†Œìˆ˜ì (.)ë§Œ í•„ìš” (ì¤„ë°”ê¿ˆ í¬í•¨)
            // ë§ˆë²ˆë„ ìˆ«ìì´ë¯€ë¡œ ê°™ì´ ì¸ì‹ë¨
            const whitelist = '0123456789.\n '; 

            runOCR(e.target.files[0], 'oddsOcrStatus', 'oddsOcrMsg', usePre, whitelist, (text) => {
                const lines = text.split('\n');
                const inputs = document.querySelectorAll('.odds-input');
                let matchCount = 0;

                inputs.forEach(input => {
                    const horseNum = input.dataset.id;
                    
                    // ì „ì²˜ë¦¬ë¥¼ í•˜ë©´ 'ë§ˆëª…' í…ìŠ¤íŠ¸ëŠ” ì‚¬ë¼ì§€ê³  "1 1.5" ì²˜ëŸ¼ ìˆ«ìë§Œ ë‚¨ì„ ê°€ëŠ¥ì„±ì´ ë†’ìŒ
                    // ë”°ë¼ì„œ ìˆ«ìë§Œ ìˆëŠ” ë¼ì¸ì—ì„œ [ë§ˆë²ˆ] [ë°°ë‹¹ë¥ ] íŒ¨í„´ì„ ì°¾ìŒ
                    
                    for(let line of lines) {
                        let cleanLine = line.trim();
                        // 1. ë§ˆë²ˆìœ¼ë¡œ ì‹œì‘í•˜ëŠ”ì§€?
                        // "1 3.5" ë˜ëŠ” "1 3.5" (ê³µë°± ë¶ˆí™•ì‹¤)
                        // ì •ê·œì‹: ì‹œì‘(^) + ë§ˆë²ˆ + ê³µë°±í•˜ë‚˜ì´ìƒ + ì†Œìˆ˜ì ìˆ«ì
                        const regex = new RegExp(`^${horseNum}\\s+(\\d+\\.\\d+)`);
                        const match = cleanLine.match(regex);
                        
                        if (match) {
                            input.value = match[1]; // ì •ê·œì‹ì˜ 1ë²ˆ ê·¸ë£¹(ë°°ë‹¹ë¥ )
                            input.classList.add('bg-yellow-100');
                            matchCount++;
                            break;
                        }
                    }
                });
                
                if(matchCount === 0) alert("ì¸ì‹ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì „ì²˜ë¦¬ ì˜µì…˜ì„ ë„ê±°ë‚˜ ì¼œì„œ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.");
                else alert(`${matchCount}ê±´ì˜ ë°°ë‹¹ë¥ ì´ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            });
            oddsImageInput.value = '';
        });

        function renderOddsTable(rows) {
            oddsTableBody.innerHTML = '';
            rows.forEach((row, idx) => {
                const numKey = Object.keys(row).find(k => k.includes('ë²ˆí˜¸'));
                const nameKey = Object.keys(row).find(k => k.includes('ë§ˆëª…'));
                const jockeyKey = Object.keys(row).find(k => k.includes('ê¸°ìˆ˜'));
                const num = row[numKey] || (idx+1);
                const name = row[nameKey] || '';
                const jockey = row[jockeyKey] || '';
                if(!name && !num) return;

                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition-colors";
                tr.innerHTML = `
                    <td class="px-4 py-2 text-center font-bold text-gray-700">${num}</td>
                    <td class="px-4 py-2 text-gray-800 font-medium">${name}</td>
                    <td class="px-4 py-2 text-center text-gray-600 text-sm">${jockey}</td>
                    <td class="px-4 py-2 text-center">
                        <input type="number" step="0.1" data-id="${num}" class="odds-input w-24 text-center border border-gray-300 rounded p-1 font-bold text-blue-700 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0.0">
                    </td>
                `;
                oddsTableBody.appendChild(tr);
            });
        }

        document.getElementById('oddsDownloadBtn').addEventListener('click', () => {
            const moisture = document.getElementById('moistureInput').value.trim();
            const inputs = document.querySelectorAll('.odds-input');
            const map = {};
            inputs.forEach(inp => map[inp.dataset.id] = inp.value);
            const newRows = oddsData.rows.map(row => {
                const numKey = Object.keys(row).find(k => k.includes('ë²ˆí˜¸'));
                return { ...row, 'ë‹¨ìŠ¹ë°°ë‹¹ë¥ ': map[row[numKey]] || '' };
            });
            const csvBody = Papa.unparse(newRows, { quotes: false, columns: [...oddsData.header, 'ë‹¨ìŠ¹ë°°ë‹¹ë¥ '] });
            const metaStr = oddsData.meta.length > 0 ? oddsData.meta.join('\n') + '\n' : '';
            let fname = `${oddsData.fileName}_ë‹¨ìŠ¹ë°°ë‹¹`;
            if(moisture) fname += `_í•¨ìˆ˜ìœ¨${moisture}%`;
            downloadFile(metaStr + csvBody, fname + '.csv');
        });

        // ==========================================
        // [ë¡œì§ 2] ì²´ì¤‘ ì…ë ¥
        // ==========================================
        let weightData = { meta: [], header: [], rows: [], fileName: "", headerIndex: 0 };
        const weightFileInput = document.getElementById('weightFileInput');
        const weightTableBody = document.getElementById('weightTableBody');
        const weightImageInput = document.getElementById('weightImageInput');

        weightFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('weightFileName').textContent = file.name;
            document.getElementById('weightFileName').classList.remove('hidden');
            weightData.fileName = file.name.replace('.csv', '');
            const reader = new FileReader();
            reader.onload = function(evt) {
                const lines = evt.target.result.split(/\r\n|\n/);
                let hIndex = lines.findIndex(l => (l.includes('ë²ˆí˜¸') || l.includes('No')) && l.includes('ë§ˆëª…'));
                if(hIndex === -1) hIndex = 0;
                weightData.headerIndex = hIndex;
                weightData.meta = lines.slice(0, hIndex);
                const dataPart = lines.slice(hIndex).join('\n');
                Papa.parse(dataPart, {
                    header: true, skipEmptyLines: true,
                    complete: function(res) {
                        weightData.header = res.meta.fields;
                        weightData.rows = res.data;
                        renderWeightTable(weightData.rows);
                        document.getElementById('weightStep2').classList.remove('hidden');
                        document.getElementById('weightStep3').classList.remove('hidden');
                    }
                });
            };
            reader.readAsText(file, 'UTF-8');
        });

        // ì²´ì¤‘ OCR íŠ¸ë¦¬ê±°
        weightImageInput.addEventListener('change', (e) => {
            if(!e.target.files[0]) return;
            const usePre = document.getElementById('weightUsePreprocess').checked;
            // ì²´ì¤‘ì€ ìˆ«ì, +, - ê°€ í•„ìš”
            const whitelist = '0123456789+-\n '; 

            runOCR(e.target.files[0], 'weightOcrStatus', 'weightOcrMsg', usePre, whitelist, (text) => {
                const lines = text.split('\n');
                const wInputs = document.querySelectorAll('.weight-val');
                let matchCount = 0;

                wInputs.forEach(wInput => {
                    const horseNum = wInput.dataset.id;
                    const cInput = document.querySelector(`.weight-chg[data-id="${horseNum}"]`);
                    
                    for(let line of lines) {
                        let cleanLine = line.trim();
                        if (cleanLine.startsWith(horseNum)) {
                            // íŒ¨í„´: [ë§ˆë²ˆ] [ì²´ì¤‘3ìë¦¬] [ì¦ê°]
                            // ì˜ˆ: 1 480 +5  ë˜ëŠ” 1 480 5
                            
                            // 300~600ëŒ€ ì²´ì¤‘ ì°¾ê¸°
                            const weightMatch = cleanLine.match(/\b([3-6]\d{2})\b/);
                            if (weightMatch) {
                                wInput.value = weightMatch[1];
                                wInput.classList.add('bg-green-100');
                                
                                // ì²´ì¤‘ ë’¤ì— ìˆëŠ” ë‚˜ë¨¸ì§€ ë¬¸ìì—´ì—ì„œ ì¦ê° ì°¾ê¸°
                                const afterWeight = cleanLine.substring(cleanLine.indexOf(weightMatch[1]) + 3);
                                // +ìˆ«ì, -ìˆ«ì, í˜¹ì€ ê·¸ëƒ¥ ìˆ«ì ì°¾ê¸° (ìµœëŒ€ 2ìë¦¬)
                                const changeMatch = afterWeight.match(/([+-]?\d{1,2})\b/);
                                
                                if (changeMatch) {
                                    cInput.value = changeMatch[1];
                                    cInput.classList.add('bg-green-100');
                                }
                                matchCount++;
                                break;
                            }
                        }
                    }
                });
                
                if(matchCount === 0) alert("ì¸ì‹ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì „ì²˜ë¦¬ ì˜µì…˜ì„ ì¡°ì •í•´ë³´ì„¸ìš”.");
                else alert(`${matchCount}ê±´ì˜ ì²´ì¤‘ ì •ë³´ê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            });
            weightImageInput.value = '';
        });

        function renderWeightTable(rows) {
            weightTableBody.innerHTML = '';
            rows.forEach((row, idx) => {
                const numKey = Object.keys(row).find(k => k.includes('ë²ˆí˜¸'));
                const nameKey = Object.keys(row).find(k => k.includes('ë§ˆëª…'));
                const weightKey = Object.keys(row).find(k => k.includes('ì²´ì¤‘') && !k.includes('ì¦ê°'));
                const changeKey = Object.keys(row).find(k => k.includes('ì¦ê°'));

                const num = row[numKey] || (idx+1);
                const name = row[nameKey] || '';
                if(!name && !num) return;

                const currentWeight = row[weightKey] || '';
                const currentChange = row[changeKey] || '';

                const tr = document.createElement('tr');
                tr.className = "hover:bg-green-50 transition-colors";
                tr.innerHTML = `
                    <td class="px-4 py-2 text-center font-bold text-gray-700">${num}</td>
                    <td class="px-4 py-2 text-gray-800 font-medium">${name}</td>
                    <td class="px-4 py-2 text-center">
                        <input type="number" data-id="${num}" value="${currentWeight}" class="weight-val w-28 text-center border border-gray-300 rounded p-1 font-bold text-green-700 focus:ring-2 focus:ring-green-500 outline-none" placeholder="ì²´ì¤‘">
                    </td>
                    <td class="px-4 py-2 text-center">
                        <input type="number" data-id="${num}" value="${currentChange}" class="weight-chg w-24 text-center border border-gray-300 rounded p-1 font-bold text-red-600 focus:ring-2 focus:ring-red-500 outline-none" placeholder="+/-">
                    </td>
                `;
                weightTableBody.appendChild(tr);
            });
        }

        document.getElementById('weightDownloadBtn').addEventListener('click', () => {
            const wInputs = document.querySelectorAll('.weight-val');
            const cInputs = document.querySelectorAll('.weight-chg');
            const wMap = {}, cMap = {};
            wInputs.forEach(inp => wMap[inp.dataset.id] = inp.value);
            cInputs.forEach(inp => cMap[inp.dataset.id] = inp.value);
            const newRows = weightData.rows.map(row => {
                const numKey = Object.keys(row).find(k => k.includes('ë²ˆí˜¸'));
                const num = row[numKey];
                const weightKey = Object.keys(row).find(k => k.includes('ì²´ì¤‘') && !k.includes('ì¦ê°')) || 'ê¸ˆì¼ì²´ì¤‘';
                const changeKey = Object.keys(row).find(k => k.includes('ì¦ê°')) || 'ì¦ê°';
                let newRow = { ...row };
                newRow[weightKey] = wMap[num] || '';
                newRow[changeKey] = cMap[num] || '';
                return newRow;
            });
            let finalHeader = [...weightData.header];
            const weightKey = finalHeader.find(k => k.includes('ì²´ì¤‘') && !k.includes('ì¦ê°')) || 'ê¸ˆì¼ì²´ì¤‘';
            const changeKey = finalHeader.find(k => k.includes('ì¦ê°')) || 'ì¦ê°';
            if(!finalHeader.includes(weightKey)) finalHeader.push(weightKey);
            if(!finalHeader.includes(changeKey)) finalHeader.push(changeKey);
            const csvBody = Papa.unparse(newRows, { quotes: false, columns: finalHeader });
            const metaStr = weightData.meta.length > 0 ? weightData.meta.join('\n') + '\n' : '';
            downloadFile(metaStr + csvBody, `${weightData.fileName}_ì²´ì¤‘ì…ë ¥ì™„ë£Œ.csv`);
        });

        function downloadFile(content, fileName) {
            const blob = new Blob(["\uFEFF" + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        setupDragDrop('oddsFileInput', 'bg-blue-50', 'border-blue-500');
        setupDragDrop('weightFileInput', 'bg-green-50', 'border-green-500');

        function setupDragDrop(inputId, bgClass, borderClass) {
            const input = document.getElementById(inputId);
            const dropZone = input.parentElement;
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add(borderClass, bgClass); });
            dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove(borderClass, bgClass); });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault(); dropZone.classList.remove(borderClass, bgClass);
                if (e.dataTransfer.files.length > 0) { input.files = e.dataTransfer.files; input.dispatchEvent(new Event('change')); }
            });
        }
    });
    </script>
</body>
</html>
